### THIS FILE IS AUTOMATICALLY GENERATED BY COB
### DO NOT EDIT THIS FILE DIRECTLY

{% for subsystem in project.subsystems %}
{% for line in subsystem.get_docker_preamble_steps() %}
{{line}}
{% endfor %}
{% endfor %}

FROM {{deployment_base_image}}

ENV PYTHON_VERSION={{python_version}} PYTHON_EXECUTABLE=python{{python_version}} LC_ALL=C.UTF-8 LANG=C.UTF-8 COB_IN_DOCKER=1

RUN apt-get update
RUN apt-get -y install build-essential rsync software-properties-common libpq-dev nginx curl redis-server gcc sudo libsasl2-dev libldap2-dev wget git


# nginx
RUN add-apt-repository ppa:chris-lea/nginx-devel
RUN apt-get update
RUN apt-get -y install nginx

RUN add-apt-repository ppa:deadsnakes/ppa
RUN apt-get update
RUN apt-get install -y $PYTHON_EXECUTABLE $PYTHON_EXECUTABLE-dev $PYTHON_EXECUTABLE-gdbm

RUN wget https://bootstrap.pypa.io/get-pip.py -O /tmp/get-pip.py
RUN $PYTHON_EXECUTABLE /tmp/get-pip.py
RUN $PYTHON_EXECUTABLE -m pip install -U virtualenv pip setuptools

ADD . /app

{% for subsystem in project.subsystems %}
{% for line in subsystem.get_docker_install_steps() %}
{{line}}
{% endfor %}
{% endfor %}

WORKDIR /app

{% if is_develop %}
ENV COB_DEVELOP=1 COB_DEVELOP_SDIST=/app/{{cob_sdist_filename}}
RUN $PYTHON_EXECUTABLE -m pip install $COB_DEVELOP_SDIST
{% else %}
RUN $PYTHON_EXECUTABLE -m pip install cob
{% endif %}

RUN cob -vvv bootstrap

## nginx configuration
RUN rm -rf /etc/nginx/conf.d/* /etc/nginx/sites-enabled/*

{{user_steps}}

EXPOSE 80 443
