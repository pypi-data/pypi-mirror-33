
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>15.2.5. crate_anon.common.sql &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="15.2.6. crate_anon.common.stringfunc" href="stringfunc.html" />
    <link rel="prev" title="15.2.4. crate_anon.common.parallel" href="parallel.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="stringfunc.html" title="15.2.6. crate_anon.common.stringfunc"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="parallel.html" title="15.2.4. crate_anon.common.parallel"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >15. Automatic documentation of source code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="_index.html" accesskey="U">15.2. crate_anon.common</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-crate_anon.common.sql">
<span id="crate-anon-common-sql"></span><h1>15.2.5. crate_anon.common.sql<a class="headerlink" href="#module-crate_anon.common.sql" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<blockquote>
<div><p>Copyright (C) 2015-2018 Rudolf Cardinal (<a class="reference external" href="mailto:rudolf&#37;&#52;&#48;pobox&#46;com">rudolf<span>&#64;</span>pobox<span>&#46;</span>com</a>).</p>
<p>This file is part of CRATE.</p>
<p>CRATE is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>
<p>CRATE is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License
along with CRATE. If not, see &lt;<a class="reference external" href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>
</div></blockquote>
<hr class="docutils" />
<dl class="function">
<dt id="crate_anon.common.sql.escape_percent_for_python_dbapi">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">escape_percent_for_python_dbapi</code><span class="sig-paren">(</span><em>sql: str</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#escape_percent_for_python_dbapi"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.escape_percent_for_python_dbapi" title="Permalink to this definition">¶</a></dt>
<dd><p>Escapes % by converting it to %%.
Use this for SQL within Python where % characters are used for argument
placeholders.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.escape_percent_in_literal">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">escape_percent_in_literal</code><span class="sig-paren">(</span><em>sql: str</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#escape_percent_in_literal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.escape_percent_in_literal" title="Permalink to this definition">¶</a></dt>
<dd><p>Escapes % by converting it to %.
Use this for LIKE clauses.
<a class="reference external" href="http://dev.mysql.com/doc/refman/5.7/en/string-literals.html">http://dev.mysql.com/doc/refman/5.7/en/string-literals.html</a></p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.escape_quote_in_literal">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">escape_quote_in_literal</code><span class="sig-paren">(</span><em>s: str</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#escape_quote_in_literal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.escape_quote_in_literal" title="Permalink to this definition">¶</a></dt>
<dd><p>Escape ‘. We could use ‘’ or ‘.
Let’s use . for consistency with percent escaping.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.escape_sql_string_literal">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">escape_sql_string_literal</code><span class="sig-paren">(</span><em>s: str</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#escape_sql_string_literal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.escape_sql_string_literal" title="Permalink to this definition">¶</a></dt>
<dd><p>Escapes SQL string literal fragments against quotes and parameter
substitution.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.get_column_names">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">get_column_names</code><span class="sig-paren">(</span><em>engine: sqlalchemy.engine.base.Engine</em>, <em>tablename: str</em>, <em>to_lower: bool = False</em>, <em>sort: bool = False</em><span class="sig-paren">)</span> &#x2192; List[str]<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#get_column_names"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.get_column_names" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads columns names afresh from the database (in case metadata is out of
date).</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.get_first_from_table">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">get_first_from_table</code><span class="sig-paren">(</span><em>parsed: pyparsing.ParseResults</em>, <em>match_db: str = ''</em>, <em>match_schema: str = ''</em>, <em>match_table: str = ''</em><span class="sig-paren">)</span> &#x2192; crate_anon.common.sql.TableId<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#get_first_from_table"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.get_first_from_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a set of parsed results from a SELECT statement,
returns the (db, schema, table) tuple
representing the first table in the FROM clause.</p>
<p>Optionally, the match may be constrained with the match* parameters.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.get_index_names">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">get_index_names</code><span class="sig-paren">(</span><em>engine: sqlalchemy.engine.base.Engine</em>, <em>tablename: str</em>, <em>to_lower: bool = False</em><span class="sig-paren">)</span> &#x2192; List[str]<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#get_index_names"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.get_index_names" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads index names from the database.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.parser_add_from_tables">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">parser_add_from_tables</code><span class="sig-paren">(</span><em>parsed: pyparsing.ParseResults, join_info_list: List[crate_anon.common.sql.JoinInfo], grammar: cardinal_pythonlib.sql.sql_grammar.SqlGrammar</em><span class="sig-paren">)</span> &#x2192; pyparsing.ParseResults<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#parser_add_from_tables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.parser_add_from_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>Presupposes at least one table already in the FROM clause.</p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.sql_fragment_cast_to_int">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">sql_fragment_cast_to_int</code><span class="sig-paren">(</span><em>expr: str</em>, <em>big: bool = True</em>, <em>dialect: sqlalchemy.engine.interfaces.Dialect = None</em>, <em>viewmaker: crate_anon.common.sql.ViewMaker = None</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#sql_fragment_cast_to_int"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.sql_fragment_cast_to_int" title="Permalink to this definition">¶</a></dt>
<dd><p>For Microsoft SQL Server.
Conversion to INT:</p>
<ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/2000045">http://stackoverflow.com/questions/2000045</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/14719760">http://stackoverflow.com/questions/14719760</a>  # this one</li>
<li><a class="reference external" href="http://stackoverflow.com/questions/14692131">http://stackoverflow.com/questions/14692131</a><ul>
<li>see LIKE example.</li>
<li>see ISNUMERIC();
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms186272.aspx">https://msdn.microsoft.com/en-us/library/ms186272.aspx</a>
… but that includes non-integer numerics</li>
</ul>
</li>
<li><a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms174214(v=sql.120).aspx">https://msdn.microsoft.com/en-us/library/ms174214(v=sql.120).aspx</a>
… relates to the SQL Server Management Studio “Find and Replace”
dialogue box, not to SQL itself!</li>
<li><a class="reference external" href="http://stackoverflow.com/questions/29206404/mssql-regular-expression">http://stackoverflow.com/questions/29206404/mssql-regular-expression</a></li>
</ul>
<p>Note that the regex-like expression supported by LIKE is extremely limited.</p>
<ul class="simple">
<li><a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms179859.aspx">https://msdn.microsoft.com/en-us/library/ms179859.aspx</a></li>
</ul>
<p>The only things supported are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%   any characters
_   any single character
[]  single character in range or set, e.g. [a-f], [abcdef]
[^] single character NOT in range or set, e.g. [^a-f], [abcdef]
</pre></div>
</div>
<p>SQL Server does not support a REGEXP command directly.</p>
<p>So the best bet is to have the LIKE clause check for a non-integer:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">something</span> <span class="k">LIKE</span> <span class="s1">&#39;%[^0-9]%&#39;</span> <span class="k">THEN</span> <span class="k">NULL</span>
    <span class="k">ELSE</span> <span class="k">CAST</span><span class="p">(</span><span class="n">something</span> <span class="k">AS</span> <span class="nb">BIGINT</span><span class="p">)</span>
<span class="k">END</span>
</pre></div>
</div>
<p>… which doesn’t deal with spaces properly, but there you go.
Could also strip whitespace left/right:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">LTRIM</span><span class="p">(</span><span class="n">RTRIM</span><span class="p">(</span><span class="n">something</span><span class="p">))</span> <span class="k">LIKE</span> <span class="s1">&#39;%[^0-9]%&#39;</span> <span class="k">THEN</span> <span class="k">NULL</span>
    <span class="k">ELSE</span> <span class="k">CAST</span><span class="p">(</span><span class="n">something</span> <span class="k">AS</span> <span class="nb">BIGINT</span><span class="p">)</span>
<span class="k">END</span>
</pre></div>
</div>
<p>Only works for positive integers.
LTRIM/RTRIM are not ANSI SQL.
Nor are unusual LIKE clauses; see
<a class="reference external" href="http://stackoverflow.com/questions/712580/list-of-special-characters-for-sql-like-clause">http://stackoverflow.com/questions/712580/list-of-special-characters-for-sql-like-clause</a></p>
<p>The other, for SQL Server 2012 or higher, is TRY_CAST:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">TRY_CAST</span><span class="p">(</span><span class="n">something</span> <span class="k">AS</span> <span class="nb">BIGINT</span><span class="p">)</span>
</pre></div>
</div>
<p>… which returns NULL upon failure; see
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/hh974669.aspx">https://msdn.microsoft.com/en-us/library/hh974669.aspx</a></p>
</dd></dl>

<dl class="function">
<dt id="crate_anon.common.sql.translate_sql_qmark_to_percent">
<code class="descclassname">crate_anon.common.sql.</code><code class="descname">translate_sql_qmark_to_percent</code><span class="sig-paren">(</span><em>sql: str</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../../_modules/crate_anon/common/sql.html#translate_sql_qmark_to_percent"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#crate_anon.common.sql.translate_sql_qmark_to_percent" title="Permalink to this definition">¶</a></dt>
<dd><p>MySQL likes ‘?’ as a placeholder.
- <a class="reference external" href="https://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html">https://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html</a></p>
<p>Python DBAPI allows several: ‘%s’, ‘?’, ‘:1’, ‘:name’, ‘%(name)s’.
- <a class="reference external" href="https://www.python.org/dev/peps/pep-0249/#paramstyle">https://www.python.org/dev/peps/pep-0249/#paramstyle</a></p>
<p>Django uses ‘%s’.
- <a class="reference external" href="https://docs.djangoproject.com/en/1.8/topics/db/sql/">https://docs.djangoproject.com/en/1.8/topics/db/sql/</a></p>
<p>Microsoft like ‘?’, <a class="reference external" href="mailto:'&#37;&#52;&#48;paramname">‘<span>&#64;</span>paramname</a>’, and ‘:paramname’.
- <a class="reference external" href="https://msdn.microsoft.com/en-us/library/yy6y35y8(v=vs.110).aspx">https://msdn.microsoft.com/en-us/library/yy6y35y8(v=vs.110).aspx</a></p>
<p>We need to parse SQL with argument placeholders.
- See SqlGrammar classes, particularly: bind_parameter</p>
<p>I prefer ?, because % is used in LIKE clauses, and the databases we’re
using like it.</p>
<p>So:</p>
<ul class="simple">
<li>We use %s when using cursor.execute() directly, via Django.</li>
<li>We use ? when talking to users, and SqlGrammar objects, so that the
visual appearance matches what they expect from their database.</li>
</ul>
<p>This function translates SQL using ? placeholders to SQL using %s
placeholders, without breaking literal ‘?’ or ‘%’, e.g. inside string
literals.</p>
</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">15. Automatic documentation of source code</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../anonymise/_index.html">15.1. crate_anon.anonymise</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_index.html">15.2. crate_anon.common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crateweb/_index.html">15.3. crate_anon.crateweb</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nlp_manager/_index.html">15.4. crate_anon.nlp_manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/_index.html">15.5. crate_anon.preprocess</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/_index.html">15.6. crate_anon.tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="parallel.html"
                        title="previous chapter">15.2.4. crate_anon.common.parallel</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="stringfunc.html"
                        title="next chapter">15.2.6. crate_anon.common.stringfunc</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/autodoc/common/sql.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="stringfunc.html" title="15.2.6. crate_anon.common.stringfunc"
             >next</a> |</li>
        <li class="right" >
          <a href="parallel.html" title="15.2.4. crate_anon.common.parallel"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >15. Automatic documentation of source code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="_index.html" >15.2. crate_anon.common</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>