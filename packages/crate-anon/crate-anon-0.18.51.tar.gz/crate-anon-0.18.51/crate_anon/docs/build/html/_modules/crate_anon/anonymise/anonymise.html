
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.anonymise.anonymise &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.anonymise.anonymise</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/anonymise/anonymise.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">Anonymise multiple SQL-based databases using a data dictionary.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.datetimefunc</span> <span class="k">import</span> <span class="n">get_now_utc_pendulum</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.core_query</span> <span class="k">import</span> <span class="n">count_star</span><span class="p">,</span> <span class="n">exists_plain</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.schema</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">add_index</span><span class="p">,</span>
    <span class="n">get_column_names</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sortedcontainers</span> <span class="k">import</span> <span class="n">SortedSet</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">column</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">table</span>

<span class="kn">from</span> <span class="nn">crate_anon.anonymise.config_singleton</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BIGSEP</span><span class="p">,</span>
    <span class="n">DEFAULT_CHUNKSIZE</span><span class="p">,</span>
    <span class="n">DEFAULT_REPORT_EVERY</span><span class="p">,</span>
    <span class="n">INDEX</span><span class="p">,</span>
    <span class="n">TABLE_KWARGS</span><span class="p">,</span>
    <span class="n">SEP</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">OptOutMpid</span><span class="p">,</span>
    <span class="n">OptOutPid</span><span class="p">,</span>
    <span class="n">PatientInfo</span><span class="p">,</span>
    <span class="n">TridRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.patient</span> <span class="k">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.ddr</span> <span class="k">import</span> <span class="n">DataDictionaryRow</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.formatting</span> <span class="k">import</span> <span class="n">print_record_counts</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.parallel</span> <span class="k">import</span> <span class="n">is_my_job_by_hash</span><span class="p">,</span> <span class="n">is_my_job_by_int</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.sql</span> <span class="k">import</span> <span class="n">matches_tabledef</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Database queries</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="identical_record_exists_by_hash"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.identical_record_exists_by_hash">[docs]</a><span class="k">def</span> <span class="nf">identical_record_exists_by_hash</span><span class="p">(</span><span class="n">dest_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">pkfield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">pkvalue</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                    <span class="n">hashvalue</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given PK in a given destination table, is there a record with the</span>
<span class="sd">    specified value for its source hash?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exists_plain</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                        <span class="n">dest_table</span><span class="p">,</span>
                        <span class="n">column</span><span class="p">(</span><span class="n">pkfield</span><span class="p">)</span> <span class="o">==</span> <span class="n">pkvalue</span><span class="p">,</span>
                        <span class="n">column</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">)</span> <span class="o">==</span> <span class="n">hashvalue</span><span class="p">)</span></div>


<div class="viewcode-block" id="identical_record_exists_by_pk"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.identical_record_exists_by_pk">[docs]</a><span class="k">def</span> <span class="nf">identical_record_exists_by_pk</span><span class="p">(</span><span class="n">dest_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">pkfield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">pkvalue</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given PK in a given destination table, does a record exist?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exists_plain</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                        <span class="n">dest_table</span><span class="p">,</span>
                        <span class="n">column</span><span class="p">(</span><span class="n">pkfield</span><span class="p">)</span> <span class="o">==</span> <span class="n">pkvalue</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Database actions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="wipe_and_recreate_destination_db"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.wipe_and_recreate_destination_db">[docs]</a><span class="k">def</span> <span class="nf">wipe_and_recreate_destination_db</span><span class="p">(</span><span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop and recreate all destination tables (as specified in the DD) in the</span>
<span class="sd">    destination database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rebuilding destination database (incremental=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">incremental</span><span class="p">))</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">engine</span>
    <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_tables</span><span class="p">():</span>
        <span class="n">sqla_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_sqla_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Drop</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">incremental</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dropping table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
            <span class="n">sqla_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Create</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sqla_table</span><span class="p">))</span>
        <span class="n">sqla_table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Check</span>
        <span class="n">resulting_fieldnames</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="n">target_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sqla_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">outcome_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">resulting_fieldnames</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_set</span> <span class="o">-</span> <span class="n">outcome_set</span><span class="p">)</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outcome_set</span> <span class="o">-</span> <span class="n">target_set</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Missing fields in destination table </span><span class="si">{t}</span><span class="s2">: </span><span class="si">{fields}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">missing</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Extra fields in destination table </span><span class="si">{t}</span><span class="s2">: </span><span class="si">{fields}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">extra</span><span class="p">))</span></div>


<div class="viewcode-block" id="delete_dest_rows_with_no_src_row"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.delete_dest_rows_with_no_src_row">[docs]</a><span class="k">def</span> <span class="nf">delete_dest_rows_with_no_src_row</span><span class="p">(</span>
        <span class="n">srcdbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">report_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_REPORT_EVERY</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_CHUNKSIZE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given source database/table, delete any rows in the corresponding</span>
<span class="sd">    destination table where there is no corresponding source row.</span>

<span class="sd">    - Can&#39;t do this in a single SQL command, since the engine can&#39;t</span>
<span class="sd">      necessarily see both databases.</span>
<span class="sd">    - Can&#39;t do this in a multiprocess way, because we&#39;re trying to do a</span>
<span class="sd">      DELETE WHERE NOT IN.</span>
<span class="sd">    - However, we can get stupidly long query lists if we try to SELECT all</span>
<span class="sd">      the values and use a DELETE FROM x WHERE y NOT IN (v1, v2, v3, ...)</span>
<span class="sd">      query. This crashes the MySQL connection, etc.</span>
<span class="sd">    - Therefore, we need a temporary table in the destination.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">has_active_destination</span><span class="p">(</span><span class="n">srcdbname</span><span class="p">,</span> <span class="n">src_table</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">dest_table_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_table_for_src_db_table</span><span class="p">(</span><span class="n">srcdbname</span><span class="p">,</span>
                                                                <span class="n">src_table</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;delete_dest_rows_with_no_src_row: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">srcdbname</span><span class="p">,</span> <span class="n">src_table</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest_table_name</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;[WARNING: MAY BE SLOW]&quot;</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>  <span class="c1"># operate in isolation!</span>
    <span class="n">destengine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">engine</span>
    <span class="n">destsession</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span>
    <span class="n">dest_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_sqla_table</span><span class="p">(</span><span class="n">dest_table_name</span><span class="p">)</span>
    <span class="n">pkddr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_pk_ddr</span><span class="p">(</span><span class="n">srcdbname</span><span class="p">,</span> <span class="n">src_table</span><span class="p">)</span>

    <span class="c1"># If there&#39;s no source PK, we just delete everything</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pkddr</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... No source PK; deleting everything&quot;</span><span class="p">)</span>
        <span class="n">destsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dest_table</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>
        <span class="n">commit_destdb</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">pkddr</span><span class="o">.</span><span class="n">addition_only</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... Table marked as addition-only; not deleting anything&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Drop/create temporary table</span>
    <span class="n">pkfield</span> <span class="o">=</span> <span class="s1">&#39;srcpk&#39;</span>
    <span class="n">temptable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="n">pkfield</span><span class="p">,</span> <span class="n">pkddr</span><span class="o">.</span><span class="n">get_dest_sqla_coltype</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="o">**</span><span class="n">TABLE_KWARGS</span>
    <span class="p">)</span>
    <span class="c1"># THIS (ABOVE) IS WHAT CONSTRAINS A USER-DEFINED PK TO BE UNIQUE WITHIN ITS</span>
    <span class="c1"># TABLE.</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... dropping temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... making temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Populate temporary table, +/- PK translation</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">srcdbname</span><span class="p">]</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">src_table</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... populating temporary table: </span><span class="si">{}</span><span class="s2"> records to go&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">records_</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;... inserting </span><span class="si">{}</span><span class="s2"> records&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records_</span><span class="p">)))</span>
        <span class="n">destsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">temptable</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">records_</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str: Any]]</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">gen_pks</span><span class="p">(</span><span class="n">srcdbname</span><span class="p">,</span> <span class="n">src_table</span><span class="p">,</span> <span class="n">pkddr</span><span class="o">.</span><span class="n">src_field</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">report_every</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">report_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;... src row# </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pkddr</span><span class="o">.</span><span class="n">primary_pid</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">encrypt_primary_pid</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pkddr</span><span class="o">.</span><span class="n">master_pid</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">encrypt_master_pid</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">pkfield</span><span class="p">:</span> <span class="n">pk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">chunksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">insert</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str: Any]]</span>
    <span class="k">if</span> <span class="n">records</span><span class="p">:</span>  <span class="c1"># remainder</span>
        <span class="n">insert</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="n">commit_destdb</span><span class="p">()</span>

    <span class="c1"># 4. Index -- no, hang on, it&#39;s a primary key already</span>
    <span class="c1">#</span>
    <span class="c1"># log.debug(&quot;... creating index on temporary table&quot;)</span>
    <span class="c1"># index = Index(&#39;_temptable_idx&#39;, temptable.columns[pkfield])</span>
    <span class="c1"># index.create(destengine)</span>

    <span class="c1"># 5. DELETE FROM desttable</span>
    <span class="c1">#    WHERE destpk NOT IN (SELECT srcpk FROM temptable)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... deleting from destination where appropriate&quot;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">dest_table</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="o">~</span><span class="n">column</span><span class="p">(</span><span class="n">pkddr</span><span class="o">.</span><span class="n">dest_field</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">temptable</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pkfield</span><span class="p">]])</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">destengine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">commit_destdb</span><span class="p">()</span>

    <span class="c1"># 6. Drop temporary table</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... dropping temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 7. Commit</span>
    <span class="n">commit_destdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="commit_destdb"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.commit_destdb">[docs]</a><span class="k">def</span> <span class="nf">commit_destdb</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a COMMIT on the destination database, and reset row counts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">commit_dest_db</span><span class="p">()</span></div>


<div class="viewcode-block" id="commit_admindb"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.commit_admindb">[docs]</a><span class="k">def</span> <span class="nf">commit_admindb</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a COMMIT on the admin database, which is using ORM sessions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Opt-out</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="opting_out_pid"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.opting_out_pid">[docs]</a><span class="k">def</span> <span class="nf">opting_out_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Does this patient wish to opt out?&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">OptOutPid</span><span class="o">.</span><span class="n">opting_out</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span></div>


<div class="viewcode-block" id="opting_out_mpid"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.opting_out_mpid">[docs]</a><span class="k">def</span> <span class="nf">opting_out_mpid</span><span class="p">(</span><span class="n">mpid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Does this patient wish to opt out?&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mpid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">OptOutMpid</span><span class="o">.</span><span class="n">opting_out</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">mpid</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">gen_optout_rids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="c1"># If a patient opts out, we need to be able to wipe their information from</span>
    <span class="c1"># the database, and hence look up their RID for that purpose.</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PatientInfo</span><span class="o">.</span><span class="n">rid</span><span class="p">)</span><span class="o">.</span>
        <span class="nb">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">PatientInfo</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OptOutPid</span><span class="o">.</span><span class="n">pid</span><span class="p">)),</span>
                <span class="n">PatientInfo</span><span class="o">.</span><span class="n">mpid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OptOutMpid</span><span class="o">.</span><span class="n">mpid</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Generators. Anything reading the main database should use a generator, so the</span>
<span class="c1"># script can scale to databases of arbitrary size.</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="gen_patient_ids"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_patient_ids">[docs]</a><span class="k">def</span> <span class="nf">gen_patient_ids</span><span class="p">(</span><span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate patient IDs.</span>

<span class="sd">        sources: dictionary</span>
<span class="sd">            key: db name</span>
<span class="sd">            value: rnc_db database object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ASSIGNS WORK TO THREADS/PROCESSES, via the simple expedient of processing</span>
    <span class="c1"># only those patient ID numbers where patientnum % ntasks == tasknum.</span>

    <span class="k">assert</span> <span class="n">ntasks</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">tasknum</span> <span class="o">&lt;</span> <span class="n">ntasks</span>

    <span class="n">pid_is_integer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pidtype_is_integer</span>
    <span class="n">distribute_by_hash</span> <span class="o">=</span> <span class="n">ntasks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pid_is_integer</span>

    <span class="c1"># If we&#39;re going to define based on &gt;1 table, we need to keep track of</span>
    <span class="c1"># what we&#39;ve processed. However, if we only have one table, we don&#39;t.</span>
    <span class="c1"># We can&#39;t use the mapping table easily (*), because it leads to thread/</span>
    <span class="c1"># process locking for database access. So we use a set.</span>
    <span class="c1"># (*) if not patient_id_exists_in_mapping_db(admindb, patient_id): ...</span>

    <span class="c1"># Debug option?</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_pid_list</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;USING MANUALLY SPECIFIED INTEGER PATIENT ID LIST&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_pid_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pid_is_integer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_my_job_by_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">pid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_my_job_by_hash</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">pid</span>
        <span class="k">return</span>

    <span class="c1"># Otherwise do it properly:</span>
    <span class="n">keeping_track</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">n_definers</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># used only if keeping_track is True</span>
    <span class="c1"># ... POTENTIAL FOR MEMORY PROBLEM WITH V. BIG DB</span>
    <span class="c1"># ... if we ever get near that limit (for a huge number of *patients*,</span>
    <span class="c1"># which is much less likely than a huge number of other records), we&#39;d</span>
    <span class="c1"># need to generate the IDs and stash them in a temporary table, then</span>
    <span class="c1"># work through that. However, a few million patients should be fine</span>
    <span class="c1"># for a Python set on realistic computers.</span>
    <span class="n">n_found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">debuglimit</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_max_n_patients</span>
    <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddr</span><span class="o">.</span><span class="n">defines_primary_pids</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">pidcol</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_field</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_db</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">pidcol</span><span class="p">])</span><span class="o">.</span>
            <span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_table</span><span class="p">))</span><span class="o">.</span>
            <span class="n">where</span><span class="p">(</span><span class="n">pidcol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span>
            <span class="n">distinct</span><span class="p">()</span>
            <span class="c1"># order_by(pidcol)  # no need to order by</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ntasks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pid_is_integer</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pidcol</span> <span class="o">%</span> <span class="n">ntasks</span> <span class="o">==</span> <span class="n">tasknum</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Looking for patient IDs in </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span>
                                                            <span class="n">ddr</span><span class="o">.</span><span class="n">src_field</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="c1"># Extract ID</span>
            <span class="n">patient_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Duff?</span>
            <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Patient ID is NULL&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Operating on non-integer PIDs and not our job?</span>
            <span class="k">if</span> <span class="n">distribute_by_hash</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_my_job_by_hash</span><span class="p">(</span>
                    <span class="n">patient_id</span><span class="p">,</span> <span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Duplicate?</span>
            <span class="k">if</span> <span class="n">keeping_track</span><span class="p">:</span>
                <span class="c1"># Consider, for non-integer PIDs, storing the hash64 instead</span>
                <span class="c1"># of the raw value.</span>
                <span class="k">if</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">processed_ids</span><span class="p">:</span>
                    <span class="c1"># we&#39;ve done this one already; skip it this time</span>
                    <span class="k">continue</span>
                <span class="n">processed_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>

            <span class="c1"># Valid one</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found patient id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patient_id</span><span class="p">))</span>
            <span class="n">n_found</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="n">patient_id</span>

            <span class="c1"># Too many?</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">debuglimit</span> <span class="o">&lt;=</span> <span class="n">n_found</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Not fetching more than </span><span class="si">{}</span><span class="s2"> patients (in total for this &quot;</span>
                    <span class="s2">&quot;process) due to debug_max_n_patients limit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">debuglimit</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># http://docs.sqlalchemy.org/en/latest/core/connections.html  # noqa</span>
                <span class="k">return</span></div>


<div class="viewcode-block" id="estimate_count_patients"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.estimate_count_patients">[docs]</a><span class="k">def</span> <span class="nf">estimate_count_patients</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We can&#39;t easily and quickly get the total number of patients, because they</span>
<span class="sd">    may be defined in multiple tables across multiple databases. We shouldn&#39;t</span>
<span class="sd">    fetch them all into Python in case there are billions, and it&#39;s a waste of</span>
<span class="sd">    effort to stash them in a temporary table and count unique rows, because</span>
<span class="sd">    this is all only for a progress indicator. So we approximate:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddr</span><span class="o">.</span><span class="n">defines_primary_pids</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_db</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>
        <span class="n">tablename</span> <span class="o">=</span> <span class="n">ddr</span><span class="o">.</span><span class="n">src_table</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="gen_rows"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_rows">[docs]</a><span class="k">def</span> <span class="nf">gen_rows</span><span class="p">(</span><span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">sourcetable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">sourcefields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
             <span class="n">pid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">intpkname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
             <span class="n">debuglimit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates rows from a source table</span>
<span class="sd">    ... each row being a list of values</span>
<span class="sd">    ... each value corresponding to a field in sourcefields.</span>

<span class="sd">    ... optionally restricted to a single patient</span>

<span class="sd">    If the table has a PK and we&#39;re operating in a multitasking situation,</span>
<span class="sd">    generate just the rows for this task (thread/process).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">sourcetable</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sourcefields</span><span class="p">])</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># not ordered</span>

    <span class="c1"># Restrict to one patient?</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pidcol_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_pid_name</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="n">pidcol_name</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For non-patient tables: divide up rows across tasks?</span>
        <span class="k">if</span> <span class="n">intpkname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ntasks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="n">intpkname</span><span class="p">)</span> <span class="o">%</span> <span class="n">ntasks</span> <span class="o">==</span> <span class="n">tasknum</span><span class="p">)</span>
            <span class="c1"># This does not require a user-defined PK to be unique. But other</span>
            <span class="c1"># constraints do: see delete_dest_rows_with_no_src_row().</span>

    <span class="n">db_table_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">debuglimit</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">rows_inserted_per_table</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">warned_re_limits</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">: not fetching more than </span><span class="si">{}</span><span class="s2"> rows (in total &quot;</span>
                    <span class="s2">&quot;for this process) due to debugging limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">dbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">,</span> <span class="n">debuglimit</span><span class="p">))</span>
                <span class="n">config</span><span class="o">.</span><span class="n">warned_re_limits</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># http://docs.sqlalchemy.org/en/latest/core/connections.html  # noqa</span>
            <span class="k">return</span>
        <span class="n">config</span><span class="o">.</span><span class="n">notify_src_bytes_read</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>  <span class="c1"># ... approximate!</span>
        <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="c1"># yield dict(zip(row.keys(), row))</span>
        <span class="c1"># see also http://stackoverflow.com/questions/19406859</span>
        <span class="n">config</span><span class="o">.</span><span class="n">rows_inserted_per_table</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>


<span class="k">def</span> <span class="nf">count_rows</span><span class="p">(</span><span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">sourcetable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">pid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># Count function to match gen_rows()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()])</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">sourcetable</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pidcol_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_pid_name</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="n">pidcol_name</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>


<div class="viewcode-block" id="gen_index_row_sets_by_table"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_index_row_sets_by_table">[docs]</a><span class="k">def</span> <span class="nf">gen_index_row_sets_by_table</span><span class="p">(</span>
        <span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">DataDictionaryRow</span><span class="p">]],</span>
                                      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate (table, list-of-DD-rows-for-indexed-fields) tuples for all tables</span>
<span class="sd">    requiring indexing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indexrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">ddr</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">rows</span>
                 <span class="k">if</span> <span class="n">ddr</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ddr</span><span class="o">.</span><span class="n">omit</span><span class="p">]</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">SortedSet</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">dest_table</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indexrows</span><span class="p">])</span>
    <span class="c1"># must sort for parallel processing consistency: set() order varies</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ntasks</span> <span class="o">!=</span> <span class="n">tasknum</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tablerows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indexrows</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tablerows</span><span class="p">)</span></div>


<div class="viewcode-block" id="gen_nonpatient_tables_without_int_pk"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_nonpatient_tables_without_int_pk">[docs]</a><span class="k">def</span> <span class="nf">gen_nonpatient_tables_without_int_pk</span><span class="p">(</span>
        <span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate (source db name, source table) tuples for all tables that</span>
<span class="sd">    (a) don&#39;t contain patient information and</span>
<span class="sd">    (b) don&#39;t have an integer PK.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_table_pairs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_src_dbs_tables_with_no_pt_info_no_pk</span><span class="p">()</span>
    <span class="c1"># ... returns a SortedSet, so safe to divide parallel processing like this:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db_table_pairs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ntasks</span> <span class="o">!=</span> <span class="n">tasknum</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">yield</span> <span class="n">pair</span>  <span class="c1"># will be a (dbname, table) tuple</span></div>


<div class="viewcode-block" id="gen_nonpatient_tables_with_int_pk"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_nonpatient_tables_with_int_pk">[docs]</a><span class="k">def</span> <span class="nf">gen_nonpatient_tables_with_int_pk</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                                     <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate (source db name, source table, PK name) tuples for all tables that</span>
<span class="sd">    (a) don&#39;t contain patient information and</span>
<span class="sd">    (b) do have an integer PK.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_table_pairs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_src_dbs_tables_with_no_pt_info_int_pk</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">db_table_pairs</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tablename</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pkname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_int_pk_name</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">pkname</span><span class="p">)</span></div>


<div class="viewcode-block" id="gen_pks"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.gen_pks">[docs]</a><span class="k">def</span> <span class="nf">gen_pks</span><span class="p">(</span><span class="n">srcdbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">pkname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate PK values from a table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">srcdbname</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">column</span><span class="p">(</span><span class="n">pkname</span><span class="p">)])</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Core functions</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># - For multithreaded use, the patients are divvied up across the threads.</span>
<span class="c1"># - KEY THREADING RULE: ALL THREADS MUST HAVE FULLY INDEPENDENT DATABASE</span>
<span class="c1">#   CONNECTIONS.</span>

<div class="viewcode-block" id="process_table"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.process_table">[docs]</a><span class="k">def</span> <span class="nf">process_table</span><span class="p">(</span><span class="n">sourcedbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">sourcetable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">patient</span><span class="p">:</span> <span class="n">Patient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">intpkname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a table. This can either be a patient table (in which case the</span>
<span class="sd">    patient&#39;s scrubber is applied and only rows for that patient are processed)</span>
<span class="sd">    or not (in which case the table is just copied).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;process_table: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_pid</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;pid=</span><span class="si">{}</span><span class="s2">, incremental=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">incremental</span><span class="p">))</span>

    <span class="c1"># Limit the data quantity for debugging?</span>
    <span class="n">srccfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">sourcedbname</span><span class="p">]</span><span class="o">.</span><span class="n">srccfg</span>
    <span class="k">if</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="n">sourcetable</span><span class="p">,</span> <span class="n">srccfg</span><span class="o">.</span><span class="n">debug_limited_tables</span><span class="p">):</span>
        <span class="n">debuglimit</span> <span class="o">=</span> <span class="n">srccfg</span><span class="o">.</span><span class="n">debug_row_limit</span>
        <span class="c1"># log.debug(&quot;Limiting table {} to {} rows (per process)&quot;.format(</span>
        <span class="c1">#     sourcetable, debuglimit))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debuglimit</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ddrows</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_rows_for_src_table</span><span class="p">(</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">omit</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">ddrows</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">addhash</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">add_src_hash</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">ddrows</span><span class="p">)</span>
    <span class="n">addtrid</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">primary_pid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ddr</span><span class="o">.</span><span class="n">omit</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">ddrows</span><span class="p">)</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">constant</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">ddrows</span><span class="p">)</span>
    <span class="c1"># If addhash or constant is true AND we are not omitting all rows, then</span>
    <span class="c1"># the non-omitted rows will include the source PK (by the data dictionary&#39;s</span>
    <span class="c1"># validation process).</span>
    <span class="n">ddrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">ddr</span> <span class="k">for</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="n">ddrows</span>
              <span class="k">if</span> <span class="p">(</span>
                  <span class="p">(</span><span class="ow">not</span> <span class="n">ddr</span><span class="o">.</span><span class="n">omit</span><span class="p">)</span> <span class="ow">or</span>  <span class="c1"># used for data</span>
                  <span class="p">(</span><span class="n">addhash</span> <span class="ow">and</span> <span class="n">ddr</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">)</span> <span class="ow">or</span>  <span class="c1"># used for hash</span>
                  <span class="n">ddr</span><span class="o">.</span><span class="n">inclusion_values</span> <span class="ow">or</span>  <span class="c1"># used for filter</span>
                  <span class="n">ddr</span><span class="o">.</span><span class="n">exclusion_values</span>  <span class="c1"># used for filter</span>
              <span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ddrows</span><span class="p">:</span>
        <span class="c1"># No columns to process at all.</span>
        <span class="k">return</span>
    <span class="n">dest_table</span> <span class="o">=</span> <span class="n">ddrows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dest_table</span>
    <span class="n">sourcefields</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="n">pkfield_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">src_pk_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dest_pk_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ddrows</span><span class="p">):</span>
        <span class="c1"># log.debug(&quot;DD row: {}&quot;.format(str(ddr)))</span>
        <span class="k">if</span> <span class="n">ddr</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="n">pkfield_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">src_pk_name</span> <span class="o">=</span> <span class="n">ddr</span><span class="o">.</span><span class="n">src_field</span>
            <span class="n">dest_pk_name</span> <span class="o">=</span> <span class="n">ddr</span><span class="o">.</span><span class="n">dest_field</span>
        <span class="n">sourcefields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddr</span><span class="o">.</span><span class="n">src_field</span><span class="p">)</span>
    <span class="n">srchash</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sqla_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_sqla_table</span><span class="p">(</span><span class="n">dest_table</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span>

    <span class="c1"># Count what we&#39;ll do, so we can give a better indication of progress</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count_rows</span><span class="p">(</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">recnum</span> <span class="o">=</span> <span class="n">tasknum</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="c1"># Process the rows</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gen_rows</span><span class="p">(</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">sourcetable</span><span class="p">,</span> <span class="n">sourcefields</span><span class="p">,</span>
                        <span class="n">pid</span><span class="p">,</span> <span class="n">debuglimit</span><span class="o">=</span><span class="n">debuglimit</span><span class="p">,</span>
                        <span class="n">intpkname</span><span class="o">=</span><span class="n">intpkname</span><span class="p">,</span> <span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">report_every_n_rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;processing record </span><span class="si">{recnum}</span><span class="s2">/</span><span class="si">{count}{for_pt}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;(</span><span class="si">{progress}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">recnum</span><span class="o">=</span><span class="n">recnum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                    <span class="n">for_pt</span><span class="o">=</span><span class="s2">&quot; for this patient&quot;</span> <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">overall_progress</span><span class="p">()))</span>
        <span class="n">recnum</span> <span class="o">+=</span> <span class="n">ntasks</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">addhash</span><span class="p">:</span>
            <span class="n">srchash</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hash_object</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">incremental</span> <span class="ow">and</span> <span class="n">identical_record_exists_by_hash</span><span class="p">(</span>
                    <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_pk_name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">pkfield_index</span><span class="p">],</span> <span class="n">srchash</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;... ... skipping unchanged record (identical by hash): &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{sd}</span><span class="s2">.</span><span class="si">{st}</span><span class="s2">.</span><span class="si">{spkf}</span><span class="s2"> = &quot;</span>
                    <span class="s2">&quot;(destination) </span><span class="si">{dt}</span><span class="s2">.</span><span class="si">{dpkf}</span><span class="s2"> = </span><span class="si">{pkv}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sd</span><span class="o">=</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">sourcetable</span><span class="p">,</span> <span class="n">spkf</span><span class="o">=</span><span class="n">src_pk_name</span><span class="p">,</span>
                        <span class="n">dt</span><span class="o">=</span><span class="n">dest_table</span><span class="p">,</span> <span class="n">dpkf</span><span class="o">=</span><span class="n">dest_pk_name</span><span class="p">,</span>
                        <span class="n">pkv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">pkfield_index</span><span class="p">]))</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">constant</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">incremental</span> <span class="ow">and</span> <span class="n">identical_record_exists_by_pk</span><span class="p">(</span>
                    <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_pk_name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">pkfield_index</span><span class="p">]):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;... ... skipping unchanged record (identical by PK and &quot;</span>
                    <span class="s2">&quot;marked as constant): </span><span class="si">{sd}</span><span class="s2">.</span><span class="si">{st}</span><span class="s2">.</span><span class="si">{spkf}</span><span class="s2"> = &quot;</span>
                    <span class="s2">&quot;(destination) </span><span class="si">{dt}</span><span class="s2">.</span><span class="si">{dpkf}</span><span class="s2"> = </span><span class="si">{pkv}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sd</span><span class="o">=</span><span class="n">sourcedbname</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">sourcetable</span><span class="p">,</span> <span class="n">spkf</span><span class="o">=</span><span class="n">src_pk_name</span><span class="p">,</span>
                        <span class="n">dt</span><span class="o">=</span><span class="n">dest_table</span><span class="p">,</span> <span class="n">dpkf</span><span class="o">=</span><span class="n">dest_pk_name</span><span class="p">,</span>
                        <span class="n">pkv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">pkfield_index</span><span class="p">]))</span>
                <span class="k">continue</span>
        <span class="n">destvalues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">skip_row</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ddr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ddrows</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ddr</span><span class="o">.</span><span class="n">skip_row_by_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># log.debug(&quot;skipping row based on inclusion/exclusion values&quot;)</span>
                <span class="n">skip_row</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>  <span class="c1"># skip row</span>
            <span class="c1"># NOTE: would be most efficient if ddrows were ordered with</span>
            <span class="c1"># inclusion/exclusion fields first. (Not yet done automatically.)</span>
            <span class="k">if</span> <span class="n">ddr</span><span class="o">.</span><span class="n">omit</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># skip column</span>

            <span class="k">if</span> <span class="n">ddr</span><span class="o">.</span><span class="n">primary_pid</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_pid</span><span class="p">())</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_rid</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">ddr</span><span class="o">.</span><span class="n">master_pid</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">encrypt_master_pid</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">alter_method</span> <span class="ow">in</span> <span class="n">ddr</span><span class="o">.</span><span class="n">get_alter_methods</span><span class="p">():</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">skiprow</span> <span class="o">=</span> <span class="n">alter_method</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">ddr</span><span class="o">=</span><span class="n">ddr</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                    <span class="n">ddrows</span><span class="o">=</span><span class="n">ddrows</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">skiprow</span><span class="p">:</span>
                    <span class="k">break</span>  <span class="c1"># from alter method loop</span>

            <span class="k">if</span> <span class="n">skip_row</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># from data dictionary row (field) loop</span>

            <span class="n">destvalues</span><span class="p">[</span><span class="n">ddr</span><span class="o">.</span><span class="n">dest_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">skip_row</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">destvalues</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># next row</span>

        <span class="k">if</span> <span class="n">addhash</span><span class="p">:</span>
            <span class="n">destvalues</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">srchash</span>
        <span class="k">if</span> <span class="n">addtrid</span><span class="p">:</span>
            <span class="n">destvalues</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">trid_fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_trid</span><span class="p">()</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">sqla_table</span><span class="o">.</span><span class="n">insert_on_duplicate</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">destvalues</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="c1"># Trigger an early commit?</span>
        <span class="n">config</span><span class="o">.</span><span class="n">notify_dest_db_transaction</span><span class="p">(</span>
            <span class="n">n_rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">destvalues</span><span class="p">))</span>  <span class="c1"># ... approximate!</span>
        <span class="c1"># ... quicker than e.g. len(repr(...)), as judged by a timeit() call.</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;finished: pid=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
    <span class="n">commit_destdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_indexes"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.create_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_indexes</span><span class="p">(</span><span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create indexes for the destination tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Create indexes&quot;</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_destdb_engine_outside_transaction</span><span class="p">()</span>
    <span class="n">mssql</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mssql&#39;</span>
    <span class="n">mssql_fulltext_columns_by_table</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[List[Column]]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">tablerows</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gen_index_row_sets_by_table</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span>
                                                              <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
        <span class="n">sqla_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_sqla_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">mssql_fulltext_columns</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Column]</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">tablerows</span><span class="p">:</span>
            <span class="n">sqla_column</span> <span class="o">=</span> <span class="n">sqla_table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">dest_field</span><span class="p">]</span>
            <span class="n">fulltext</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">FULLTEXT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fulltext</span> <span class="ow">and</span> <span class="n">mssql</span><span class="p">:</span>
                <span class="c1"># Special processing: we can only create one full-text index</span>
                <span class="c1"># per table under SQL Server, but it can cover multiple</span>
                <span class="c1"># columns; see below</span>
                <span class="n">mssql_fulltext_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqla_column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_index</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                          <span class="n">sqla_column</span><span class="o">=</span><span class="n">sqla_column</span><span class="p">,</span>
                          <span class="n">unique</span><span class="o">=</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">),</span>
                          <span class="n">fulltext</span><span class="o">=</span><span class="n">fulltext</span><span class="p">,</span>
                          <span class="n">length</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">indexlen</span><span class="p">)</span>
            <span class="c1"># Extra index for TRID?</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">primary_pid</span><span class="p">:</span>
                <span class="n">add_index</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sqla_table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">trid_fieldname</span><span class="p">],</span>
                          <span class="n">unique</span><span class="o">=</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mssql_fulltext_columns</span><span class="p">:</span>
            <span class="n">mssql_fulltext_columns_by_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mssql_fulltext_columns</span><span class="p">)</span>
    <span class="c1"># Special processing for SQL Server FULLTEXT indexes, if any:</span>
    <span class="k">for</span> <span class="n">multiple_sqla_columns</span> <span class="ow">in</span> <span class="n">mssql_fulltext_columns_by_table</span><span class="p">:</span>
        <span class="n">add_index</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                  <span class="n">multiple_sqla_columns</span><span class="o">=</span><span class="n">multiple_sqla_columns</span><span class="p">,</span>
                  <span class="n">fulltext</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="patient_processing_fn"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.patient_processing_fn">[docs]</a><span class="k">def</span> <span class="nf">patient_processing_fn</span><span class="p">(</span><span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterate through patient IDs;</span>
<span class="sd">        build the scrubber for each patient;</span>
<span class="sd">        process source data for that patient, scrubbing it;</span>
<span class="sd">        insert the patient into the mapping table in the admin database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_patients</span> <span class="o">=</span> <span class="n">estimate_count_patients</span><span class="p">()</span> <span class="o">//</span> <span class="n">ntasks</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">gen_patient_ids</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">):</span>
        <span class="c1"># gen_patient_ids() assigns the work to the appropriate thread/process</span>
        <span class="c1"># Check for an abort signal once per patient processed</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Processing patient ID: </span><span class="si">{pid}</span><span class="s2"> (incremental=</span><span class="si">{incremental}</span><span class="s2">; &quot;</span>
            <span class="s2">&quot;patient </span><span class="si">{i}</span><span class="s2">/~</span><span class="si">{n_patients}</span><span class="s2"> for this process; </span><span class="si">{progress}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">n_patients</span><span class="o">=</span><span class="n">n_patients</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">overall_progress</span><span class="p">()))</span>

        <span class="c1"># Opt out based on PID?</span>
        <span class="k">if</span> <span class="n">opting_out_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... opt out based on PID&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># MPID information won&#39;t be present until we scan all the fields (which</span>
        <span class="c1"># we do as we build the scrubber).</span>

        <span class="c1"># Gather scrubbing information for a patient. (Will save.)</span>
        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">mandatory_scrubbers_unfulfilled</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Skipping patient with PID=</span><span class="si">{}</span><span class="s2"> as the following scrub_src &quot;</span>
                <span class="s2">&quot;fields are required and had no data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pid</span><span class="p">,</span> <span class="n">patient</span><span class="o">.</span><span class="n">mandatory_scrubbers_unfulfilled</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># Opt out based on MPID?</span>
        <span class="k">if</span> <span class="n">opting_out_mpid</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">get_mpid</span><span class="p">()):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... opt out based on MPID&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">patient_unchanged</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">unchanged</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">incremental</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">patient_unchanged</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scrubber unchanged; may save some time&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scrubber new or changed; reprocessing in full&quot;</span><span class="p">)</span>

        <span class="c1"># For each source database/table...</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_source_databases</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patient </span><span class="si">{}</span><span class="s2">, processing database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_patient_src_tables_with_active_dest</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patient </span><span class="si">{}</span><span class="s2">, processing table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pid</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
                <span class="n">process_table</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
                              <span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">,</span>
                              <span class="n">incremental</span><span class="o">=</span><span class="p">(</span><span class="n">incremental</span> <span class="ow">and</span> <span class="n">patient_unchanged</span><span class="p">))</span>

    <span class="n">commit_destdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="wipe_opt_out_patients"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.wipe_opt_out_patients">[docs]</a><span class="k">def</span> <span class="nf">wipe_opt_out_patients</span><span class="p">(</span><span class="n">report_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                          <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete any data from patients that have opted out (after their data was</span>
<span class="sd">    processed on a previous occasion).</span>
<span class="sd">    (Slightly complicated by the fact that the destination database can&#39;t</span>
<span class="sd">    necessarily &#39;see&#39; the mapping database, so we need to cache the RID keys in</span>
<span class="sd">    the destination database temporarily.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;wipe_opt_out_patients&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="n">adminsession</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>  <span class="c1"># operate in isolation!</span>
    <span class="n">destengine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">engine</span>
    <span class="n">destsession</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span>
    <span class="n">ridfield</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">research_id_fieldname</span>

    <span class="c1"># Drop/create temporary table</span>
    <span class="n">pkfield</span> <span class="o">=</span> <span class="s1">&#39;rid&#39;</span>
    <span class="n">temptable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="n">pkfield</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">SqlTypeEncryptedPid</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="o">**</span><span class="n">TABLE_KWARGS</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 1. dropping temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># use engine, not session</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 2. making temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># use engine, not session</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 3. populating temporary table with RIDs&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">records_</span><span class="p">):</span>
        <span class="c1"># records_: a list of dictionaries</span>
        <span class="c1"># http://docs.sqlalchemy.org/en/latest/core/tutorial.html</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;... inserting </span><span class="si">{}</span><span class="s2"> records&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records_</span><span class="p">)))</span>
        <span class="n">destsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">temptable</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">records_</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str: Any]]</span>
    <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">gen_optout_rids</span><span class="p">():</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">report_every</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">report_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;... src row# </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">pkfield</span><span class="p">:</span> <span class="n">rid</span><span class="p">})</span>  <span class="c1"># a row is a dict of values</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">chunksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">insert</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str: Any]]</span>
    <span class="k">if</span> <span class="n">records</span><span class="p">:</span>  <span class="c1"># remainder</span>
        <span class="n">insert</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="n">commit_destdb</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 4. creating index on temporary table&quot;</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="s1">&#39;_temptable_idx&#39;</span><span class="p">,</span> <span class="n">temptable</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pkfield</span><span class="p">])</span>
    <span class="n">index</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">destengine</span><span class="p">)</span>  <span class="c1"># use engine, not session</span>

    <span class="c1"># 5. For each patient destination table,</span>
    <span class="c1">#    DELETE FROM desttable WHERE rid IN (SELECT rid FROM temptable)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 5. deleting from destination table by opt-out RID&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dest_table_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_tables_with_patient_info</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: ... </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_table_name</span><span class="p">))</span>
        <span class="n">dest_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_sqla_table</span><span class="p">(</span><span class="n">dest_table_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">dest_table</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">column</span><span class="p">(</span><span class="n">ridfield</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">select</span><span class="p">([</span><span class="n">temptable</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pkfield</span><span class="p">]])</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">destengine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">commit_destdb</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 6. dropping temporary table&quot;</span><span class="p">)</span>
    <span class="n">temptable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">destengine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># use engine, not session</span>
    <span class="n">commit_destdb</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;: 7. deleting opt-out patients from mapping table&quot;</span><span class="p">)</span>
    <span class="n">adminsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PatientInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">or_</span><span class="p">(</span>
            <span class="n">PatientInfo</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">adminsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OptOutPid</span><span class="o">.</span><span class="n">pid</span><span class="p">)),</span>
            <span class="n">PatientInfo</span><span class="o">.</span><span class="n">mpid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">adminsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OptOutMpid</span><span class="o">.</span><span class="n">mpid</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">commit_admindb</span><span class="p">()</span></div>


<div class="viewcode-block" id="drop_remake"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.drop_remake">[docs]</a><span class="k">def</span> <span class="nf">drop_remake</span><span class="p">(</span><span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">skipdelete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop and rebuild (a) mapping table, (b) destination tables.</span>
<span class="sd">    If incremental is True, doesn&#39;t drop tables; just deletes destination</span>
<span class="sd">    information where source information no longer exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Creating database structure +/- deleting dead data&quot;</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">engine</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">incremental</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping admin tables except opt-out&quot;</span><span class="p">)</span>
        <span class="c1"># not OptOut</span>
        <span class="n">PatientInfo</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">TridRecord</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating admin tables&quot;</span><span class="p">)</span>
    <span class="n">OptOutPid</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">OptOutMpid</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">PatientInfo</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">TridRecord</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">wipe_and_recreate_destination_db</span><span class="p">(</span><span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skipdelete</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">incremental</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_source_databases</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_src_tables</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">delete_dest_rows_with_no_src_row</span><span class="p">(</span>
                <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">report_every</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">report_every_n_rows</span><span class="p">,</span>
                <span class="n">chunksize</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">chunksize</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">gen_integers_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">pid</span>


<span class="k">def</span> <span class="nf">gen_words_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">pid</span>


<span class="k">def</span> <span class="nf">gen_opt_out_pids_from_file</span><span class="p">(</span><span class="n">mpid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span>
                                                                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">mpid</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;MPID&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">optout_mpid_filenames</span>
        <span class="n">as_int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">mpidtype_is_integer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;PID&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">optout_pid_filenames</span>
        <span class="n">as_int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pidtype_is_integer</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... no opt-out </span><span class="si">{}</span><span class="s2"> disk files in use&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... </span><span class="si">{}</span><span class="s2"> file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">as_int</span><span class="p">:</span>
                <span class="k">yield</span><span class="p">(</span><span class="n">gen_integers_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span><span class="p">(</span><span class="n">gen_words_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">gen_opt_out_pids_from_database</span><span class="p">(</span><span class="n">mpid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                                    <span class="kc">None</span><span class="p">]:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;MPID&quot;</span> <span class="k">if</span> <span class="n">mpid</span> <span class="k">else</span> <span class="s2">&quot;PID&quot;</span>
    <span class="n">found_one</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">defining_fields</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_optout_defining_fields</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">defining_fields</span><span class="p">:</span>
        <span class="p">(</span><span class="n">src_db</span><span class="p">,</span> <span class="n">src_table</span><span class="p">,</span> <span class="n">optout_colname</span><span class="p">,</span> <span class="n">pid_colname</span><span class="p">,</span> <span class="n">mpid_colname</span><span class="p">)</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">id_colname</span> <span class="o">=</span> <span class="n">mpid_colname</span> <span class="k">if</span> <span class="n">mpid</span> <span class="k">else</span> <span class="n">pid_colname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">id_colname</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">found_one</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">src_db</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">src_db</span><span class="p">,</span> <span class="n">src_table</span><span class="p">,</span> <span class="n">optout_colname</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">id_colname</span><span class="p">))</span>
        <span class="n">sqla_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="n">src_table</span><span class="p">)</span>
        <span class="n">optout_defining_col</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">optout_colname</span><span class="p">)</span>
        <span class="n">idcol</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">id_colname</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">idcol</span><span class="p">])</span><span class="o">.</span>
            <span class="n">select_from</span><span class="p">(</span><span class="n">sqla_table</span><span class="p">)</span><span class="o">.</span>
            <span class="n">where</span><span class="p">(</span><span class="n">optout_defining_col</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">optout_col_values</span><span class="p">))</span><span class="o">.</span>
            <span class="n">distinct</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># no need for an order_by clause</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">pid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_one</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... no opt-out-defining </span><span class="si">{}</span><span class="s2"> fields in data &quot;</span>
                 <span class="s2">&quot;dictionary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span>


<span class="k">def</span> <span class="nf">setup_opt_out</span><span class="p">(</span><span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Managing opt-outs&quot;</span><span class="p">)</span>
    <span class="n">adminsession</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">session</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hunting for opt-out patients from disk file...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">gen_opt_out_pids_from_file</span><span class="p">():</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">OptOutPid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">adminsession</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mpid</span> <span class="ow">in</span> <span class="n">gen_opt_out_pids_from_file</span><span class="p">(</span><span class="n">mpid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">OptOutMpid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">adminsession</span><span class="p">,</span> <span class="n">mpid</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hunting for opt-out patients from database...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">gen_opt_out_pids_from_database</span><span class="p">():</span>
        <span class="n">OptOutPid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">adminsession</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mpid</span> <span class="ow">in</span> <span class="n">gen_opt_out_pids_from_database</span><span class="p">(</span><span class="n">mpid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">OptOutMpid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">adminsession</span><span class="p">,</span> <span class="n">mpid</span><span class="p">)</span>

    <span class="n">adminsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">incremental</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">wipe_opt_out_patients</span><span class="p">()</span>


<div class="viewcode-block" id="process_nonpatient_tables"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.process_nonpatient_tables">[docs]</a><span class="k">def</span> <span class="nf">process_nonpatient_tables</span><span class="p">(</span><span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copies all non-patient tables.</span>
<span class="sd">    If they have an integer PK, the work may be parallelized.</span>
<span class="sd">    If not, whole tables are assigned to different processes in parallel mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Non-patient tables: (a) with integer PK&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pkname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gen_nonpatient_tables_with_int_pk</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing non-patient table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> (PK: </span><span class="si">{}</span><span class="s2">) (</span><span class="si">{}</span><span class="s2">)...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pkname</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">overall_progress</span><span class="p">()))</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">process_table</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">,</span>
                      <span class="n">intpkname</span><span class="o">=</span><span class="n">pkname</span><span class="p">,</span> <span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">)</span>
        <span class="n">commit_destdb</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Non-patient tables: (b) without integer PK&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gen_nonpatient_tables_without_int_pk</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span>
                                                       <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing non-patient table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">overall_progress</span><span class="p">()))</span>
        <span class="c1"># Force this into single-task mode, i.e. we have already parallelized</span>
        <span class="c1"># by assigning different tables to different processes; don&#39;t split</span>
        <span class="c1"># the work within a single table.</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">process_table</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">,</span>
                      <span class="n">intpkname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tasknum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">commit_destdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="process_patient_tables"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.process_patient_tables">[docs]</a><span class="k">def</span> <span class="nf">process_patient_tables</span><span class="p">(</span><span class="n">tasknum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="n">ntasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">incremental</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process all patient tables, optionally in a parallel-processing fashion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We&#39;ll use multiple destination tables, so commit right at the end.</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Patient tables&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntasks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Single-threaded, single-process mode&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PROCESS </span><span class="si">{}</span><span class="s2"> (numbered from zero) OF </span><span class="si">{}</span><span class="s2"> PROCESSES&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">))</span>
    <span class="n">patient_processing_fn</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span>
                          <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ntasks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process </span><span class="si">{}</span><span class="s2">: FINISHED ANONYMISATION&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tasknum</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FINISHED ANONYMISATION&quot;</span><span class="p">)</span>

    <span class="c1"># Commit (should be redundant)</span>
    <span class="n">commit_destdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="show_source_counts"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.show_source_counts">[docs]</a><span class="k">def</span> <span class="nf">show_source_counts</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show the number of records in all source tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SOURCE TABLE RECORD COUNTS:&quot;</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Tuple[str, int]]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_source_databases</span><span class="p">():</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_src_tables</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">print_record_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_dest_counts"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.show_dest_counts">[docs]</a><span class="k">def</span> <span class="nf">show_dest_counts</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show the number of records in all destination tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DESTINATION TABLE RECORD COUNTS:&quot;</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Tuple[str, int]]</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_dest_tables</span><span class="p">():</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;DESTINATION: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">print_record_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Main</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="anonymise"><a class="viewcode-back" href="../../../autodoc/anonymise/anonymise.html#crate_anon.anonymise.anonymise.anonymise">[docs]</a><span class="k">def</span> <span class="nf">anonymise</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate args</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--nprocesses must be &gt;=1&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">process</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">process</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;--process argument must be from 0 to (nprocesses - 1) inclusive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">dropremake</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t use nprocesses &gt; 1 with --dropremake&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">incrementaldd</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">draftdd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t use --incrementaldd and --draftdd&quot;</span><span class="p">)</span>

    <span class="n">everything</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">dropremake</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">optout</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">nonpatienttables</span><span class="p">,</span>
                          <span class="n">args</span><span class="o">.</span><span class="n">patienttables</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>

    <span class="c1"># Load/validate config</span>
    <span class="n">config</span><span class="o">.</span><span class="n">report_every_n_rows</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reportevery</span>
    <span class="n">config</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">chunksize</span>
    <span class="n">config</span><span class="o">.</span><span class="n">debug_scrubbers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debugscrubbers</span>
    <span class="n">config</span><span class="o">.</span><span class="n">save_scrubbers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">savescrubbers</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_echo</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">echo</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">draftdd</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">load_dd</span><span class="p">(</span><span class="n">check_against_source_db</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_dd_check</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">draftdd</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">incrementaldd</span><span class="p">:</span>
        <span class="c1"># Note: the difference is that for incrementaldd, the data dictionary</span>
        <span class="c1"># will have been loaded from disk; for draftdd, it won&#39;t (so a</span>
        <span class="c1"># completely fresh one will be generated).</span>
        <span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">read_from_source_databases</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_tsv</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="n">config</span><span class="o">.</span><span class="n">check_valid</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
        <span class="n">show_source_counts</span><span class="p">()</span>
        <span class="n">show_dest_counts</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="c1"># random number seed</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">BIGSEP</span> <span class="o">+</span> <span class="s2">&quot;Starting&quot;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">get_now_utc_pendulum</span><span class="p">()</span>

    <span class="c1"># 1. Drop/remake tables. Single-tasking only.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dropremake</span> <span class="ow">or</span> <span class="n">everything</span><span class="p">:</span>
        <span class="n">drop_remake</span><span class="p">(</span><span class="n">incremental</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">incremental</span><span class="p">,</span>
                    <span class="n">skipdelete</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">skipdelete</span><span class="p">)</span>

    <span class="c1"># 2. Deal with opt-outs</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">optout</span> <span class="ow">or</span> <span class="n">everything</span><span class="p">:</span>
        <span class="n">setup_opt_out</span><span class="p">(</span><span class="n">incremental</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">incremental</span><span class="p">)</span>

    <span class="c1"># 3. Tables with patient info.</span>
    <span class="c1">#    Process PER PATIENT, across all tables, because we have to synthesize</span>
    <span class="c1">#    information to scrub across the entirety of that patient&#39;s record.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">patienttables</span> <span class="ow">or</span> <span class="n">everything</span><span class="p">:</span>
        <span class="n">process_patient_tables</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
                               <span class="n">ntasks</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">,</span>
                               <span class="n">incremental</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">incremental</span><span class="p">)</span>

    <span class="c1"># 4. Tables without any patient ID (e.g. lookup tables). Process PER TABLE.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nonpatienttables</span> <span class="ow">or</span> <span class="n">everything</span><span class="p">:</span>
        <span class="n">process_nonpatient_tables</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
                                  <span class="n">ntasks</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">,</span>
                                  <span class="n">incremental</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">incremental</span><span class="p">)</span>

    <span class="c1"># 5. Indexes. ALWAYS FASTEST TO DO THIS LAST. Process PER TABLE.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">everything</span><span class="p">:</span>
        <span class="n">create_indexes</span><span class="p">(</span><span class="n">tasknum</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">BIGSEP</span> <span class="o">+</span> <span class="s2">&quot;Finished&quot;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">get_now_utc_pendulum</span><span class="p">()</span>
    <span class="n">time_taken</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time taken: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_taken</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span></div>
    <span class="c1"># config.dd.debug_cache_hits()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>