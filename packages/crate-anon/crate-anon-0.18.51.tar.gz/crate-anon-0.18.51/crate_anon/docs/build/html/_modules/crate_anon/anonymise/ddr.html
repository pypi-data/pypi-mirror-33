
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.anonymise.ddr &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.anonymise.ddr</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/anonymise/ddr.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.convert</span> <span class="k">import</span> <span class="n">convert_to_int</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.lists</span> <span class="k">import</span> <span class="n">count_bool</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.rnc_db</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ensure_valid_field_name</span><span class="p">,</span>
    <span class="n">ensure_valid_table_name</span><span class="p">,</span>
    <span class="n">is_sqltype_valid</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.schema</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">convert_sqla_type_for_dialect</span><span class="p">,</span>
    <span class="n">does_sqlatype_merit_fulltext_index</span><span class="p">,</span>
    <span class="n">does_sqlatype_require_index_len</span><span class="p">,</span>
    <span class="n">giant_text_sqltype</span><span class="p">,</span>
    <span class="n">get_sqla_coltype_from_dialect_str</span><span class="p">,</span>
    <span class="n">is_sqlatype_binary</span><span class="p">,</span>
    <span class="n">is_sqlatype_date</span><span class="p">,</span>
    <span class="n">is_sqlatype_numeric</span><span class="p">,</span>
    <span class="n">is_sqlatype_text_of_length_at_least</span><span class="p">,</span>
    <span class="n">is_sqlatype_text_over_one_char</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.sqltypes</span> <span class="k">import</span> <span class="n">TypeEngine</span>

<span class="kn">from</span> <span class="nn">crate_anon.anonymise.altermethod</span> <span class="k">import</span> <span class="n">AlterMethod</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ALTERMETHOD</span><span class="p">,</span>
    <span class="n">DECISION</span><span class="p">,</span>
    <span class="n">DEFAULT_INDEX_LEN</span><span class="p">,</span>
    <span class="n">INDEX</span><span class="p">,</span>
    <span class="n">MAX_IDENTIFIER_LENGTH</span><span class="p">,</span>
    <span class="n">ODD_CHARS_TRANSLATE</span><span class="p">,</span>
    <span class="n">SCRUBMETHOD</span><span class="p">,</span>
    <span class="n">SCRUBSRC</span><span class="p">,</span>
    <span class="n">SRCFLAG</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">crate_anon.common.sql</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">crate_anon.anonymise.config</span> <span class="k">import</span> <span class="n">Config</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># DataDictionaryRow</span>
<span class="c1"># =============================================================================</span>

<span class="n">DDR_FWD_REF</span> <span class="o">=</span> <span class="s2">&quot;DataDictionaryRow&quot;</span>
<span class="n">DATABASE_SAFE_CONFIG_FWD_REF</span> <span class="o">=</span> <span class="s2">&quot;DatabaseSafeConfig&quot;</span>


<div class="viewcode-block" id="DataDictionaryRow"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow">[docs]</a><span class="k">class</span> <span class="nc">DataDictionaryRow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing a single row of a data dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ROWNAMES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;src_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;src_table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;src_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;src_datatype&quot;</span><span class="p">,</span>
        <span class="s2">&quot;src_flags&quot;</span><span class="p">,</span>

        <span class="s2">&quot;scrub_src&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scrub_method&quot;</span><span class="p">,</span>

        <span class="s2">&quot;decision&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inclusion_values&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exclusion_values&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alter_method&quot;</span><span class="p">,</span>

        <span class="s2">&quot;dest_table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dest_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dest_datatype&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index&quot;</span><span class="p">,</span>
        <span class="s2">&quot;indexlen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;Config&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up basic defaults.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_datatype</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># in SQL string format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_sqla_coltype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># src_flags: a property; see below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># in the DD file, this is &#39;decision&#39;</span>
        <span class="c1"># alter_method: a property; see below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexlen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_file</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># For src_flags:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Any]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusion_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Any]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[AlterMethod]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Properties</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_db_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_table_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_field_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">add_src_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">primary_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">defines_primary_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">master_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addition_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">opt_out_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PK</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADD_SRC_HASH</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">DEFINES_PRIMARY_PIDS</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">MASTER_PID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">CONSTANT</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADDITION_ONLY</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">OPT_OUT</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">REQUIRED_SCRUBBER</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">))</span>

    <span class="nd">@src_flags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">src_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PK</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADD_SRC_HASH</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">DEFINES_PRIMARY_PIDS</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">MASTER_PID</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">CONSTANT</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADDITION_ONLY</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">OPT_OUT</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span> <span class="o">=</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">REQUIRED_SCRUBBER</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inclusion_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># for TSV output</span>

    <span class="nd">@inclusion_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">inclusion_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exclusion_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusion_values</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># for TSV output</span>

    <span class="nd">@exclusion_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">exclusion_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exclusion_values</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exclusion_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alter_method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the alter_method field from the working fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">required_scrubber</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span>

    <span class="nd">@alter_method</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alter_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the alter_method field (from the data dictionary) to a bunch of</span>
<span class="sd">        boolean/simple fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the list of elements in the user&#39;s order.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                       <span class="n">text_value</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
        <span class="c1"># Now establish order. Text extraction first; everything else in order.</span>
        <span class="n">text_extraction_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">am</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">methods</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_text</span><span class="p">:</span>
                <span class="n">text_extraction_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">text_extraction_indices</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># Go in reverse order of index.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">methods</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">methods</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="c1"># Now, checks:</span>
        <span class="n">have_text_extraction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">have_truncate_date</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">am</span><span class="o">.</span><span class="n">truncate_date</span> <span class="ow">and</span> <span class="n">have_truncate_date</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Date truncation must stand alone in &quot;</span>
                                 <span class="s2">&quot;alter_method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_text</span> <span class="ow">and</span> <span class="n">have_text_extraction</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only have one text extraction method in &quot;</span>
                                 <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">truncate_date</span><span class="p">:</span>
                <span class="n">have_truncate_date</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_text</span><span class="p">:</span>
                <span class="n">have_text_extraction</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_file</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">decision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">OMIT</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="k">else</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">INCLUDE</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@decision</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="n">e</span> <span class="ow">is</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">OMIT</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;decision was </span><span class="si">{}</span><span class="s2">; must be one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="p">[</span><span class="n">DECISION</span><span class="o">.</span><span class="n">OMIT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">INCLUDE</span><span class="o">.</span><span class="n">value</span><span class="p">]))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Comparisons</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">DDR_FWD_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">matches_tabledef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tabledef</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">crate_anon</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">matches_tabledef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="n">tabledef</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matches_fielddef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fielddef</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">crate_anon</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">,</span> <span class="n">fielddef</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Representations</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">DataDictionaryRow</span><span class="o">.</span><span class="n">ROWNAMES</span><span class="p">])</span>

<div class="viewcode-block" id="DataDictionaryRow.get_signature"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow.get_signature">[docs]</a>    <span class="k">def</span> <span class="nf">get_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a signature based on the source database/table/field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_dest_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_offender_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">offenderdest</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="k">else</span> <span class="s2">&quot; -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_dest_signature</span><span class="p">())</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_signature</span><span class="p">(),</span> <span class="n">offenderdest</span><span class="p">)</span>

<div class="viewcode-block" id="DataDictionaryRow.get_tsv"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow.get_tsv">[docs]</a>    <span class="k">def</span> <span class="nf">get_tsv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a TSV row for writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DataDictionaryRow</span><span class="o">.</span><span class="n">ROWNAMES</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Setting</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="DataDictionaryRow.set_from_dict"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow.set_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set internal fields from a dict of elements representing a row from the</span>
<span class="sd">        TSV data dictionary file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;src_db&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;src_table&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;src_field&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_datatype</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;src_datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_flags</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;src_flags&#39;</span><span class="p">]</span>  <span class="c1"># a property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="n">SCRUBSRC</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;scrub_src&#39;</span><span class="p">],</span>
                                         <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;scrub_method&#39;</span><span class="p">],</span>
                                               <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;decision&#39;</span><span class="p">]</span>  <span class="c1"># a property; sets self.omit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inclusion_values</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;inclusion_values&#39;</span><span class="p">]</span>  <span class="c1"># a property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclusion_values</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;exclusion_values&#39;</span><span class="p">]</span>  <span class="c1"># a property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alter_method</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;alter_method&#39;</span><span class="p">]</span>  <span class="c1"># a property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;dest_table&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;dest_field&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;dest_datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexlen</span> <span class="o">=</span> <span class="n">convert_to_int</span><span class="p">(</span><span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;indexlen&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_file</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Anonymisation decisions</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">being_scrubbed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">am</span><span class="o">.</span><span class="n">scrub</span> <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contains_patient_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contains_vital_patient_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># return not self.omit or self.contains_patient_info()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_vital_patient_info</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">skip_row_by_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inclusion_values</span><span class="p">:</span>
            <span class="c1"># log.debug(&quot;skipping row based on inclusion_values&quot;)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusion_values</span><span class="p">:</span>
            <span class="c1"># log.debug(&quot;skipping row based on exclusion_values&quot;)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_alter_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AlterMethod</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span>

    <span class="k">def</span> <span class="nf">skip_row_if_extract_text_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">skip_if_text_extract_fails</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_extracting_text_altermethods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AlterMethod</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">am</span> <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span> <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_text</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_scrub_from_alter_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;remove_scrub_from_alter_methods &quot;</span>
            <span class="s2">&quot;[used for non-patient tables]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">sm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">:</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">scrub</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Other decisions</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">using_fulltext_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">FULLTEXT</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># SQLAlchemy types</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">get_src_sqla_coltype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeEngine</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_sqla_coltype</span> <span class="ow">or</span> <span class="n">get_sqla_coltype_from_dialect_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_datatype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_src_dialect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_db</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_src_sqla_coltype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqla_coltype</span><span class="p">:</span> <span class="n">TypeEngine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_sqla_coltype</span> <span class="o">=</span> <span class="n">sqla_coltype</span>

    <span class="k">def</span> <span class="nf">get_dest_sqla_coltype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeEngine</span><span class="p">:</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_dest_dialect</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span><span class="p">:</span>
            <span class="c1"># User (or our autogeneration process) wants to override</span>
            <span class="c1"># the type.</span>
            <span class="k">return</span> <span class="n">get_sqla_coltype_from_dialect_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span><span class="p">,</span>
                                                     <span class="n">dialect</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return the SQLAlchemy column type class determined from the</span>
            <span class="c1"># source database by reflection.</span>
            <span class="c1"># Will be autoconverted to the destination dialect.</span>
            <span class="c1"># With some exceptions, addressed as below:</span>
            <span class="k">return</span> <span class="n">convert_sqla_type_for_dialect</span><span class="p">(</span>
                <span class="n">coltype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_src_sqla_coltype</span><span class="p">(),</span>
                <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
                <span class="n">expand_for_scrubbing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">being_scrubbed</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_dest_sqla_column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span>
        <span class="n">coltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dest_sqla_coltype</span><span class="p">()</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span>
            <span class="c1"># When SQLAlchemy 1.2 released, add this:</span>
            <span class="c1"># &#39;comment&#39;: comment,</span>
            <span class="c1"># https://bitbucket.org/zzzeek/sqlalchemy/issues/1546/feature-request-commenting-db-objects  # noqa</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;primary_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;autoincrement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_pid</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nullable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">coltype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Validation</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="DataDictionaryRow.check_valid"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow.check_valid">[docs]</a>    <span class="k">def</span> <span class="nf">check_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check internal validity and complain if invalid, showing the source</span>
<span class="sd">        of the problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_valid</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Offending DD row [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_offender_description</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">raise</span></div>

    <span class="k">def</span> <span class="nf">check_prohibited_fieldnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Offending DD row [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_offender_description</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prohibited dest_field name&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check internal validity and complain if invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span><span class="p">,</span> <span class="s2">&quot;Need src_db&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="s2">&quot;Need src_table&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">,</span> <span class="s2">&quot;Need src_field&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_datatype</span><span class="p">,</span> <span class="s2">&quot;Need src_datatype&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="p">,</span> <span class="s2">&quot;Need dest_table&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="p">,</span> <span class="s2">&quot;Need dest_field&quot;</span>
        <span class="n">src_sqla_coltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_src_sqla_coltype</span><span class="p">()</span>
        <span class="n">dest_sqla_coltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dest_sqla_coltype</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_source_db_names</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Data dictionary row references non-existent source &quot;</span>
                <span class="s2">&quot;database&quot;</span><span class="p">)</span>
        <span class="n">srccfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_db</span><span class="p">]</span><span class="o">.</span><span class="n">srccfg</span>
        <span class="n">ensure_valid_table_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">)</span>
        <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_IDENTIFIER_LENGTH</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Table name in </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> is too long for MySQL (</span><span class="si">{}</span><span class="s2"> characters &gt; &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">),</span> <span class="n">MAX_IDENTIFIER_LENGTH</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_IDENTIFIER_LENGTH</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Field name in </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> is too long for MySQL (</span><span class="si">{}</span><span class="s2"> characters &gt; &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">),</span> <span class="n">MAX_IDENTIFIER_LENGTH</span><span class="p">))</span>

        <span class="c1"># REMOVED 2016-06-04; fails with complex SQL Server types, which can</span>
        <span class="c1"># look like &#39;NVARCHAR(10) COLLATE &quot;Latin1_General_CI_AS&quot;&#39;.</span>
        <span class="c1">#</span>
        <span class="c1"># if not is_sqltype_valid(self.src_datatype):</span>
        <span class="c1">#     raise ValueError(</span>
        <span class="c1">#         &quot;Field has invalid source data type: {}&quot;.format(</span>
        <span class="c1">#             self.src_datatype))</span>

        <span class="c1"># 2016-11-11: error message clarified</span>
        <span class="c1"># 2017-05-06: check removed; we can now handle non-integer PIDs</span>
        <span class="c1">#</span>
        <span class="c1"># if ((self._primary_pid or self._master_pid) and</span>
        <span class="c1">#         not is_sqltype_integer(self.src_datatype)):</span>
        <span class="c1">#     raise ValueError(</span>
        <span class="c1">#         &quot;For {}: All fields with src_flags={} or src_flags={} set &quot;</span>
        <span class="c1">#         &quot;should be integer, (a) for work distribution purposes, and &quot;</span>
        <span class="c1">#         &quot;(b) so we know the structure of our secret mapping table &quot;</span>
        <span class="c1">#         &quot;in advance.&quot;.format(self.src_field,</span>
        <span class="c1">#                              SRCFLAG.PRIMARY_PID,</span>
        <span class="c1">#                              SRCFLAG.MASTER_PID))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All fields with src_flags=</span><span class="si">{}</span><span class="s2"> set must have src_flags=</span><span class="si">{}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SRCFLAG</span><span class="o">.</span><span class="n">DEFINES_PRIMARY_PIDS</span><span class="p">,</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optout_col_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Fields with src_flags=</span><span class="si">{}</span><span class="s2"> exist, but config&#39;s &quot;</span>
                <span class="s2">&quot;optout_col_values setting is empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SRCFLAG</span><span class="o">.</span><span class="n">OPT_OUT</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">count_bool</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">,</span>
                       <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alter_method</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Field can be any ONE of: src_flags=</span><span class="si">{}</span><span class="s2">, src_flags=</span><span class="si">{}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;alter_method&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span><span class="p">,</span> <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">MASTER_PID</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you specify src_flags=</span><span class="si">{}</span><span class="s2">, you must specify &quot;</span>
                             <span class="s2">&quot;scrub_src&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SRCFLAG</span><span class="o">.</span><span class="n">REQUIRED_SCRUBBER</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> can only be set on &quot;</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> fields&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADD_SRC_HASH</span><span class="p">,</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PK</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> fields require index==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADD_SRC_HASH</span><span class="p">,</span>
                        <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;cannot mix </span><span class="si">{}</span><span class="s2"> flag with </span><span class="si">{}</span><span class="s2"> flag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">ADD_SRC_HASH</span><span class="p">,</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">CONSTANT</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> can only be set on &quot;</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> fields&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">CONSTANT</span><span class="p">,</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PK</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;src_flags=</span><span class="si">{}</span><span class="s2"> fields require index==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">CONSTANT</span><span class="p">,</span>
                        <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Below here: checks only applying to non-omitted columns</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">ensure_valid_table_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Destination tables can&#39;t be named </span><span class="si">{}</span><span class="s2">, as that&#39;s the &quot;</span>
                <span class="s2">&quot;name set in the config&#39;s temporary_tablename &quot;</span>
                <span class="s2">&quot;variable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">))</span>
        <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Destination fields can&#39;t be named </span><span class="si">{}</span><span class="s2">, as that&#39;s the &quot;</span>
                <span class="s2">&quot;name set in the config&#39;s source_hash_fieldname &quot;</span>
                <span class="s2">&quot;variable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_sqltype_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Field has invalid destination data type: &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">srccfg</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;All fields with src_field=</span><span class="si">{}</span><span class="s2"> used in output should &quot;</span>
                    <span class="s2">&quot;have src_flag=</span><span class="si">{}</span><span class="s2"> set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_field</span><span class="p">,</span>
                                                  <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">research_id_fieldname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Primary PID field should have &quot;</span>
                    <span class="s2">&quot;dest_field = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">research_id_fieldname</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">srccfg</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All fields with src_field = </span><span class="si">{}</span><span class="s2"> used in output should have&quot;</span>
                <span class="s2">&quot; src_flags=</span><span class="si">{}</span><span class="s2"> set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">srccfg</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">,</span>
                    <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">MASTER_PID</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">truncate_date</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_sqlatype_date</span><span class="p">(</span><span class="n">src_sqla_coltype</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">is_sqlatype_text_over_one_char</span><span class="p">(</span><span class="n">src_sqla_coltype</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t set truncate_date for &quot;</span>
                                     <span class="s2">&quot;non-date/non-text field&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_from_filename</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sqlatype_text_over_one_char</span><span class="p">(</span><span class="n">src_sqla_coltype</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;For alter_method = &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{ALTERMETHOD.FILENAME_TO_TEXT}</span><span class="s2">, source field &quot;</span>
                        <span class="s2">&quot;must contain a filename and therefore &quot;</span>
                        <span class="s2">&quot;must be text type of &gt;1 character&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ALTERMETHOD</span><span class="o">=</span><span class="n">ALTERMETHOD</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">am</span><span class="o">.</span><span class="n">extract_from_blob</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sqlatype_binary</span><span class="p">(</span><span class="n">src_sqla_coltype</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;For alter_method = </span><span class="si">{ALTERMETHOD.BINARY_TO_TEXT}</span><span class="s2">, &quot;</span>
                        <span class="s2">&quot;source field must be of binary type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ALTERMETHOD</span><span class="o">=</span><span class="n">ALTERMETHOD</span><span class="p">))</span>

        <span class="c1"># This error/warning too hard to be sure of with SQL Server odd</span>
        <span class="c1"># string types:</span>
        <span class="c1"># if self._scrub and not self._extract_text:</span>
        <span class="c1">#     if not is_sqltype_text_over_one_char(self.src_datatype):</span>
        <span class="c1">#         raise ValueError(&quot;Can&#39;t scrub in non-text field or &quot;</span>
        <span class="c1">#                          &quot;single-character text field&quot;)</span>

        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">!=</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sqltype_encrypted_pid_as_sql</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All src_flags=</span><span class="si">{}</span><span class="s2">/src_flags=</span><span class="si">{}</span><span class="s2"> fields used in output must &quot;</span>
                <span class="s2">&quot;have destination_datatype = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">PRIMARY_PID</span><span class="p">,</span>
                    <span class="n">SRCFLAG</span><span class="o">.</span><span class="n">MASTER_PID</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sqltype_encrypted_pid_as_sql</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="p">(</span><span class="n">INDEX</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indexlen</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">does_sqlatype_require_index_len</span><span class="p">(</span><span class="n">dest_sqla_coltype</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must specify indexlen to index a TEXT or BLOB field&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Other stuff requiring config or database info</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="DataDictionaryRow.set_from_src_db_info"><a class="viewcode-back" href="../../../autodoc/anonymise/ddr.html#crate_anon.anonymise.ddr.DataDictionaryRow.set_from_src_db_info">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_src_db_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">datatype_sqltext</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">sqla_coltype</span><span class="p">:</span> <span class="n">TypeEngine</span><span class="p">,</span>
                             <span class="n">dbconf</span><span class="p">:</span> <span class="n">DATABASE_SAFE_CONFIG_FWD_REF</span><span class="p">,</span>
                             <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a draft data dictionary row from a field in the source database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_datatype</span> <span class="o">=</span> <span class="n">datatype_sqltext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_sqla_coltype</span> <span class="o">=</span> <span class="n">sqla_coltype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_file</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Is the field special, such as a PK?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_pk_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_constant_content</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">matches_tabledef</span><span class="p">(</span>
                     <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_constant_content_tables</span><span class="p">))</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_tabledef</span><span class="p">(</span>
                    <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_nonconstant_content_tables</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_src_hash</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addition_only</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_addition_only</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">matches_tabledef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_addition_only_tables</span><span class="p">))</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_tabledef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_deletion_possible_tables</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_pid_defining_fieldnames</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Does it indicate the patient wishes to opt out entirely?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_patient_opt_out_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_opt_out_info</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Does the field contain sensitive data?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">and</span>
                 <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_add_per_table_pids_to_scrubber</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubsrc_patient_fields</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="n">SCRUBSRC</span><span class="o">.</span><span class="n">PATIENT</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubsrc_thirdparty_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="n">SCRUBSRC</span><span class="o">.</span><span class="n">THIRDPARTY</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span>
                <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubsrc_thirdparty_xref_pid_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="n">SCRUBSRC</span><span class="o">.</span><span class="n">THIRDPARTY_XREF_PID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Is it a mandatory scrubbing field?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_required_scrubsrc_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required_scrubber</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># What kind of sensitive data? Date, text, number, code?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span> <span class="ow">is</span> <span class="n">SCRUBSRC</span><span class="o">.</span><span class="n">THIRDPARTY_XREF_PID</span> <span class="ow">or</span>
                <span class="n">is_sqlatype_numeric</span><span class="p">(</span><span class="n">sqla_coltype</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubmethod_number_fields</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">NUMERIC</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">is_sqlatype_date</span><span class="p">(</span><span class="n">sqla_coltype</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubmethod_date_fields</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">DATE</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubmethod_code_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">CODE</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_scrubmethod_phrase_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">PHRASE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrub_method</span> <span class="o">=</span> <span class="n">SCRUBMETHOD</span><span class="o">.</span><span class="n">WORDS</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do we want to change the destination fieldname?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">research_id_fieldname</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_research_id_fieldname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="k">if</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_force_lower_case</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_convert_odd_chars_to_underscore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="p">)</span>  <span class="c1"># if this fails,</span>
            <span class="c1"># there&#39;s a Unicode problem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ODD_CHARS_TRANSLATE</span><span class="p">)</span>
            <span class="c1"># ... this will choke on a Unicode string</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Do we want to change the destination field SQL type?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sqltype_encrypted_pid_as_sql</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># ... and see also potential changes made below</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># How should we manipulate the destination?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">extracting_text</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_truncate_date_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                                   <span class="n">truncate_date</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_filename_to_text_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                                   <span class="n">extract_from_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="n">giant_text_sqltype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_dest_dialect</span><span class="p">())</span>
            <span class="n">extracting_text</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">bin2text_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">binfielddef</span><span class="p">,</span> <span class="n">extfield</span> <span class="ow">in</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">bin2text_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">binfielddef</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span>
                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                        <span class="n">extract_from_blob</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">extract_ext_field</span><span class="o">=</span><span class="n">extfield</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_datatype</span> <span class="o">=</span> <span class="n">giant_text_sqltype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_dest_dialect</span><span class="p">())</span>
            <span class="n">extracting_text</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">and</span>
              <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="ow">and</span>
              <span class="n">is_sqlatype_text_of_length_at_least</span><span class="p">(</span>
                  <span class="n">sqla_coltype</span><span class="p">,</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_min_length_for_scrubbing</span><span class="p">)</span> <span class="ow">and</span>
              <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span>
                  <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_safe_fields_exempt_from_scrubbing</span><span class="p">)):</span>
            <span class="c1"># Text field meeting the criteria to scrub</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                                   <span class="n">scrub</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extracting_text</span><span class="p">:</span>
            <span class="c1"># Scrub all extract-text fields, unless asked not to</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span>
                    <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_safe_fields_exempt_from_scrubbing</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                                       <span class="n">scrub</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="c1"># Set skip_if_text_extract_fails flag?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span>
                    <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_skip_row_if_extract_text_fails_fields</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">skip_if_text_extract_fails</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">fieldspec</span><span class="p">,</span> <span class="n">cfg_section</span> <span class="ow">in</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_extra_hash_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">fieldspec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlterMethod</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">hash_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">hash_config_section</span><span class="o">=</span><span class="n">cfg_section</span>
                <span class="p">))</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Manipulate the destination table name?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># http://stackoverflow.com/questions/10017147</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">if</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_force_lower_case</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_convert_odd_chars_to_underscore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="p">)</span>
            <span class="c1"># ... if this fails, there&#39;s a Unicode problem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ODD_CHARS_TRANSLATE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_rename_tables_remove_suffixes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_table</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>  <span class="c1"># remove it</span>
                <span class="k">break</span>  <span class="c1"># only remove one suffix!</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Should we index the destination?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">dest_sqla_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dest_sqla_coltype</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">UNIQUE</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">or</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span> <span class="ow">or</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_defines_primary_pids</span> <span class="ow">or</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">dest_field</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">research_id_fieldname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">NORMAL</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_allow_fulltext_indexing</span> <span class="ow">and</span>
              <span class="n">does_sqlatype_merit_fulltext_index</span><span class="p">(</span><span class="n">dest_sqla_type</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">FULLTEXT</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_index_fields</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">NORMAL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indexlen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DEFAULT_INDEX_LEN</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">INDEX</span><span class="o">.</span><span class="n">FULLTEXT</span> <span class="ow">and</span>
                <span class="n">does_sqlatype_require_index_len</span><span class="p">(</span><span class="n">dest_sqla_type</span><span class="p">))</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Should we omit it (at least until a human has looked at the DD)?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># In descending order of priority:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_omit_fields</span><span class="p">):</span>  <span class="c1"># explicit</span>
            <span class="c1"># Explicit omission trumps everything else</span>
            <span class="c1"># (There are rare occasions with &quot;additional&quot; databases where we</span>
            <span class="c1"># may want to omit a PK/PID/MPID field.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_pid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_pid</span><span class="p">:</span>
            <span class="c1"># We always want PKs, and the translated PID/MPID (RID+TRID or</span>
            <span class="c1"># MRID respectively).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_src</span><span class="p">):</span>
            <span class="c1"># Scrub-source fields are generally sensitive and therefore worthy</span>
            <span class="c1"># of omission, EXCEPT that if a date is marked for truncation, the</span>
            <span class="c1"># user probably wants it (truncated) to come through!</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">am</span><span class="o">.</span><span class="n">truncate_date</span> <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_methods</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_fielddef</span><span class="p">(</span><span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_include_fields</span><span class="p">):</span>  <span class="c1"># explicit</span>
            <span class="c1"># Explicit inclusion next.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="n">dbconf</span><span class="o">.</span><span class="n">ddgen_omit_by_default</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>