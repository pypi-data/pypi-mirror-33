
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.nlp_manager.parse_medex &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.nlp_manager.parse_medex</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/nlp_manager/parse_medex.py</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">- MedEx-UIMA</span>
<span class="sd">  ... can&#39;t find Python version of MedEx (which preceded MedEx-UIMA)</span>
<span class="sd">  ... paper on Python version is https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2995636/</span>
<span class="sd">        ... uses Python NLTK</span>
<span class="sd">  ... see notes in Documents/CRATE directory</span>
<span class="sd">  ... MedEx-UIMA is in Java, and resolutely uses a file-based processing</span>
<span class="sd">      system; Main.java calls MedTagger.java (MedTagger.run_batch_medtag), and</span>
<span class="sd">      even in its core MedTagger.medtagging() function it&#39;s making files in</span>
<span class="sd">      directories; that&#39;s deep in the core of its NLP thinking so we can&#39;t</span>
<span class="sd">      change that behaviour without creating a fork.</span>
<span class="sd">      So the obvious way to turn this into a proper &quot;live&quot; pipeline would be</span>
<span class="sd">      for the calling code to</span>
<span class="sd">            fire up a receiving process - Python launching custom Java</span>
<span class="sd">            create its own temporary directory - Python</span>
<span class="sd">            receive data - Python</span>
<span class="sd">            stash it on disk - Python</span>
<span class="sd">            call the MedEx function - Python -&gt; stdout -&gt; custom Java -&gt; MedEx</span>
<span class="sd">            return the results - custom Java signals &quot;done&quot; -&gt; Python reads stdin?</span>
<span class="sd">            and clean up - Python</span>
<span class="sd">      Not terribly elegant, but might be fast enough (and almost certainly</span>
<span class="sd">      much faster than reloading Java regularly!).</span>
<span class="sd">  ... output comes from its MedTagger.print_result() function</span>
<span class="sd">  ... would need a per-process-unique temporary directory, since it scans all</span>
<span class="sd">      files in the input directory (and similarly one output directory); would</span>
<span class="sd">      do that in Python</span>


<span class="sd">MedEx-UIMA is firmly (and internally) wedded to a file-based processing</span>
<span class="sd">system. So we need to:</span>

<span class="sd">    - create a process-specific pair of temporary directories;</span>
<span class="sd">    - fire up a receiving process</span>
<span class="sd">    - pass data (1) to file and (2) signal that there&#39;s data available;</span>
<span class="sd">    - await a &quot;data ready&quot; reply and read the data from disk;</span>
<span class="sd">    - clean up (delete files) in readiness for next data chunk.</span>

<span class="sd">NOTE ALSO that MedEx&#39;s MedTagger class writes to stdout (though not</span>
<span class="sd">stderr). Option 1: move our logs to stdout and use stderr for signalling.</span>
<span class="sd">Option 2: keep things as they are and just use a stdout signal that&#39;s</span>
<span class="sd">not used by MedEx. Went with option 2; simpler and more consistent esp.</span>
<span class="sd">for logging.</span>

<span class="sd">How do we clean up the temporary directories?</span>
<span class="sd">- __del__ is not the opposite of __init__</span>
<span class="sd">  http://www.algorithm.co.il/blogs/programming/python-gotchas-1-__del__-is-not-the-opposite-of-__init__/</span>
<span class="sd">- http://eli.thegreenplace.net/2009/06/12/safely-using-destructors-in-python  # noqa</span>

<span class="sd">PROBLEMS:</span>
<span class="sd">-   NLP works fine, but UK-style abbreviations e.g. &quot;qds&quot; not recognized where</span>
<span class="sd">    &quot;q.i.d.&quot; is. US abbreviations: e.g.</span>
<span class="sd">    http://www.d.umn.edu/medweb/Modules/Prescription/Abbreviations.html</span>

<span class="sd">    Places to look, and things to try adding:</span>

<span class="sd">        resources/TIMEX/norm_patterns/NormFREQword</span>

<span class="sd">            qds=&gt;R1P6H</span>

<span class="sd">        resources/TIMEX/rules/frequency_rules</span>

<span class="sd">            //QID ( 4 times a day</span>
<span class="sd">            expression=&quot;[Qq]\.?[Ii]\.?[Dd]\.?[ ]*\((.*?)\)&quot;,val=&quot;R1P6H&quot;</span>

<span class="sd">            // RNC: qds</span>
<span class="sd">            expression=&quot;[Qq]\.?[Dd]\.?[Ss]\.?[ ]*\((.*?)\)&quot;,val=&quot;R1P6H&quot;</span>

<span class="sd">        ... looked like it was correct, but not working</span>
<span class="sd">        ... are this files compiled in, rather than being read live?</span>
<span class="sd">        ... do I have the user or the developer version?</span>

<span class="sd">    ... not there yet.</span>
<span class="sd">    Probably need to recompile. See MedEx&#39;s Readme.txt</span>

<span class="sd">    reference to expression/val (as in frequency_rules)</span>
<span class="sd">    TIMEX.Rule._add_rule()</span>
<span class="sd">        ... from TIMEX.Rule.Rule via a directory walker</span>
<span class="sd">        ... from TIMEX.ProcessingEngine.ProcessingEngine()</span>
<span class="sd">            ... via semi-hardcoded file location relative to class&#39;s location</span>
<span class="sd">                ... via rule_dir, set to .../TIMEX/rules</span>

<span class="sd">    Detect a file being accessed:</span>

<span class="sd">        sudo apt install inotify-tools</span>
<span class="sd">        inotifywait -m FILE</span>

<span class="sd">    ... frequency_rules IS opened.</span>

<span class="sd">    OVERALL SEQUENCE:</span>

<span class="sd">    org.apache.medex.Main [OR: CrateNedexPipeline.java]</span>
<span class="sd">    org.apache.medex.MedTagger.run_batch_medtag</span>
<span class="sd">    ... creeates an org.apache.NLPTools.Document</span>
<span class="sd">        ... not obviously doing frequency stuff, or drug recognition</span>
<span class="sd">    ... then runs org.apache.medex.MedTagger.medtagging(doc)</span>
<span class="sd">        ... this does most of the heavy lifting, I think</span>
<span class="sd">        ... uses ProcessingEngine freq_norm_engine</span>
<span class="sd">            ... org.apache.TIMEX.ProcessingEngine</span>
<span class="sd">            ... but it may be that this just does frequency NORMALIZATION, not frequency finding</span>
<span class="sd">        ... uses SemanticRuleEngine rule_engine</span>
<span class="sd">            ... which is org.apache.medex.SemanticRuleEngine</span>
<span class="sd">            ... see all the regexlist.put(..., &quot;FREQ&quot;) calls</span>
<span class="sd">            ... note double-escaping \\ for Java&#39;s benefit</span>

<span class="sd">-   Rebuilding MedEx:</span>

<span class="sd">    export MEDEX_HOME=~/dev/MedEx_UIMA_1.3.6  # or similar</span>
<span class="sd">    cd ${MEDEX_HOME}</span>
<span class="sd">    # OPTIONAL # find . -name &quot;*.class&quot; -exec rm {} \;  # remove old compiled files</span>
<span class="sd">    javac \</span>
<span class="sd">        -classpath &quot;${MEDEX_HOME}/src:${MEDEX_HOME}/lib/*&quot; \</span>
<span class="sd">        src/org/apache/medex/Main.java \</span>
<span class="sd">        -d bin</span>

<span class="sd">    # ... will also compile dependencies</span>

<span class="sd">    See build_medex_itself.py</span>

<span class="sd">-   YES. If you add to org.apache.medex.SemanticRuleEngine, with extra entries</span>
<span class="sd">    in the &quot;regexlist.put(...)&quot; sequence, new frequencies appear in the output.</span>

<span class="sd">    To get them normalized as well, add them to frequency_rules.</span>

<span class="sd">    Specifics:</span>
<span class="sd">    (a) SemanticRuleEngine.java</span>

<span class="sd">        // EXTRA FOR UK FREQUENCIES (see http://www.evidence.nhs.uk/formulary/bnf/current/general-reference/latin-abbreviations)</span>
<span class="sd">        // NB case-insensitive regexes in SemanticRuleEngine.java, so ignore case here</span>
<span class="sd">        regexlist.put(&quot;^(q\\.?q\\.?h\\.?)( |$)&quot;, &quot;FREQ&quot;);  // qqh, quarta quaque hora (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(q\\.?d\\.?s\\.?)( |$)&quot;, &quot;FREQ&quot;);  // qds, quater die sumendum (RNC); must go before existing competing expression: regexlist.put(&quot;^q(\\.|)\\d+( |$)&quot;,&quot;FREQ&quot;);</span>
<span class="sd">        regexlist.put(&quot;^(t\\.?d\\.?s\\.?)( |$)&quot;, &quot;FREQ&quot;);  // tds, ter die sumendum (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(b\\.?d\\.?)( |$)&quot;, &quot;FREQ&quot;);  // bd, bis die (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(o\\.?d\\.?)( |$)&quot;, &quot;FREQ&quot;);  // od, omni die (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(mane)( |$)&quot;, &quot;FREQ&quot;);  // mane (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(o\\.?m\\.?)( |$)&quot;, &quot;FREQ&quot;);  // om, omni mane (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(nocte)( |$)&quot;, &quot;FREQ&quot;);  // nocte (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(o\\.?n\\.?)( |$)&quot;, &quot;FREQ&quot;);  // on, omni nocte (RNC)</span>
<span class="sd">        regexlist.put(&quot;^(fortnightly)( |$)&quot;, &quot;FREQ&quot;);  // fortnightly (RNC)</span>
<span class="sd">        regexlist.put(&quot;^((?:2|two)\s+weekly)\b&quot;, &quot;FREQ&quot;);  // fortnightly (RNC)</span>
<span class="sd">        regexlist.put(&quot;argh&quot;, &quot;FREQ&quot;);  // fortnightly (RNC)</span>
<span class="sd">        // ALREADY IMPLEMENTED BY MedEx: tid (ter in die)</span>
<span class="sd">        // NECESSITY, NOT FREQUENCY: prn (pro re nata)</span>
<span class="sd">        // TIMING, NOT FREQUENCY: ac (ante cibum); pc (post cibum)</span>

<span class="sd">    (b) frequency_rules</span>

<span class="sd">// EXTRA FOR UK FREQUENCIES (see http://www.evidence.nhs.uk/formulary/bnf/current/general-reference/latin-abbreviations)</span>
<span class="sd">// NB case-sensitive regexes in Rule.java, so offer upper- and lower-case alternatives here</span>
<span class="sd">// qqh, quarta quaque hora (RNC)</span>
<span class="sd">expression=&quot;\b[Qq]\.?[Qq]\.?[Hh]\.?\b&quot;,val=&quot;R1P4H&quot;</span>
<span class="sd">// qds, quater die sumendum (RNC); MUST BE BEFORE COMPETING &quot;qd&quot; (= per day) expression: expression=&quot;[Qq]\.?[ ]?[Dd]\.?&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">expression=&quot;\b[Qq]\.?[Dd]\.?[Ss]\.?\b&quot;,val=&quot;R1P6H&quot;</span>
<span class="sd">// tds, ter die sumendum (RNC)</span>
<span class="sd">expression=&quot;\b[Tt]\.?[Dd]\.?[Ss]\.?\b&quot;,val=&quot;R1P8H&quot;</span>
<span class="sd">// bd, bis die (RNC)</span>
<span class="sd">expression=&quot;\b[Bb]\.?[Dd]\.?\b&quot;,val=&quot;R1P12H&quot;</span>
<span class="sd">// od, omni die (RNC)</span>
<span class="sd">expression=&quot;\b[Oo]\.?[Dd]\.?\b&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">// mane (RNC)</span>
<span class="sd">expression=&quot;\b[Mm][Aa][Nn][Ee]\b&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">// om, omni mane (RNC)</span>
<span class="sd">expression=&quot;\b[Oo]\.?[Mm]\.?\b&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">// nocte (RNC)</span>
<span class="sd">expression=&quot;\b[Nn][Oo][Cc][Tt][Ee]\b&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">// on, omni nocte (RNC)</span>
<span class="sd">expression=&quot;\b[Oo]\.?[Nn]\.?\b&quot;,val=&quot;R1P24H&quot;</span>
<span class="sd">// fortnightly and variants (RNC); unsure if TIMEX3 format is right</span>
<span class="sd">expression=&quot;\b[Ff][Oo][Rr][Tt][Nn][Ii][Gg][Hh][Tt][Ll][Yy]\b&quot;,val=&quot;R1P2WEEK&quot;</span>
<span class="sd">expression=&quot;\b(?:2|[Tt][Ww][Oo])\s+[Ww][Ee][Ee][Kk][Ll][Yy]\b&quot;,val=&quot;R1P2WEEK&quot;</span>
<span class="sd">// monthly (RNC)</span>
<span class="sd">expression=&quot;\b[Mm][Oo][Nn][Tt][Hh][Ll][Yy]\b&quot;,val=&quot;R1P1MONTH&quot;</span>
<span class="sd">//</span>
<span class="sd">// ALREADY IMPLEMENTED BY MedEx: tid (ter in die)</span>
<span class="sd">// NECESSITY, NOT FREQUENCY: prn (pro re nata)</span>
<span class="sd">// TIMING, NOT FREQUENCY: ac (ante cibum); pc (post cibum)</span>

<span class="sd">    (c) source:</span>

<span class="sd">        http://www.evidence.nhs.uk/formulary/bnf/current/general-reference/latin-abbreviations</span>

<span class="sd">-   How about routes of administration?</span>

<span class="sd">        MedTagger.printResult()</span>
<span class="sd">            route is in FStr_list[5]</span>
<span class="sd">        ... called from MedTagger.medtagging()</span>
<span class="sd">            route is in FStr_list_final[5]</span>
<span class="sd">            before that, is in FStr (separated by \n)</span>
<span class="sd">                ... from formatDruglist</span>
<span class="sd">                ...</span>
<span class="sd">                ... from logs, appears first next to &quot;input for tagger&quot; at</span>
<span class="sd">                    which point it&#39;s in</span>
<span class="sd">                        sent_token_array[j] (e.g. &quot;po&quot;)</span>
<span class="sd">                        sent_tag_array[j] (e.g. &quot;RUT&quot; = route)</span>
<span class="sd">                ... from tag_dict</span>
<span class="sd">                ... from filter_tags</span>
<span class="sd">                ... from (Document) doc.filtered_drug_tag()</span>
<span class="sd">                ...</span>
<span class="sd">                ... ?from MedTagger.medtagging() calling doc.add_drug_tag()</span>
<span class="sd">                ... no, not really; is in this bit:</span>
<span class="sd">                    SuffixArray sa = new SuffixArray(...);</span>
<span class="sd">                    Vector&lt;SuffixArrayResult&gt; result = sa.search();</span>
<span class="sd">                ... and then each element of result has a &quot;semantic_type&quot;</span>
<span class="sd">                    member that can be &quot;RUT&quot;</span>
<span class="sd">        ... SuffixArray.search()</span>
<span class="sd">            semantic_type=this.lex.sem_list().get(i);</span>

<span class="sd">            ... where lex comes from MedTagger:</span>
<span class="sd">                this.lex = new Lexicon(this.lex_fname);</span>
<span class="sd">        ... Lexicon.sem_list() returns Lexicon.semantic_list</span>
<span class="sd">            ... Lexicon.Lexicon() constructs using MedTagger&#39;s this.lex_fname</span>
<span class="sd">            ... which is lexicon.cfg</span>

<span class="sd">        ... aha! There it is. If a line in lexicon.cfg has a RUT tag, it&#39;ll</span>
<span class="sd">            appear as a route. So:</span>
<span class="sd">                grep &quot;RUT$&quot; lexicon.cfg | sort</span>

<span class="sd">            bedside	RUT</span>
<span class="sd">            by mouth	RUT</span>
<span class="sd">            drip	RUT</span>
<span class="sd">            gt	RUT</span>
<span class="sd">            g tube	RUT</span>
<span class="sd">            g-tube	RUT</span>
<span class="sd">            gtube	RUT</span>
<span class="sd">            im injection	RUT</span>
<span class="sd">            im	RUT</span>
<span class="sd">            inhalation	RUT</span>
<span class="sd">            inhalatn	RUT</span>
<span class="sd">            inhaled	RUT</span>
<span class="sd">            intramuscular	RUT</span>
<span class="sd">            intravenously	RUT</span>
<span class="sd">            intravenous	RUT</span>
<span class="sd">            iv	RUT</span>
<span class="sd">            j tube	RUT</span>
<span class="sd">            j-tube	RUT</span>
<span class="sd">            jtube	RUT</span>
<span class="sd">            nare	RUT</span>
<span class="sd">            nares	RUT</span>
<span class="sd">            naris	RUT</span>
<span class="sd">            neb	RUT</span>
<span class="sd">            nostril	RUT</span>
<span class="sd">            orally	RUT</span>
<span class="sd">            oral	RUT</span>
<span class="sd">            ou	RUT</span>
<span class="sd">            patch	DDF-DOSEUNIT-RUT</span>
<span class="sd">            per gt	RUT</span>
<span class="sd">            per mouth	RUT</span>
<span class="sd">            per os	RUT</span>
<span class="sd">            per rectum	RUT</span>
<span class="sd">            per tube	RUT</span>
<span class="sd">            p. g	RUT</span>
<span class="sd">            pgt	RUT</span>
<span class="sd">            png	RUT</span>
<span class="sd">            pnj	RUT</span>
<span class="sd">            p.o	RUT</span>
<span class="sd">            po	RUT</span>
<span class="sd">            sc	RUT</span>
<span class="sd">            sl	RUT</span>
<span class="sd">            sq	RUT</span>
<span class="sd">            subc	RUT</span>
<span class="sd">            subcu	RUT</span>
<span class="sd">            subcutaneously	RUT</span>
<span class="sd">            subcutaneous	RUT</span>
<span class="sd">            subcut	RUT</span>
<span class="sd">            subling	RUT</span>
<span class="sd">            sublingual	RUT</span>
<span class="sd">            sub q	RUT</span>
<span class="sd">            subq	RUT</span>
<span class="sd">            swallow	RUT</span>
<span class="sd">            swish and spit	RUT</span>
<span class="sd">            sw&amp;spit	RUT</span>
<span class="sd">            sw&amp;swall	RUT</span>
<span class="sd">            topically	RUT</span>
<span class="sd">            topical	RUT</span>
<span class="sd">            topical tp	RUT</span>
<span class="sd">            trans	RUT</span>
<span class="sd">            with spacer	RUT</span>

<span class="sd">    Looks like these are not using synonyms. Note also format is route\tRUT</span>
<span class="sd">    Note also that the first element is always forced to lower case (in</span>
<span class="sd">        Lexicon.Lexicon()), so presumably it&#39;s case-insensitive.</span>
<span class="sd">    There&#39;s no specific comment format (though any line that doesn&#39;t resolve</span>
<span class="sd">        to two items when split on a tab looks like it&#39;s ignored).</span>
<span class="sd">    So we might want to add more; use</span>

<span class="sd">        build_medex_itself.py --extraroutes &gt;&gt; lexicon.cfg</span>

<span class="sd">-   Note that all frequencies and routes must be in the lexicon.</span>
<span class="sd">    And all frequencies must be in SemanticRuleEngine.java (and, to be</span>
<span class="sd">    normalized, frequency_rules).</span>

<span class="sd">-   USEFUL BIT FOR CHECKING RESULTS:</span>

<span class="sd">    SELECT</span>
<span class="sd">        sentence_text,</span>
<span class="sd">        drug, generic_name,</span>
<span class="sd">        form, strength, dose_amount,</span>
<span class="sd">        route, frequency, frequency_timex3,</span>
<span class="sd">        duration, necessity</span>
<span class="sd">    FROM anonymous_output.drugs;</span>

<span class="sd">-   ENCODING</span>
<span class="sd">    - Pipe encoding (to Java&#39;s stdin, from Java&#39;s stdout) encoding is the less</span>
<span class="sd">      important as we&#39;re only likely to send/receive ASCII. It&#39;s hard-coded</span>
<span class="sd">      to UTF-8.</span>
<span class="sd">    - File encoding is vital and is hard-coded to UTF-8 here and in the</span>
<span class="sd">      receiving Java.</span>

<span class="sd">    - We have no direct influence over the MedTagger code for output (unless we</span>
<span class="sd">      modify it). The output function is MedTagger.print_result(), which</span>
<span class="sd">      (line 2040 of MedTagger.java) calls out.write(stuff).</span>
<span class="sd">      The out variable is set by</span>
<span class="sd">      			this.out = new BufferedWriter(new FileWriter(output_dir</span>
<span class="sd">					+ File.separator + doc.fname()));</span>
<span class="sd">      That form of the FileWriter constructor, FileWriter(String fileName),</span>
<span class="sd">      uses the &quot;default character encoding&quot;, as per</span>
<span class="sd">        https://docs.oracle.com/javase/7/docs/api/java/io/FileWriter.html</span>
<span class="sd">      That default is given by System.getProperty(&quot;file.encoding&quot;).</span>
<span class="sd">      However, we don&#39;t have to do something daft like asking the Java to</span>
<span class="sd">      report its file encoding to Python through a pipe; instead, we can set</span>
<span class="sd">      the Java default encoding. It can&#39;t be done dynamically, but it can be</span>
<span class="sd">      done at JVM launch:</span>
<span class="sd">        http://stackoverflow.com/questions/361975/setting-the-default-java-character-encoding</span>
<span class="sd">      Therefore, we should have a Java parameter specified in the config file</span>
<span class="sd">      as</span>
<span class="sd">            -Dfile.encoding=UTF-8</span>

<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.fileops</span> <span class="k">import</span> <span class="n">mkdir_p</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">from</span> <span class="nn">crate_anon.nlp_manager.base_nlp_parser</span> <span class="k">import</span> <span class="n">BaseNlpParser</span>
<span class="kn">from</span> <span class="nn">crate_anon.nlp_manager.constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">MEDEX_DATA_READY_SIGNAL</span><span class="p">,</span>
    <span class="n">MEDEX_RESULTS_READY_SIGNAL</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.nlp_manager.nlp_definition</span> <span class="k">import</span> <span class="n">NlpDefinition</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">DATA_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;crate_medex.txt&quot;</span>
<span class="n">DATA_FILENAME_KEEP</span> <span class="o">=</span> <span class="s2">&quot;crate_medex_</span><span class="si">{}</span><span class="s2">.txt&quot;</span>

<span class="n">USE_TEMP_DIRS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># ... True for production; False to see e.g. logs afterwards, by keeping</span>
<span class="c1"># everything in a subdirectory of the user&#39;s home directory (see hard-coded</span>
<span class="c1"># nastiness -- for debugging only)</span>

<span class="n">SKIP_IF_NO_GENERIC</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># ... Probably should be True. MedEx returns hits for drug &quot;Thu&quot; with no</span>
<span class="c1"># generic drug; this from its weekday lexicon, I think.</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Maximum field lengths</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># https://phekb.org/sites/phenotype/files/MedEx_UIMA_eMERGE_short.pdf</span>
<span class="c1">#</span>
<span class="c1"># RxNorm: https://www.nlm.nih.gov/research/umls/rxnorm/overview.html</span>
<span class="c1">#</span>
<span class="c1"># UMLS: https://www.nlm.nih.gov/research/umls/new_users/glossary.html</span>
<span class="c1"># UMLS CUI max length: https://www.nlm.nih.gov/research/umls/knowledge_sources/metathesaurus/release/columns_data_elements.html  # noqa</span>
<span class="n">UMLS_CUI_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># definite</span>

<span class="c1"># TIMEX3:</span>
<span class="c1"># - http://www.timeml.org/tempeval2/tempeval2-trial/guidelines/timex3guidelines-072009.pdf  # noqa</span>
<span class="c1"># - http://www.timeml.org/publications/timeMLdocs/timeml_1.2.1.html#timex3  # noqa</span>
<span class="n">TIMEX3_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>

<span class="c1"># Drug length:</span>
<span class="c1"># There are long ones, like</span>
<span class="c1">#   &quot;influenza virus vaccine, inactivated a-brisbane-59-2007, ivr-148 (h1n1) strain&quot; (78)  # noqa</span>
<span class="c1"># See e.g. resources/rxcui_generic.cfg, and:</span>
<span class="c1"># $ wc -L filename  # shows length of longest line</span>
<span class="c1"># $ egrep -n &quot;^.{$(wc -L &lt; filename)}$&quot; filename  # shows longest line</span>
<span class="c1">#   ... possibly this gets a bit confused by tabs, can also put a length in:</span>
<span class="c1"># $ egrep -n &quot;^.{302}$&quot; filename  # shows lines of length 302</span>
<span class="c1"># And we find a drug of length 286:</span>
<span class="c1">#   1-oxa-7-azacyclopentadecan-15-one,13-((2,6-dideoy-3-c-methyl-3-o-methyl-alpha-l-ribo-hexopyranosyl)oxy)-2-ethyl-3,4,10-trihydroxy 3,5,8,10,12,14-hexamethyl-7-propyl-11-((3,4,6-trideoxy-3-(dimethylamino)-beta-d-xylo-hexopyranosyl)oxy)-, ((2r*, 3s*,4r*,5s*,8r*,10r*,11r*,12s*,13s*,14r*))-  # noqa</span>
<span class="c1"># Then there are multivitamin things in brand_generic with length &gt;600.</span>
<span class="c1"># So we should use an unlimited field; SQLAlchemy helpfully seems to translate</span>
<span class="c1"># Text to VARCHAR(MAX) under SQL Server, which is the more efficient:</span>
<span class="c1"># http://stackoverflow.com/questions/834788/using-varcharmax-vs-text-on-sql-server  # noqa</span>
<span class="n">MEDEX_MAX_FORM_LENGTH</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># guess; &quot;Powder For Oral Suspension&quot; (26) is one</span>
<span class="n">MEDEX_MAX_STRENGTH_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>
<span class="n">MEDEX_MAX_DOSE_AMOUNT_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>
<span class="n">MEDEX_MAX_ROUTE_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>
<span class="n">MEDEX_MAX_FREQUENCY_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>
<span class="n">MEDEX_MAX_DURATION_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>
<span class="n">MEDEX_MAX_NECESSITY_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># guess</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Medex</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="PseudoTempDir"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.PseudoTempDir">[docs]</a><span class="k">class</span> <span class="nc">PseudoTempDir</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class exists so that a TemporaryDirectory and a manually specified</span>
<span class="sd">    directory can be addressed via the same (very simple!) interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Medex"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex">[docs]</a><span class="k">class</span> <span class="nc">Medex</span><span class="p">(</span><span class="n">BaseNlpParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class controlling a Medex-UIMA external process, via our custom</span>
<span class="sd">    Java interface, CrateMedexPipeline.java.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;MedEx&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">nlpdef</span><span class="p">:</span> <span class="n">NlpDefinition</span><span class="p">,</span>
                 <span class="n">cfgsection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">nlpdef</span><span class="o">=</span><span class="n">nlpdef</span><span class="p">,</span> <span class="n">cfgsection</span><span class="o">=</span><span class="n">cfgsection</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tablename</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">opt_str</span><span class="p">(</span>
            <span class="n">cfgsection</span><span class="p">,</span> <span class="s1">&#39;desttable&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_external_prog_uses</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">opt_int</span><span class="p">(</span>
            <span class="n">cfgsection</span><span class="p">,</span> <span class="s1">&#39;max_external_prog_uses&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_progenvsection</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">opt_str</span><span class="p">(</span><span class="n">cfgsection</span><span class="p">,</span> <span class="s1">&#39;progenvsection&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progenvsection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">get_env_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progenvsection</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;NLPLOGTAG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">get_logtag</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span>
        <span class="c1"># ... because passing a &quot;-lt&quot; switch with no parameter will make</span>
        <span class="c1"># CrateGatePipeline.java complain and stop</span>

        <span class="k">if</span> <span class="n">USE_TEMP_DIRS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outputdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="c1"># ... these are autodeleted when the object goes out of scope; see</span>
            <span class="c1">#     https://docs.python.org/3/library/tempfile.html</span>
            <span class="c1"># ... which manages it using weakref.finalize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">homedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputdir</span> <span class="o">=</span> <span class="n">PseudoTempDir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">homedir</span><span class="p">,</span> <span class="s2">&quot;medextemp&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">))</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outputdir</span> <span class="o">=</span> <span class="n">PseudoTempDir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">homedir</span><span class="p">,</span> <span class="s2">&quot;medextemp&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">))</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span> <span class="o">=</span> <span class="n">PseudoTempDir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">homedir</span><span class="p">,</span> <span class="s2">&quot;medextemp&quot;</span><span class="p">,</span> <span class="s2">&quot;working&quot;</span><span class="p">))</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">progargs</span> <span class="o">=</span> <span class="n">nlpdef</span><span class="o">.</span><span class="n">opt_str</span><span class="p">(</span><span class="n">cfgsection</span><span class="p">,</span> <span class="s1">&#39;progargs&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">formatted_progargs</span> <span class="o">=</span> <span class="n">progargs</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progargs</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">formatted_progargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progargs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;-data_ready_signal&quot;</span><span class="p">,</span> <span class="n">MEDEX_DATA_READY_SIGNAL</span><span class="p">,</span>
            <span class="s2">&quot;-results_ready_signal&quot;</span><span class="p">,</span> <span class="n">MEDEX_RESULTS_READY_SIGNAL</span><span class="p">,</span>
            <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_uses</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_encoding</span> <span class="o">=</span> <span class="s1">&#39;utf8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_encoding</span> <span class="o">=</span> <span class="s1">&#39;utf8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the subprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NLP class to talk to MedEx-UIMA, a medication-finding tool &quot;</span>
              <span class="s2">&quot;(https://www.ncbi.nlm.nih.gov/pubmed/25954575).&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># External process control</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch the external process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progargs</span>

        <span class="c1"># Nasty MedEx hacks</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;for MedEx&#39;s benefit, changing to directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">sentsdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;sents&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;making temporary sentences directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sentsdir</span><span class="p">))</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">sentsdir</span><span class="p">)</span>
        <span class="n">logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workingdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;making temporary log directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logdir</span><span class="p">))</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">logdir</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;launching command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
                                   <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                   <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                   <span class="c1"># stderr=subprocess.PIPE,</span>
                                   <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># ... don&#39;t ask for stderr to be piped if you don&#39;t want it; firstly,</span>
        <span class="c1"># there&#39;s a risk that if you don&#39;t consume it, something hangs, and</span>
        <span class="c1"># secondly if you don&#39;t consume it, you see it on the console, which is</span>
        <span class="c1"># helpful.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;returning to working directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cwd</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_encode_to_subproc_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send text to the external program (via its stdin), encoding it in</span>
<span class="sd">        the process (typically to UTF-8).&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SENDING: &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">bytes_</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipe_encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flush_subproc_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Flushes what we&#39;re sending to the external program via its stdin.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_decode_from_subproc_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Translate what we&#39;ve received from the external program&#39;s stdout,</span>
<span class="sd">        from its specific encoding (usually UTF-8) to a Python string.&quot;&quot;&quot;</span>
        <span class="n">bytes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">bytes_</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipe_encoding</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RECEIVING: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close down the external process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># close p.stdout, wait for the subprocess to exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_signal_data_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns: OK?&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encode_to_subproc_stdin</span><span class="p">(</span><span class="n">MEDEX_DATA_READY_SIGNAL</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_subproc_stdin</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_await_results_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns: ok?&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_from_subproc_stdout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">MEDEX_RESULTS_READY_SIGNAL</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">finished</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Input processing</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Medex.parse"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
                                            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Send text to the external process, and receive the result.</span>
<span class="sd">        - Note that associated data is not passed into this function, and is</span>
<span class="sd">          kept in the Python environment, so we can&#39;t run into any problems</span>
<span class="sd">          with the transfer to/from the Java program garbling important data.</span>
<span class="sd">          All we send to the subprocess is the text (and an input_terminator).</span>
<span class="sd">          Then, we may receive MULTIPLE sets of data back (&quot;your text contains</span>
<span class="sd">          the following 7 people/drug references/whatever&quot;), followed</span>
<span class="sd">          eventually by the output_terminator, at which point this set is</span>
<span class="sd">          complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_uses</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>  <span class="c1"># ensure started</span>
        <span class="k">if</span> <span class="n">USE_TEMP_DIRS</span><span class="p">:</span>
            <span class="n">basefilename</span> <span class="o">=</span> <span class="n">DATA_FILENAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basefilename</span> <span class="o">=</span> <span class="n">DATA_FILENAME_KEEP</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_uses</span><span class="p">)</span>
        <span class="n">inputfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">basefilename</span><span class="p">)</span>
        <span class="n">outputfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">basefilename</span><span class="p">)</span>
        <span class="c1"># ... MedEx gives output files the SAME NAME as input files.</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inputfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="c1"># log.critical(&quot;text: {}&quot;.format(repr(text)))</span>
            <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_data_ready</span><span class="p">()</span> <span class="ow">or</span>  <span class="c1"># send</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_await_results_ready</span><span class="p">()):</span>  <span class="c1"># receive</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Subprocess terminated unexpectedly&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">inputfilename</span><span class="p">)</span>
            <span class="c1"># We were using &quot;log.critical()&quot; and &quot;return&quot;, but if the Medex</span>
            <span class="c1"># processor is misconfigured, the failed processor can be run over</span>
            <span class="c1"># thousands of records over many hours before the failure is</span>
            <span class="c1"># obvious. Changed 2017-03-17.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Java interface to Medex failed - miconfigured?&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                  <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">resultlines</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">resultlines</span><span class="p">:</span>
            <span class="c1"># log.critical(&quot;received: {}&quot;.format(line))</span>
            <span class="c1"># Output code, from MedTagger.print_result():</span>
            <span class="c1"># out.write(</span>
            <span class="c1">#     index + 1 + &quot;\t&quot; + sent_text + &quot;|&quot; + drug + &quot;|&quot; + brand + &quot;|&quot;</span>
            <span class="c1">#     + dose_form + &quot;|&quot; + strength + &quot;|&quot; + dose_amt + &quot;|&quot; + route</span>
            <span class="c1">#     + &quot;|&quot; + frequency + &quot;|&quot; + duration + &quot;|&quot; + necessity + &quot;|&quot;</span>
            <span class="c1">#     + umls_code + &quot;|&quot; + rx_code + &quot;|&quot; + generic_code + &quot;|&quot; + generic_name + &quot;\n&quot;);  # noqa</span>
            <span class="c1"># NOTE that the text can contain | characters. So work from the</span>
            <span class="c1"># right.</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>  <span class="c1"># remove any trailing newline</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Bad result received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="n">generic_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_or_none</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generic_name</span> <span class="ow">and</span> <span class="n">SKIP_IF_NO_GENERIC</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">generic_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_or_none</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">rx_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_or_none</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">umls_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_or_none</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="p">(</span><span class="n">necessity</span><span class="p">,</span> <span class="n">necessity_startpos</span><span class="p">,</span> <span class="n">necessity_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>
            <span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">duration_startpos</span><span class="p">,</span> <span class="n">duration_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>
            <span class="p">(</span><span class="n">_freq_text</span><span class="p">,</span> <span class="n">frequency_startpos</span><span class="p">,</span> <span class="n">frequency_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">frequency</span><span class="p">,</span> <span class="n">frequency_timex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_and_timex</span><span class="p">(</span><span class="n">_freq_text</span><span class="p">)</span>
            <span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">route_startpos</span><span class="p">,</span> <span class="n">route_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">])</span>
            <span class="p">(</span><span class="n">dose_amount</span><span class="p">,</span> <span class="n">dose_amount_startpos</span><span class="p">,</span> <span class="n">dose_amount_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
            <span class="p">(</span><span class="n">strength</span><span class="p">,</span> <span class="n">strength_startpos</span><span class="p">,</span> <span class="n">strength_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>
            <span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">form_startpos</span><span class="p">,</span> <span class="n">form_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">])</span>
            <span class="p">(</span><span class="n">brand</span><span class="p">,</span> <span class="n">brand_startpos</span><span class="p">,</span> <span class="n">brand_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">])</span>
            <span class="p">(</span><span class="n">drug</span><span class="p">,</span> <span class="n">drug_startpos</span><span class="p">,</span> <span class="n">drug_endpos</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_text_start_end</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">13</span><span class="p">])</span>
            <span class="n">_start_bit</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">13</span><span class="p">])</span>
            <span class="n">_index_text</span><span class="p">,</span> <span class="n">sent_text</span> <span class="o">=</span> <span class="n">_start_bit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_or_none</span><span class="p">(</span><span class="n">_index_text</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tablename</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;sentence_index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;sentence_text&#39;</span><span class="p">:</span> <span class="n">sent_text</span><span class="p">,</span>

                <span class="s1">&#39;drug&#39;</span><span class="p">:</span> <span class="n">drug</span><span class="p">,</span>
                <span class="s1">&#39;drug_startpos&#39;</span><span class="p">:</span> <span class="n">drug_startpos</span><span class="p">,</span>
                <span class="s1">&#39;drug_endpos&#39;</span><span class="p">:</span> <span class="n">drug_endpos</span><span class="p">,</span>

                <span class="s1">&#39;brand&#39;</span><span class="p">:</span> <span class="n">brand</span><span class="p">,</span>
                <span class="s1">&#39;brand_startpos&#39;</span><span class="p">:</span> <span class="n">brand_startpos</span><span class="p">,</span>
                <span class="s1">&#39;brand_endpos&#39;</span><span class="p">:</span> <span class="n">brand_endpos</span><span class="p">,</span>

                <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                <span class="s1">&#39;form_startpos&#39;</span><span class="p">:</span> <span class="n">form_startpos</span><span class="p">,</span>
                <span class="s1">&#39;form_endpos&#39;</span><span class="p">:</span> <span class="n">form_endpos</span><span class="p">,</span>

                <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">strength</span><span class="p">,</span>
                <span class="s1">&#39;strength_startpos&#39;</span><span class="p">:</span> <span class="n">strength_startpos</span><span class="p">,</span>
                <span class="s1">&#39;strength_endpos&#39;</span><span class="p">:</span> <span class="n">strength_endpos</span><span class="p">,</span>

                <span class="s1">&#39;dose_amount&#39;</span><span class="p">:</span> <span class="n">dose_amount</span><span class="p">,</span>
                <span class="s1">&#39;dose_amount_startpos&#39;</span><span class="p">:</span> <span class="n">dose_amount_startpos</span><span class="p">,</span>
                <span class="s1">&#39;dose_amount_endpos&#39;</span><span class="p">:</span> <span class="n">dose_amount_endpos</span><span class="p">,</span>

                <span class="s1">&#39;route&#39;</span><span class="p">:</span> <span class="n">route</span><span class="p">,</span>
                <span class="s1">&#39;route_startpos&#39;</span><span class="p">:</span> <span class="n">route_startpos</span><span class="p">,</span>
                <span class="s1">&#39;route_endpos&#39;</span><span class="p">:</span> <span class="n">route_endpos</span><span class="p">,</span>

                <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>
                <span class="s1">&#39;frequency_startpos&#39;</span><span class="p">:</span> <span class="n">frequency_startpos</span><span class="p">,</span>
                <span class="s1">&#39;frequency_endpos&#39;</span><span class="p">:</span> <span class="n">frequency_endpos</span><span class="p">,</span>
                <span class="s1">&#39;frequency_timex3&#39;</span><span class="p">:</span> <span class="n">frequency_timex</span><span class="p">,</span>

                <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                <span class="s1">&#39;duration_startpos&#39;</span><span class="p">:</span> <span class="n">duration_startpos</span><span class="p">,</span>
                <span class="s1">&#39;duration_endpos&#39;</span><span class="p">:</span> <span class="n">duration_endpos</span><span class="p">,</span>

                <span class="s1">&#39;necessity&#39;</span><span class="p">:</span> <span class="n">necessity</span><span class="p">,</span>
                <span class="s1">&#39;necessity_startpos&#39;</span><span class="p">:</span> <span class="n">necessity_startpos</span><span class="p">,</span>
                <span class="s1">&#39;necessity_endpos&#39;</span><span class="p">:</span> <span class="n">necessity_endpos</span><span class="p">,</span>

                <span class="s1">&#39;umls_code&#39;</span><span class="p">:</span> <span class="n">umls_code</span><span class="p">,</span>
                <span class="s1">&#39;rx_code&#39;</span><span class="p">:</span> <span class="n">rx_code</span><span class="p">,</span>
                <span class="s1">&#39;generic_code&#39;</span><span class="p">:</span> <span class="n">generic_code</span><span class="p">,</span>
                <span class="s1">&#39;generic_name&#39;</span><span class="p">:</span> <span class="n">generic_name</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Since MedEx scans all files in the input directory, then if we&#39;re</span>
        <span class="c1"># not using temporary directories (and are therefore using a new</span>
        <span class="c1"># filename per item), we should remove the old one.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">inputfilename</span><span class="p">)</span>

        <span class="c1"># Restart subprocess?</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_external_prog_uses</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_uses</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_external_prog_uses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;relaunching app after </span><span class="si">{}</span><span class="s2"> uses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_external_prog_uses</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finish</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Medex.get_text_start_end"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex.get_text_start_end">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_text_start_end</span><span class="p">(</span><span class="n">medex_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                              <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                                              <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MedEx returns &#39;drug&#39;, &#39;strength&#39;, etc. as &quot;aspirin[7,14]&quot;, where the</span>
<span class="sd">        text is followed by the start position (zero-indexed) and the end</span>
<span class="sd">        position (one beyond the last character) (zero-indexed).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">medex_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">lbracket</span> <span class="o">=</span> <span class="n">medex_str</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>  <span class="c1"># -1 for not found</span>
        <span class="n">comma</span> <span class="o">=</span> <span class="n">medex_str</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">rbracket</span> <span class="o">=</span> <span class="n">medex_str</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lbracket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lbracket</span> <span class="o">&lt;</span> <span class="n">comma</span> <span class="o">&lt;</span> <span class="n">rbracket</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">medex_str</span><span class="p">[:</span><span class="n">lbracket</span><span class="p">]</span>
            <span class="n">lpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">medex_str</span><span class="p">[</span><span class="n">lbracket</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">comma</span><span class="p">])</span>
            <span class="n">rpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">medex_str</span><span class="p">[</span><span class="n">comma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">rbracket</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">lpos</span><span class="p">,</span> <span class="n">rpos</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Bad string[left, right] format: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">medex_str</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">int_or_none</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">str_or_none</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="k">else</span> <span class="n">text</span>

<div class="viewcode-block" id="Medex.frequency_and_timex"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex.frequency_and_timex">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">frequency_and_timex</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits e.g. b.i.d.(R1P12H)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">lbracket</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">rbracket</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lbracket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="p">(</span><span class="n">lbracket</span> <span class="o">&lt;</span> <span class="n">rbracket</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">rbracket</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lbracket</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">lbracket</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">rbracket</span><span class="p">]</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Test</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Medex.test"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the send function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_parser</span><span class="p">([</span>
            <span class="s2">&quot;Bob Hope visited Seattle and took venlafaxine M/R 375mg od.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;James Joyce wrote Ulysses whilst taking aspirin 75mg mane.&quot;</span>
        <span class="p">])</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Database structure</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Medex.dest_tables_columns"><a class="viewcode-back" href="../../../autodoc/nlp_manager/parse_medex.html#crate_anon.nlp_manager.parse_medex.Medex.dest_tables_columns">[docs]</a>    <span class="k">def</span> <span class="nf">dest_tables_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Column</span><span class="p">]]:</span>
        <span class="n">startposdef</span> <span class="o">=</span> <span class="s2">&quot;Start position (zero-based) of &quot;</span>
        <span class="n">endposdef</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;End position (zero-based index of one beyond last character) of &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tablename</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sentence_index&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;One-based index of sentence in text&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sentence_text&#39;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Text recognized as a sentence by MedEx&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;drug&#39;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Drug name, as in the text&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;drug_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;drug&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;drug_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;drug&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;brand&#39;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Drug brand name (?lookup ?only if given)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;brand_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;brand&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;brand_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;brand&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_FORM_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Drug/dose form (e.g. &#39;tablet&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;form_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;form&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;form_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;form&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;strength&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_STRENGTH_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Strength (e.g. &#39;75mg&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;strength_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;strength&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;strength_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;strength&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;dose_amount&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_DOSE_AMOUNT_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Dose amount (e.g. &#39;2 tablets&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;dose_amount_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;dose_amount&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;dose_amount_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;dose_amount&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_ROUTE_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Route (e.g. &#39;by mouth&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;route_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;route&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;route_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;route&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_FREQUENCY_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Frequency (e.g. &#39;b.i.d.&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;frequency_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;frequency_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;frequency_timex3&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">TIMEX3_MAX_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Normalized frequency in TIMEX3 format &quot;</span>
                           <span class="s2">&quot;(e.g. &#39;R1P12H&#39;)&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_DURATION_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Duration (e.g. &#39;for 10 days&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;duration_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;duration&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;duration_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;duration&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;necessity&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">MEDEX_MAX_NECESSITY_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Necessity (e.g. &#39;prn&#39;)&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;necessity_startpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">startposdef</span> <span class="o">+</span> <span class="s2">&quot;necessity&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;necessity_endpos&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">endposdef</span> <span class="o">+</span> <span class="s2">&quot;necessity&quot;</span><span class="p">),</span>

                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;umls_code&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">UMLS_CUI_MAX_LENGTH</span><span class="p">),</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;UMLS CUI&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;rx_code&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;RxNorm RxCUI for drug&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;generic_code&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;RxNorm RxCUI for generic name&quot;</span><span class="p">),</span>
                <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;generic_name&#39;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Generic drug name (associated with RxCUI code)&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">dest_tables_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Index</span><span class="p">]]:</span>
        <span class="c1"># return {</span>
        <span class="c1">#     self._tablename: [</span>
        <span class="c1">#         Index(&#39;idx_generic_name&#39;, &#39;generic_name&#39;),</span>
        <span class="c1">#     ]</span>
        <span class="c1"># }</span>
        <span class="k">return</span> <span class="p">{}</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>