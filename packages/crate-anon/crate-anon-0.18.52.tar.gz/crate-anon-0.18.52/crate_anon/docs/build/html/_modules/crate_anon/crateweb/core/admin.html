
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.crateweb.core.admin &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.crateweb.core.admin</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/crateweb/core/admin.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># NOTE that</span>
<span class="c1"># - Objects for which a user is not authorized, via get_queryset(), will</span>
<span class="c1">#   causes an Http404 error.</span>
<span class="c1"># - You can&#39;t filter on Python properties via the Django QuerySet ORM.</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.django.admin</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">admin_view_fk_link</span><span class="p">,</span>
    <span class="n">admin_view_reverse_fk_links</span><span class="p">,</span>
    <span class="n">disable_bool_icon</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.stringfunc</span> <span class="k">import</span> <span class="n">replace_in_list</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin</span> <span class="k">import</span> <span class="n">SimpleListFilter</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.admin</span> <span class="k">import</span> <span class="n">UserAdmin</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">QuerySet</span>
<span class="kn">from</span> <span class="nn">django.http.request</span> <span class="k">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="k">import</span> <span class="n">yesno</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="k">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">ugettext_lazy</span>

<span class="kn">from</span> <span class="nn">crate_anon.crateweb.extra.admin</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AddOnlyModelAdmin</span><span class="p">,</span>
    <span class="n">AllStaffReadOnlyModelAdmin</span><span class="p">,</span>
    <span class="n">EditOnceOnlyModelAdmin</span><span class="p">,</span>
    <span class="n">EditOnlyModelAdmin</span><span class="p">,</span>
    <span class="n">ReadOnlyModelAdmin</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.userprofile.models</span> <span class="k">import</span> <span class="n">UserProfile</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.consent.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CharityPaymentRecord</span><span class="p">,</span>
    <span class="n">ClinicianResponse</span><span class="p">,</span>
    <span class="n">ConsentMode</span><span class="p">,</span>
    <span class="n">ContactRequest</span><span class="p">,</span>
    <span class="n">Decision</span><span class="p">,</span>
    <span class="n">DummyPatientSourceInfo</span><span class="p">,</span>
    <span class="n">Email</span><span class="p">,</span>
    <span class="n">Leaflet</span><span class="p">,</span>
    <span class="n">Letter</span><span class="p">,</span>
    <span class="n">PatientLookup</span><span class="p">,</span>
    <span class="n">PatientResponse</span><span class="p">,</span>
    <span class="n">Study</span><span class="p">,</span>
    <span class="n">TeamRep</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.consent.tasks</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">process_consent_change</span><span class="p">,</span>
    <span class="n">process_patient_response</span><span class="p">,</span>
    <span class="n">resend_email</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">QueryAudit</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Research</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="QueryMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.QueryMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">QueryMgrAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QueryAudit</span>
    <span class="c1"># Make all fields read-only (see also ReadOnlyModelAdmin):</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;when&#39;</span><span class="p">,</span> <span class="s1">&#39;get_user&#39;</span><span class="p">,</span> <span class="s1">&#39;get_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;get_count_only&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;n_records&#39;</span><span class="p">,</span> <span class="s1">&#39;get_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;fail_msg&#39;</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>  <span class="c1"># or other things could appear</span>
    <span class="c1"># Group entries by date conveniently:</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;when&#39;</span>
    <span class="c1"># Prefetch related objects (hugely reduces number of SQL queries):</span>
    <span class="n">list_select_related</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;query__user&#39;</span><span class="p">)</span>
    <span class="c1"># What to show in the list:</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;when&#39;</span><span class="p">,</span> <span class="s1">&#39;get_user&#39;</span><span class="p">,</span> <span class="s1">&#39;get_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;get_count_only&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_records&#39;</span><span class="p">,</span> <span class="s1">&#39;get_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;fail_msg&#39;</span><span class="p">)</span>
    <span class="c1"># Filter on Booleans on the right-hand side:</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;count_only&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">)</span>
    <span class="c1"># Search text content of these:</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;query__sql&#39;</span><span class="p">,</span> <span class="s1">&#39;query__user__username&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">QueryAudit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">sql</span>
    <span class="n">get_sql</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;SQL&quot;</span>
    <span class="n">get_sql</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;query__sql&#39;</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">QueryAudit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">user</span>
    <span class="n">get_user</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;User&quot;</span>
    <span class="n">get_user</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;query__user&#39;</span>

    <span class="k">def</span> <span class="nf">get_count_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">QueryAudit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">yesno</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">count_only</span><span class="p">)</span>
    <span class="n">get_count_only</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Count only?&quot;</span>
    <span class="n">get_count_only</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;count_only&#39;</span>

    <span class="k">def</span> <span class="nf">get_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">QueryAudit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">yesno</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
    <span class="n">get_failed</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Failed?&quot;</span>
    <span class="n">get_failed</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Consent</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Study</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="StudyInline"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.StudyInline">[docs]</a><span class="k">class</span> <span class="nc">StudyInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Study</span></div>


<div class="viewcode-block" id="StudyMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.StudyMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">StudyMgrAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;lead_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;registered_at&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;search_methods_planned&#39;</span><span class="p">,</span> <span class="s1">&#39;patient_contact&#39;</span><span class="p">,</span> <span class="s1">&#39;include_under_16s&#39;</span><span class="p">,</span>
        <span class="s1">&#39;include_lack_capacity&#39;</span><span class="p">,</span> <span class="s1">&#39;clinical_trial&#39;</span><span class="p">,</span> <span class="s1">&#39;include_discharged&#39;</span><span class="p">,</span>
        <span class="s1">&#39;request_direct_approach&#39;</span><span class="p">,</span> <span class="s1">&#39;approved_by_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_reference&#39;</span><span class="p">,</span>
        <span class="s1">&#39;approved_locally&#39;</span><span class="p">,</span> <span class="s1">&#39;local_approval_at&#39;</span><span class="p">,</span>
        <span class="s1">&#39;study_details_pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_form_template_pdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;researchers&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;lead_researcher&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>
    <span class="n">filter_horizontal</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;researchers&#39;</span><span class="p">,</span> <span class="p">)</span></div>


<div class="viewcode-block" id="StudyResAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.StudyResAdmin">[docs]</a><span class="k">class</span> <span class="nc">StudyResAdmin</span><span class="p">(</span><span class="n">AllStaffReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;lead_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;registered_at&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;search_methods_planned&#39;</span><span class="p">,</span> <span class="s1">&#39;patient_contact&#39;</span><span class="p">,</span> <span class="s1">&#39;include_under_16s&#39;</span><span class="p">,</span>
        <span class="s1">&#39;include_lack_capacity&#39;</span><span class="p">,</span> <span class="s1">&#39;clinical_trial&#39;</span><span class="p">,</span> <span class="s1">&#39;include_discharged&#39;</span><span class="p">,</span>
        <span class="s1">&#39;request_direct_approach&#39;</span><span class="p">,</span> <span class="s1">&#39;approved_by_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_reference&#39;</span><span class="p">,</span>
        <span class="s1">&#39;approved_locally&#39;</span><span class="p">,</span> <span class="s1">&#39;local_approval_at&#39;</span><span class="p">,</span>
        <span class="s1">&#39;study_details_pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_form_template_pdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;researchers&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;lead_researcher&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;institutional_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>

    <span class="c1"># Restrict to studies that this researcher is affiliated to</span>
<div class="viewcode-block" id="StudyResAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.StudyResAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Study</span><span class="o">.</span><span class="n">filter_studies_for_researcher</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Leaflet</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="LeafletMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LeafletMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">LeafletMgrAdmin</span><span class="p">(</span><span class="n">EditOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">)</span></div>


<div class="viewcode-block" id="LeafletResAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LeafletResAdmin">[docs]</a><span class="k">class</span> <span class="nc">LeafletResAdmin</span><span class="p">(</span><span class="n">AllStaffReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pdf&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Leaflet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(Missing)&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;PDF&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;leaflet&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
    <span class="n">get_pdf</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Leaflet PDF&quot;</span>
    <span class="n">get_pdf</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># E-mail</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">class</span> <span class="nc">EmailSentListFilter</span><span class="p">(</span><span class="n">SimpleListFilter</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;email sent&#39;</span>
    <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;email_sent&#39;</span>

    <span class="k">def</span> <span class="nf">lookups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                <span class="n">model_admin</span><span class="p">:</span> <span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s2">&quot;E-mail sent at least once&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s2">&quot;E-mail not sent&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">queryset</span><span class="p">:</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">emailtransmission__sent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">emailtransmission__sent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="EmailDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">EmailDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Email</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">,</span> <span class="s1">&#39;recipient&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_text&#39;</span><span class="p">,</span> <span class="s1">&#39;get_view_msg_html&#39;</span><span class="p">,</span> <span class="s1">&#39;get_view_attachments&#39;</span><span class="p">,</span>
        <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_study&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span> <span class="s1">&#39;get_letter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_sent&#39;</span><span class="p">,</span> <span class="s1">&#39;get_transmissions&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>  <span class="c1"># or other things appear</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;recipient&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;get_sent&#39;</span><span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">EmailSentListFilter</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;recipient&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">)</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resend&#39;</span><span class="p">]</span>
    <span class="c1"># ... alternative method (per instance):</span>
    <span class="c1"># http://stackoverflow.com/questions/2805701/is-there-a-way-to-get-custom-django-admin-actions-to-appear-on-the-change-view  # noqa</span>

    <span class="c1"># - We can&#39;t use list_select_related for things that have a foreign key to</span>
    <span class="c1">#   us (rather than things we have an FK to).</span>
    <span class="c1"># - prefetch_related (in the queryset) just uses Python, not SQL.</span>
    <span class="c1"># - http://blog.roseman.org.uk/2010/01/11/django-patterns-part-2-efficient-reverse-lookups/  # noqa</span>
    <span class="c1"># Anyway, premature optimization is the root of all evil, and all that.</span>

    <span class="k">def</span> <span class="nf">get_view_msg_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;view_email_html&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;View HTML message&lt;/a&gt; (</span><span class="si">{}</span><span class="s1"> bytes)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">msg_html</span><span class="p">))</span>
    <span class="n">get_view_msg_html</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Message HTML&quot;</span>
    <span class="n">get_view_msg_html</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_view_attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">attachments</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">emailattachment_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attachments</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(No attachments)&quot;</span>
        <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attachments</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attachment</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s1">&#39;Attachment </span><span class="si">{}</span><span class="s1">: &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;&lt;b&gt;</span><span class="si">{}</span><span class="s1">&lt;/b&gt;&lt;/a&gt; &#39;</span>
                    <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1"> bytes), sent as &lt;b&gt;</span><span class="si">{}</span><span class="s1">&lt;/b&gt;&lt;/a&gt;&lt;br&gt;&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;view_email_attachment&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">attachment</span><span class="o">.</span><span class="n">id</span><span class="p">]),</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="n">sent_filename</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s1">&#39;Attachment </span><span class="si">{}</span><span class="s1">: &lt;b&gt;</span><span class="si">{}</span><span class="s1">&lt;/b&gt; (missing), &#39;</span>
                    <span class="s1">&#39;sent as &lt;b&gt;</span><span class="si">{}</span><span class="s1">&lt;/b&gt;&lt;br&gt;&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
                    <span class="n">attachment</span><span class="o">.</span><span class="n">sent_filename</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span>
    <span class="n">get_view_attachments</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Attachments&quot;</span>
    <span class="n">get_view_attachments</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">resend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">queryset</span><span class="p">:</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">email_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">email_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># transaction.on_commit not required (no changes made to emails)</span>
            <span class="n">resend_email</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># Asynchronous</span>
        <span class="k">if</span> <span class="n">email_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> e-mails were queued for resending: IDs </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">email_ids</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">email_ids</span><span class="p">)))</span>
    <span class="n">resend</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Resend selected e-mails&quot;</span>

    <span class="k">def</span> <span class="nf">get_transmissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">emailtransmission_set</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="n">get_transmissions</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Transmissions&quot;</span>
    <span class="n">get_transmissions</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">has_been_sent</span><span class="p">()</span>
    <span class="n">get_sent</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Sent&quot;</span>
    <span class="n">get_sent</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_letter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;letter&quot;</span><span class="p">)</span>
    <span class="n">get_letter</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Letter&quot;</span>
    <span class="n">get_letter</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">)</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Study&quot;</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_contact_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contact_request&quot;</span><span class="p">)</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Contact request&quot;</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="EmailMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">EmailMgrAdmin</span><span class="p">(</span><span class="n">EmailDevAdmin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restrict to e-mails/information visible to the RDBM.</span>
<span class="sd">    Also, since we&#39;re not inhering from AllStaffReadOnlyModelAdmin, give</span>
<span class="sd">    admin read permissions to all staff.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">,</span> <span class="s1">&#39;recipient&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span>

        <span class="c1"># subject should not be confidential</span>
        <span class="c1"># no text, HTML, or attachments</span>
        <span class="s1">&#39;get_restricted_msg_text&#39;</span><span class="p">,</span> <span class="s1">&#39;get_restricted_msg_html&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_restricted_attachments&#39;</span><span class="p">,</span>

        <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_study&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span> <span class="s1">&#39;get_letter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_sent&#39;</span><span class="p">,</span> <span class="s1">&#39;get_transmissions&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>  <span class="c1"># or other things appear</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resend&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EmailMgrAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailMgrAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">to_researcher</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span>
                                                  <span class="n">Q</span><span class="p">(</span><span class="n">to_patient</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">qs</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rdbm_may_view</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_patient</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_researcher</span>

    <span class="k">def</span> <span class="nf">get_restricted_msg_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdbm_may_view</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;(Not authorized)&quot;</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">msg_text</span>
    <span class="n">get_restricted_msg_text</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Message text&quot;</span>

    <span class="k">def</span> <span class="nf">get_restricted_msg_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdbm_may_view</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;(Not authorized)&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view_msg_html</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">get_restricted_msg_html</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Message HTML&quot;</span>
    <span class="n">get_restricted_msg_html</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_restricted_attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdbm_may_view</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;(Not authorized)&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view_attachments</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">get_restricted_attachments</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Attachments&quot;</span>
    <span class="n">get_restricted_attachments</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="EmailResAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailResAdmin">[docs]</a><span class="k">class</span> <span class="nc">EmailResAdmin</span><span class="p">(</span><span class="n">EmailDevAdmin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restrict to e-mails visible to a researcher.</span>
<span class="sd">    Also, since we&#39;re not inhering from AllStaffReadOnlyModelAdmin, give</span>
<span class="sd">    admin read permissions to all staff.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">,</span> <span class="s1">&#39;recipient&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_text&#39;</span><span class="p">,</span> <span class="s1">&#39;get_view_msg_html&#39;</span><span class="p">,</span> <span class="s1">&#39;get_view_attachments&#39;</span><span class="p">,</span>
        <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_study&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span> <span class="s1">&#39;get_letter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_sent&#39;</span><span class="p">,</span> <span class="s1">&#39;get_transmissions&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>  <span class="c1"># or other things appear</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not [], which allows site-wide things</span>

<div class="viewcode-block" id="EmailResAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailResAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">to_researcher</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">studies</span> <span class="o">=</span> <span class="n">Study</span><span class="o">.</span><span class="n">filter_studies_for_researcher</span><span class="p">(</span><span class="n">Study</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                                                      <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">study__in</span><span class="o">=</span><span class="n">studies</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmailResAdmin.has_module_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailResAdmin.has_module_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_module_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div>

<div class="viewcode-block" id="EmailResAdmin.has_change_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.EmailResAdmin.has_change_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                              <span class="n">obj</span><span class="p">:</span> <span class="n">Email</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Dummy patient source info</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="DummyPatientSourceInfoDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.DummyPatientSourceInfoDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">DummyPatientSourceInfoDevAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Patient</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_dob&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_dod&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_dead&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_discharged&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_discharge_date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_sex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_title&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_3&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_6&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_email&#39;</span><span class="p">,</span>

        <span class="c1"># GP</span>
        <span class="s1">&#39;gp_title&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_3&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_6&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_email&#39;</span><span class="p">,</span>

        <span class="c1"># Clinician</span>
        <span class="s1">&#39;clinician_title&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_4&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_6&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_is_consultant&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_signatory_title&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Patient lookup</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="PatientLookupDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientLookupDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">PatientLookupDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Lookup details</span>
        <span class="s1">&#39;lookup_at&#39;</span><span class="p">,</span> <span class="s1">&#39;source_db&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>

        <span class="c1"># Patient</span>
        <span class="s1">&#39;pt_found&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_local_id_description&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_local_id_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_dob&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_dod&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_dead&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_discharged&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_sex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_title&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_3&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_6&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_email&#39;</span><span class="p">,</span>

        <span class="c1"># GP</span>
        <span class="s1">&#39;gp_found&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_title&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_3&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_6&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gp_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_email&#39;</span><span class="p">,</span>

        <span class="c1"># Clinician</span>
        <span class="s1">&#39;clinician_found&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_title&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_last_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_4&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_address_6&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_address_7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_is_consultant&#39;</span><span class="p">,</span> <span class="s1">&#39;clinician_signatory_title&#39;</span><span class="p">,</span>

        <span class="c1"># Decisions</span>
        <span class="s1">&#39;decisions&#39;</span><span class="p">,</span> <span class="s1">&#39;secret_decisions&#39;</span><span class="p">,</span>

        <span class="c1"># Extras</span>
        <span class="s1">&#39;get_test_views&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;lookup_at&#39;</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_dob&#39;</span><span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_last_name&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_test_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">PatientLookup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter to patient re first traffic-light</span>
<span class="s1">                choice (as HTML)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter to patient re first traffic-light</span>
<span class="s1">                choice (as PDF)&lt;/a&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_first_traffic_light_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_first_traffic_light_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Test views&quot;</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Consent mode</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="ConsentModeInline"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeInline">[docs]</a><span class="k">class</span> <span class="nc">ConsentModeInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ConsentMode</span></div>


<div class="viewcode-block" id="ConsentModeAdminForm"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeAdminForm">[docs]</a><span class="k">class</span> <span class="nc">ConsentModeAdminForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
<div class="viewcode-block" id="ConsentModeAdminForm.clean"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeAdminForm.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;changed_by_clinician_override&#39;</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">Decision</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">Decision</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">decision</span><span class="o">.</span><span class="n">validate_decision</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span></div></div>


<div class="viewcode-block" id="ConsentModeMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">ConsentModeMgrAdmin</span><span class="p">(</span><span class="n">AddOnlyModelAdmin</span><span class="p">):</span>
    <span class="c1"># To switch off the Boolean icons: replace exclude_entirely with</span>
    <span class="c1"># exclude_entirely_col in the fieldlist, and define the function as:</span>
    <span class="c1">#</span>
    <span class="c1"># def exclude_entirely_col(self, obj):</span>
    <span class="c1">#     return obj.exclude_entirely</span>
    <span class="c1"># exclude_entirely_col.boolean = False</span>
    <span class="c1">#</span>
    <span class="c1"># Can use get_fields(self, request, obj=None) and get_readonly_fields(...)</span>
    <span class="c1"># to customize icon behaviour depending on whether we&#39;re adding or</span>
    <span class="c1"># editing.</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">ConsentModeAdminForm</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;exclude_entirely&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;,</span>
        <span class="c1"># &#39;max_approaches_per_year&#39;,</span>
        <span class="c1"># &#39;other_requests&#39;,</span>
        <span class="s1">&#39;prefers_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;changed_by_clinician_override&#39;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">Decision</span><span class="o">.</span><span class="n">FIELDS</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;nhs_number&#39;</span><span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;,</span>
        <span class="s1">&#39;exclude_entirely&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prefers_email&#39;</span>
    <span class="p">)</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>

    <span class="n">fields_for_viewing</span> <span class="o">=</span> <span class="n">replace_in_list</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;exclude_entirely&#39;</span><span class="p">:</span> <span class="s1">&#39;exclude_entirely2&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;: &#39;consent_after_discharge2&#39;,</span>
        <span class="s1">&#39;prefers_email&#39;</span><span class="p">:</span> <span class="s1">&#39;prefers_email2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;changed_by_clinician_override&#39;</span><span class="p">:</span> <span class="s1">&#39;changed_by_clinician_override2&#39;</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">exclude_entirely2</span> <span class="o">=</span> <span class="n">disable_bool_icon</span><span class="p">(</span><span class="s1">&#39;exclude_entirely&#39;</span><span class="p">,</span> <span class="n">ConsentMode</span><span class="p">)</span>
    <span class="n">consent_after_discharge2</span> <span class="o">=</span> <span class="n">disable_bool_icon</span><span class="p">(</span>
        <span class="s1">&#39;consent_after_discharge&#39;</span><span class="p">,</span> <span class="n">ConsentMode</span><span class="p">)</span>
    <span class="n">prefers_email2</span> <span class="o">=</span> <span class="n">disable_bool_icon</span><span class="p">(</span><span class="s1">&#39;prefers_email&#39;</span><span class="p">,</span> <span class="n">ConsentMode</span><span class="p">)</span>
    <span class="n">changed_by_clinician_override2</span> <span class="o">=</span> <span class="n">disable_bool_icon</span><span class="p">(</span>
        <span class="s1">&#39;changed_by_clinician_override&#39;</span><span class="p">,</span> <span class="n">ConsentMode</span><span class="p">)</span>

    <span class="c1"># Populate the created_by field automatically, with the two functions below</span>
    <span class="c1"># https://code.djangoproject.com/wiki/CookBookNewformsAdminAndUser</span>
<div class="viewcode-block" id="ConsentModeMgrAdmin.save_model"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeMgrAdmin.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                   <span class="n">obj</span><span class="p">:</span> <span class="n">ConsentMode</span><span class="p">,</span>
                   <span class="n">form</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">,</span>
                   <span class="n">change</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">needs_processing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">process_consent_change</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Asynchronous</span>
        <span class="c1"># Without transaction.on_commit, we get a RACE CONDITION:</span>
        <span class="c1"># object is received in the pre-save() state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;Consent mode will be changed. You will be e-mailed regarding &quot;</span>
            <span class="s2">&quot;the letter to patient (+/- re withdrawal of consent to &quot;</span>
            <span class="s2">&quot;researchers).&quot;</span><span class="p">)</span></div>

    <span class="c1"># def save_formset(self, request, form, formset, change):</span>
    <span class="c1">#     if formset.model == ConsentMode:</span>
    <span class="c1">#         instances = formset.save(commit=False)</span>
    <span class="c1">#         for instance in instances:</span>
    <span class="c1">#             instance.created_by = request.user</span>
    <span class="c1">#             instance.save()</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         formset.save()</span>

    <span class="c1"># Restrict to current ones</span>
<div class="viewcode-block" id="ConsentModeMgrAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeMgrAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">current</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConsentModeDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ConsentModeDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">ConsentModeDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;created_by&#39;</span><span class="p">,</span>
        <span class="s1">&#39;exclude_entirely&#39;</span><span class="p">,</span> <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;consent_after_discharge&#39;</span><span class="p">,</span>
        <span class="s1">&#39;max_approaches_per_year&#39;</span><span class="p">,</span> <span class="s1">&#39;other_requests&#39;</span><span class="p">,</span> <span class="s1">&#39;prefers_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;changed_by_clinician_override&#39;</span><span class="p">,</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">Decision</span><span class="o">.</span><span class="n">FIELDS</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s1">&#39;get_test_views&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">readonly_fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;current&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;current&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;consent_after_discharge&#39;,</span>
        <span class="s1">&#39;exclude_entirely&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prefers_email&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_test_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ConsentMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter to patient confirming traffic-light</span>
<span class="s1">                choice (as HTML)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter to patient confirming traffic-light</span>
<span class="s1">                choice (as PDF)&lt;/a&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_confirm_traffic_light_letter&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_confirm_traffic_light_letter&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Test views&quot;</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Team rep</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="TeamRepMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.TeamRepMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">TeamRepMgrAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Charity payments</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="CharityPaymentRecordMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.CharityPaymentRecordMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">CharityPaymentRecordMgrAdmin</span><span class="p">(</span><span class="n">AddOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payee&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">)</span>
    <span class="n">fields_for_viewing</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;payee&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payee&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Contact request</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">class</span> <span class="nc">ClinicianRespondedListFilter</span><span class="p">(</span><span class="n">SimpleListFilter</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;clinician responded&#39;</span>
    <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;clinician_responded&#39;</span>

    <span class="k">def</span> <span class="nf">lookups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                <span class="n">model_admin</span><span class="p">:</span> <span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s2">&quot;Clinician responded&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s2">&quot;Clinician asked but hasn’t responded&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">queryset</span><span class="p">:</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">queryset</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">decided_send_to_clinician</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clinician_response__responded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">queryset</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">decided_send_to_clinician</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">clinician_response__responded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>


<div class="viewcode-block" id="ContactRequestMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">ContactRequestMgrAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">NONCONFIDENTIAL_FIELDS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;request_by&#39;</span><span class="p">,</span> <span class="s1">&#39;get_study&#39;</span><span class="p">,</span>
        <span class="s1">&#39;request_direct_approach&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lookup_nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;lookup_rid&#39;</span><span class="p">,</span> <span class="s1">&#39;lookup_mrid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;processed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_consent_mode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;approaches_in_past_year&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decisions&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_no_action&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_send_to_researcher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_send_to_clinician&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_involvement&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_withdrawn&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_withdrawn_at&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_letters&#39;</span><span class="p">,</span> <span class="s1">&#39;get_emails&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">NONCONFIDENTIAL_FIELDS</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;get_clinician_email_address&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;get_clinician_responded&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">NONCONFIDENTIAL_LIST_DISPLAY</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;request_by&#39;</span><span class="p">,</span> <span class="s1">&#39;study&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lookup_nhs_number&#39;</span><span class="p">,</span> <span class="s1">&#39;lookup_rid&#39;</span><span class="p">,</span> <span class="s1">&#39;lookup_mrid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_no_action&#39;</span><span class="p">,</span> <span class="s1">&#39;decided_send_to_researcher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_send_to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;get_clinician_responded&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="n">NONCONFIDENTIAL_LIST_DISPLAY</span> <span class="o">+</span> <span class="p">(</span>
        <span class="s1">&#39;get_clinician_email_address&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;decided_no_action&#39;</span><span class="p">,</span> <span class="s1">&#39;decided_send_to_researcher&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;decided_send_to_clinician&#39;</span><span class="p">,</span> <span class="n">ClinicianRespondedListFilter</span><span class="p">)</span>
    <span class="n">list_select_related</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;clinician_response&#39;</span><span class="p">,</span>
        <span class="s1">&#39;request_by&#39;</span><span class="p">,</span>
        <span class="s1">&#39;study__lead_researcher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;patient_lookup&#39;</span><span class="p">,</span>
        <span class="s1">&#39;consent_mode&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>

    <span class="k">def</span> <span class="nf">get_consent_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConsentMode</span><span class="p">:</span>
        <span class="n">consent_mode</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">consent_mode</span>
        <span class="k">return</span> <span class="n">consent_mode</span><span class="o">.</span><span class="n">consent_mode</span>
    <span class="n">get_consent_mode</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Consent mode&quot;</span>

    <span class="k">def</span> <span class="nf">get_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">)</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Study&quot;</span>

    <span class="k">def</span> <span class="nf">get_clinician_email_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">decided_send_to_clinician</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">patient_lookup</span><span class="o">.</span><span class="n">clinician_email</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">get_clinician_email_address</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Clinician e-mail address&quot;</span>

    <span class="k">def</span> <span class="nf">get_clinician_responded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;clinician_response&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">clinician_response</span><span class="o">.</span><span class="n">responded</span>
    <span class="n">get_clinician_responded</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Clinician responded&quot;</span>
    <span class="n">get_clinician_responded</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_letters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_reverse_fk_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;letter_set&quot;</span><span class="p">)</span>
    <span class="n">get_letters</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Letter(s)&quot;</span>
    <span class="n">get_letters</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_reverse_fk_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;email_set&quot;</span><span class="p">)</span>
    <span class="n">get_emails</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;E-mail(s)&quot;</span>
    <span class="n">get_emails</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ContactRequestResAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestResAdmin">[docs]</a><span class="k">class</span> <span class="nc">ContactRequestResAdmin</span><span class="p">(</span><span class="n">ContactRequestMgrAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">ContactRequestMgrAdmin</span><span class="o">.</span><span class="n">NONCONFIDENTIAL_FIELDS</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="n">ContactRequestMgrAdmin</span><span class="o">.</span><span class="n">NONCONFIDENTIAL_LIST_DISPLAY</span>

<div class="viewcode-block" id="ContactRequestResAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestResAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">studies</span> <span class="o">=</span> <span class="n">Study</span><span class="o">.</span><span class="n">filter_studies_for_researcher</span><span class="p">(</span><span class="n">Study</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                                                      <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">study__in</span><span class="o">=</span><span class="n">studies</span><span class="p">)</span></div>

<div class="viewcode-block" id="ContactRequestResAdmin.has_module_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestResAdmin.has_module_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_module_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div>

<div class="viewcode-block" id="ContactRequestResAdmin.has_change_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestResAdmin.has_change_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                              <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div></div>


<div class="viewcode-block" id="ContactRequestDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ContactRequestDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">ContactRequestDevAdmin</span><span class="p">(</span><span class="n">ContactRequestMgrAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">ContactRequestMgrAdmin</span><span class="o">.</span><span class="n">NONCONFIDENTIAL_FIELDS</span> <span class="o">+</span> <span class="p">(</span>
        <span class="c1"># RDBM can also see</span>
        <span class="s1">&#39;get_clinician_email_address&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_link_clinician_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_clinician_responded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_link_clinician_response&#39;</span><span class="p">,</span>

        <span class="c1"># properly secret</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_patient_lookup&#39;</span><span class="p">,</span>

        <span class="c1"># exploratory test views</span>
        <span class="s1">&#39;get_test_views&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;request_by&#39;</span><span class="p">,</span> <span class="s1">&#39;study&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nhs_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_no_action&#39;</span><span class="p">,</span> <span class="s1">&#39;decided_send_to_researcher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decided_send_to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;get_clinician_responded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;get_clinician_email_address&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_link_clinician_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_reverse_fk_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;email_set&quot;</span><span class="p">)</span>
    <span class="n">get_link_clinician_email</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;E-mail to clinician&quot;</span>
    <span class="n">get_link_clinician_email</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_link_clinician_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;clinician_response&quot;</span><span class="p">)</span>
    <span class="n">get_link_clinician_response</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Clinician response&quot;</span>
    <span class="n">get_link_clinician_response</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_patient_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;patient_lookup&quot;</span><span class="p">)</span>
    <span class="n">get_patient_lookup</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Patient lookup&quot;</span>
    <span class="n">get_patient_lookup</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_consent_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;consent_mode&quot;</span><span class="p">)</span>
    <span class="n">get_consent_mode</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Consent mode&quot;</span>
    <span class="n">get_consent_mode</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_letters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_reverse_fk_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;letter_set&quot;</span><span class="p">)</span>
    <span class="n">get_letters</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_letters</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Letter(s)&quot;</span>

    <span class="k">def</span> <span class="nf">get_test_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ContactRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft e-mail to clinician&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter from clinician to patient re study</span>
<span class="s1">                (HTML)&lt;/a&gt;&lt;/br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft letter from clinician to patient re study</span>
<span class="s1">                (PDF)&lt;/a&gt;&lt;/br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Decision form to patient re study (HTML)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Decision form to patient re study (PDF)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft approval letter to researcher (HTML)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft approval letter to researcher (PDF)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft approval covering e-mail to researcher&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft withdrawal letter to researcher (HTML)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft withdrawal letter to researcher (PDF)&lt;/a&gt;&lt;br&gt;</span>
<span class="s1">            &lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;Draft withdrawal covering e-mail to researcher&lt;/a&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_clinician_email&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_letter_clinician_to_pt_re_study&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_letter_clinician_to_pt_re_study&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;decision_form_to_pt_re_study&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;decision_form_to_pt_re_study&#39;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_approval_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_approval_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_approval_email&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_withdrawal_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_withdrawal_letter&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;draft_withdrawal_email&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Test views&quot;</span>
    <span class="n">get_test_views</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Clinician response</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="ClinicianResponseDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ClinicianResponseDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">ClinicianResponseDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_request&#39;</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">,</span>
        <span class="s1">&#39;responded&#39;</span><span class="p">,</span> <span class="s1">&#39;responded_at&#39;</span><span class="p">,</span> <span class="s1">&#39;response_route&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email_choice&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span>
        <span class="s1">&#39;veto_reason&#39;</span><span class="p">,</span> <span class="s1">&#39;ineligible_reason&#39;</span><span class="p">,</span> <span class="s1">&#39;pt_uncontactable_reason&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clinician_confirm_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;charity_amount_due&#39;</span><span class="p">,</span>

        <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>

    <span class="k">def</span> <span class="nf">get_contact_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">ClinicianResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contact_request&quot;</span><span class="p">)</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Contact request&quot;</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Patient response</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="PatientResponseAdminForm"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseAdminForm">[docs]</a><span class="k">class</span> <span class="nc">PatientResponseAdminForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
<div class="viewcode-block" id="PatientResponseAdminForm.clean"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseAdminForm.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">Decision</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">decision</span> <span class="o">=</span> <span class="n">Decision</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">decision</span><span class="o">.</span><span class="n">validate_decision</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span></div></div>


<div class="viewcode-block" id="PatientResponseMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">PatientResponseMgrAdmin</span><span class="p">(</span><span class="n">EditOnceOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PatientResponseAdminForm</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">Decision</span><span class="o">.</span><span class="n">FIELDS</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">]</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>

    <span class="c1"># Populate the created_by field automatically, with the two functions below</span>
<div class="viewcode-block" id="PatientResponseMgrAdmin.save_model"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseMgrAdmin.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                   <span class="n">obj</span><span class="p">:</span> <span class="n">PatientResponse</span><span class="p">,</span>
                   <span class="n">form</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">,</span>
                   <span class="n">change</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">recorded_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># log.debug(&quot;PatientResponse: {}&quot;.format(modelrepr(obj)))</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">process_patient_response</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Asynchronous</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">response</span> <span class="o">==</span> <span class="n">PatientResponse</span><span class="o">.</span><span class="n">YES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s2">&quot;Approval to researcher will be generated. You will be &quot;</span>
                <span class="s2">&quot;e-mailed if the system can&#39;t send it to the researcher.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PatientResponseMgrAdmin.has_change_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseMgrAdmin.has_change_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                              <span class="n">obj</span><span class="p">:</span> <span class="n">PatientResponse</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># already saved</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">get_contact_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">PatientResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contact_request&quot;</span><span class="p">)</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Contact request&quot;</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PatientResponseMgrAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseMgrAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="c1"># Restrict to unresponded ones</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">response__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PatientResponseDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.PatientResponseDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">PatientResponseDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">PatientResponseMgrAdmin</span><span class="o">.</span><span class="n">fields</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>

    <span class="k">def</span> <span class="nf">get_contact_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">PatientResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contact_request&quot;</span><span class="p">)</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Contact request&quot;</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Letters</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">class</span> <span class="nc">LetterSendingStatusFilter</span><span class="p">(</span><span class="n">SimpleListFilter</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;sending status&quot;</span>
    <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;sending_status&#39;</span>

    <span class="k">def</span> <span class="nf">lookups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                <span class="n">model_admin</span><span class="p">:</span> <span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;sent_manually&#39;</span><span class="p">,</span> <span class="s2">&quot;Sent manually&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;not_sent_manually&#39;</span><span class="p">,</span> <span class="s2">&quot;Not sent manually&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sent_by_email&#39;</span><span class="p">,</span> <span class="s2">&quot;Sent by e-mail&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;not_sent_by_email&#39;</span><span class="p">,</span> <span class="s2">&quot;Not sent by e-mail&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;require_sending&#39;</span><span class="p">,</span> <span class="s2">&quot;REQUIRE SENDING&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">queryset</span><span class="p">:</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sent_manually&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sent_manually_at__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;not_sent_manually&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sent_manually_at__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sent_by_email&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">queryset</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email__emailtransmission__sent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;not_sent_by_email&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">email__emailtransmission__sent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;require_sending&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">queryset</span>
                <span class="c1"># Restrict to letters not sent manually</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sent_manually_at__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Exclude letters successfully sent by e-mail</span>
                <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">email__emailtransmission__sent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>


<div class="viewcode-block" id="LetterDevAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterDevAdmin">[docs]</a><span class="k">class</span> <span class="nc">LetterDevAdmin</span><span class="p">(</span><span class="n">ReadOnlyModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
              <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
              <span class="s1">&#39;get_study&#39;</span><span class="p">,</span> <span class="s1">&#39;get_contact_request&#39;</span><span class="p">,</span>
              <span class="s1">&#39;sent_manually_at&#39;</span><span class="p">,</span> <span class="s1">&#39;get_emails&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;study&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_request&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;sent_manually_at&#39;</span><span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">LetterSendingStatusFilter</span><span class="p">,</span>
                   <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">)</span>
    <span class="n">list_select_related</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;study__lead_researcher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contact_request&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span>
    <span class="c1"># ... see also http://stackoverflow.com/questions/991926/custom-filter-in-django-admin-on-django-1-3-or-below  # noqa</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mark_sent&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">mark_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">queryset</span><span class="p">:</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">letter</span><span class="o">.</span><span class="n">mark_sent</span><span class="p">()</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">letter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> letter(s) were marked as sent: IDs </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span>
                                                               <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
    <span class="n">mark_sent</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Mark selected letters as printed/sent&quot;</span>

    <span class="k">def</span> <span class="nf">get_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Letter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">)</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_study</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Study&quot;</span>

    <span class="k">def</span> <span class="nf">get_contact_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Letter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_fk_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contact_request&quot;</span><span class="p">)</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_contact_request</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Contact request&quot;</span>

    <span class="k">def</span> <span class="nf">get_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Letter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_view_reverse_fk_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;email_set&quot;</span><span class="p">)</span>
    <span class="n">get_emails</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">get_emails</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;E-mail(s)&quot;</span></div>


<div class="viewcode-block" id="LetterMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">LetterMgrAdmin</span><span class="p">(</span><span class="n">LetterDevAdmin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restrict to letters visible to a researcher.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LetterMgrAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterMgrAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">to_researcher</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">rdbm_may_view</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="LetterResAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterResAdmin">[docs]</a><span class="k">class</span> <span class="nc">LetterResAdmin</span><span class="p">(</span><span class="n">LetterDevAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pdf&#39;</span><span class="p">,</span>
              <span class="s1">&#39;to_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;to_researcher&#39;</span><span class="p">,</span> <span class="s1">&#39;to_patient&#39;</span><span class="p">,</span>
              <span class="s1">&#39;study&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_request&#39;</span><span class="p">,</span>
              <span class="s1">&#39;sent_manually_at&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="sd">&quot;&quot;&quot;Restrict to letters visible to a researcher.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LetterResAdmin.get_queryset"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterResAdmin.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">to_researcher</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">studies</span> <span class="o">=</span> <span class="n">Study</span><span class="o">.</span><span class="n">filter_studies_for_researcher</span><span class="p">(</span><span class="n">Study</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                                                      <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">study__in</span><span class="o">=</span><span class="n">studies</span><span class="p">)</span></div>

<div class="viewcode-block" id="LetterResAdmin.has_module_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterResAdmin.has_module_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_module_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div>

<div class="viewcode-block" id="LetterResAdmin.has_change_permission"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.LetterResAdmin.has_change_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                              <span class="n">obj</span><span class="p">:</span> <span class="n">Letter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span></div>

    <span class="k">def</span> <span class="nf">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Letter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(Missing)&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;PDF&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
    <span class="n">get_pdf</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Letter PDF&quot;</span>
    <span class="n">get_pdf</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># User profiles</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="UserProfileInline"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.UserProfileInline">[docs]</a><span class="k">class</span> <span class="nc">UserProfileInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">StackedInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">UserProfile</span>
    <span class="n">max_num</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">can_delete</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">StudyInline</span><span class="p">]</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;per_page&#39;</span><span class="p">,</span> <span class="s1">&#39;line_length&#39;</span><span class="p">,</span>
              <span class="s1">&#39;collapse_at_len&#39;</span><span class="p">,</span> <span class="s1">&#39;collapse_at_n_lines&#39;</span><span class="p">,</span>
              <span class="s1">&#39;is_developer&#39;</span><span class="p">,</span>
              <span class="s1">&#39;title&#39;</span><span class="p">,</span>
              <span class="s1">&#39;telephone&#39;</span><span class="p">,</span>
              <span class="s1">&#39;address_1&#39;</span><span class="p">,</span> <span class="s1">&#39;address_2&#39;</span><span class="p">,</span> <span class="s1">&#39;address_3&#39;</span><span class="p">,</span> <span class="s1">&#39;address_4&#39;</span><span class="p">,</span>
              <span class="s1">&#39;address_5&#39;</span><span class="p">,</span> <span class="s1">&#39;address_6&#39;</span><span class="p">,</span> <span class="s1">&#39;address_7&#39;</span><span class="p">,</span>
              <span class="s1">&#39;is_clinician&#39;</span><span class="p">,</span> <span class="s1">&#39;is_consultant&#39;</span><span class="p">,</span>
              <span class="s1">&#39;get_studies_as_lead&#39;</span><span class="p">,</span> <span class="s1">&#39;get_studies_as_researcher&#39;</span><span class="p">,</span>
              <span class="s1">&#39;enough_info_for_researcher&#39;</span><span class="p">)</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;get_studies_as_lead&#39;</span><span class="p">,</span> <span class="s1">&#39;get_studies_as_researcher&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;enough_info_for_researcher&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_studies_as_lead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">studies</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">studies_as_lead</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;shortlist_studies.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;studies&#39;</span><span class="p">:</span> <span class="n">studies</span><span class="p">})</span>
    <span class="n">get_studies_as_lead</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Studies as lead researcher&quot;</span>
    <span class="n">get_studies_as_lead</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_studies_as_researcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">studies</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">studies_as_researcher</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;shortlist_studies.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;studies&#39;</span><span class="p">:</span> <span class="n">studies</span><span class="p">})</span>
    <span class="n">get_studies_as_researcher</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Studies as researcher&quot;</span>
    <span class="n">get_studies_as_researcher</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">enough_info_for_researcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">obj</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">enough_info_for_researcher</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Enough info for researcher status (title, firstname, lastname)?&quot;</span>
    <span class="p">)</span>
    <span class="n">enough_info_for_researcher</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ExtendedUserMgrAdmin"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ExtendedUserMgrAdmin">[docs]</a><span class="k">class</span> <span class="nc">ExtendedUserMgrAdmin</span><span class="p">(</span><span class="n">UserAdmin</span><span class="p">):</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserProfileInline</span><span class="p">]</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;is_staff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;enough_info_for_researcher&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">enough_info_for_researcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">obj</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">enough_info_for_researcher</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Enough researcher info?&quot;</span>
    <span class="p">)</span>
    <span class="n">enough_info_for_researcher</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Assemble main admin site</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># http://stackoverflow.com/questions/4938491/django-admin-change-header-django-administration-text  # noqa</span>
<span class="c1"># http://stackoverflow.com/questions/3400641/how-do-i-inline-edit-a-django-user-profile-in-the-admin-interface  # noqa</span>

<div class="viewcode-block" id="MgrAdminSite"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.MgrAdminSite">[docs]</a><span class="k">class</span> <span class="nc">MgrAdminSite</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">AdminSite</span><span class="p">):</span>
    <span class="c1"># Text to put at the end of each page&#39;s &lt;title&gt;.</span>
    <span class="n">site_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span> <span class="s1">&#39; manager admin&#39;</span><span class="p">)</span>
    <span class="c1"># Text to put in each page&#39;s &lt;h1&gt;.</span>
    <span class="n">site_header</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span> <span class="s2">&quot;: manager admin&quot;</span><span class="p">)</span>
    <span class="c1"># URL for the &quot;View site&quot; link at the top of each admin page.</span>
    <span class="n">site_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FORCE_SCRIPT_NAME</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="c1"># Text to put at the top of the admin index page.</span>
    <span class="n">index_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span>
                                <span class="s1">&#39; site administration for RDBM&#39;</span><span class="p">)</span>
    <span class="n">index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_index.html&#39;</span>
    <span class="n">app_index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_app_index.html&#39;</span></div>


<span class="n">mgr_admin_site</span> <span class="o">=</span> <span class="n">MgrAdminSite</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mgradmin&quot;</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">disable_action</span><span class="p">(</span><span class="s1">&#39;delete_selected&#39;</span><span class="p">)</span>
<span class="c1"># ... particularly for e-mail where we manually specify a bulk action (resend)</span>
<span class="c1"># https://docs.djangoproject.com/en/1.8/ref/contrib/admin/actions/</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">CharityPaymentRecord</span><span class="p">,</span> <span class="n">CharityPaymentRecordMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ConsentMode</span><span class="p">,</span> <span class="n">ConsentModeMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ContactRequest</span><span class="p">,</span> <span class="n">ContactRequestMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Email</span><span class="p">,</span> <span class="n">EmailMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Leaflet</span><span class="p">,</span> <span class="n">LeafletMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Letter</span><span class="p">,</span> <span class="n">LetterMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">PatientResponse</span><span class="p">,</span> <span class="n">PatientResponseMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">QueryAudit</span><span class="p">,</span> <span class="n">QueryMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Study</span><span class="p">,</span> <span class="n">StudyMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">TeamRep</span><span class="p">,</span> <span class="n">TeamRepMgrAdmin</span><span class="p">)</span>
<span class="n">mgr_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">ExtendedUserMgrAdmin</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Assemble secondary (developer) admin site</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># http://stackoverflow.com/questions/4938491/django-admin-change-header-django-administration-text  # noqa</span>
<span class="c1"># http://stackoverflow.com/questions/3400641/how-do-i-inline-edit-a-django-user-profile-in-the-admin-interface  # noqa</span>

<div class="viewcode-block" id="DevAdminSite"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.DevAdminSite">[docs]</a><span class="k">class</span> <span class="nc">DevAdminSite</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">AdminSite</span><span class="p">):</span>
    <span class="n">site_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span> <span class="s1">&#39; dev admin&#39;</span><span class="p">)</span>
    <span class="n">site_header</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span>
                                <span class="s2">&quot;: developer admin&quot;</span><span class="p">)</span>
    <span class="n">site_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FORCE_SCRIPT_NAME</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">index_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span>
                                <span class="s1">&#39; developer administration&#39;</span><span class="p">)</span>
    <span class="n">index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_index.html&#39;</span>
    <span class="n">app_index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_app_index.html&#39;</span></div>


<span class="n">dev_admin_site</span> <span class="o">=</span> <span class="n">DevAdminSite</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;devadmin&quot;</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">disable_action</span><span class="p">(</span><span class="s1">&#39;delete_selected&#39;</span><span class="p">)</span>
<span class="c1"># Where no specific DevAdmin version exists, use the MgrAdmin</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">CharityPaymentRecord</span><span class="p">,</span> <span class="n">CharityPaymentRecordMgrAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ClinicianResponse</span><span class="p">,</span> <span class="n">ClinicianResponseDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ConsentMode</span><span class="p">,</span> <span class="n">ConsentModeDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ContactRequest</span><span class="p">,</span> <span class="n">ContactRequestDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">DummyPatientSourceInfo</span><span class="p">,</span> <span class="n">DummyPatientSourceInfoDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Email</span><span class="p">,</span> <span class="n">EmailDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Leaflet</span><span class="p">,</span> <span class="n">LeafletMgrAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Letter</span><span class="p">,</span> <span class="n">LetterDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">PatientLookup</span><span class="p">,</span> <span class="n">PatientLookupDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">PatientResponse</span><span class="p">,</span> <span class="n">PatientResponseDevAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">QueryAudit</span><span class="p">,</span> <span class="n">QueryMgrAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Study</span><span class="p">,</span> <span class="n">StudyMgrAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">TeamRep</span><span class="p">,</span> <span class="n">TeamRepMgrAdmin</span><span class="p">)</span>
<span class="n">dev_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">ExtendedUserMgrAdmin</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Assemble tertiary (researcher) admin site</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="ResearcherAdminSite"><a class="viewcode-back" href="../../../../autodoc/crateweb/core/admin.html#crate_anon.crateweb.core.admin.ResearcherAdminSite">[docs]</a><span class="k">class</span> <span class="nc">ResearcherAdminSite</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">AdminSite</span><span class="p">):</span>
    <span class="n">site_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span>
                               <span class="s1">&#39; researcher admin views&#39;</span><span class="p">)</span>
    <span class="n">site_header</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_TITLE</span> <span class="o">+</span>
                                <span class="s2">&quot;: researcher admin&quot;</span><span class="p">)</span>
    <span class="n">site_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FORCE_SCRIPT_NAME</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">index_title</span> <span class="o">=</span> <span class="n">ugettext_lazy</span><span class="p">(</span><span class="s2">&quot;View/manage your studies&quot;</span><span class="p">)</span>
    <span class="n">index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_index.html&#39;</span>
    <span class="n">app_index_template</span> <span class="o">=</span> <span class="s1">&#39;admin/viewchange_admin_app_index.html&#39;</span></div>


<span class="n">res_admin_site</span> <span class="o">=</span> <span class="n">ResearcherAdminSite</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;resadmin&quot;</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">disable_action</span><span class="p">(</span><span class="s1">&#39;delete_selected&#39;</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Study</span><span class="p">,</span> <span class="n">StudyResAdmin</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Leaflet</span><span class="p">,</span> <span class="n">LeafletResAdmin</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Email</span><span class="p">,</span> <span class="n">EmailResAdmin</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Letter</span><span class="p">,</span> <span class="n">LetterResAdmin</span><span class="p">)</span>
<span class="n">res_admin_site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ContactRequest</span><span class="p">,</span> <span class="n">ContactRequestResAdmin</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Problem with non-superusers not seeing any apps:</span>
<span class="sd">- http://stackoverflow.com/questions/1929707/django-admin-not-seeing-any-app-permission-problem  # noqa</span>
<span class="sd">  ... but django.contrib.auth.backends.ModelBackend won&#39;t load in INSTALLED_APPS  # noqa</span>
<span class="sd">- log.debug(&quot;registered: {}&quot;.format(res_admin_site.is_registered(Leaflet)))</span>
<span class="sd">  ... OK</span>
<span class="sd">  ... and anyway, it works for superusers</span>
<span class="sd">- app_list is blank in the template; this is set in AdminSite.index()</span>
<span class="sd">  (in django/contrib/admin/sites.py)</span>
<span class="sd">  So the failure is either in</span>
<span class="sd">        model_admin.has_module_permission(request)</span>
<span class="sd">            return request.user.has_module_perms(self.opts.app_label)</span>
<span class="sd">    or  model_admin.get_model_perms(request)</span>
<span class="sd">  They&#39;re in django/contrib/admin/options.py; ModelAdmin and BaseModelAdmin</span>

<span class="sd">  From a Werkzeug console in home view:</span>

<span class="sd">    from core.admin import LeafletResAdmin</span>
<span class="sd">    LeafletResAdmin.has_module_permission(request)</span>
<span class="sd">    # ... fails (class not instance!) but shows code, so:</span>
<span class="sd">    request.user.has_module_perms(&#39;resadmin&#39;)</span>
<span class="sd">    # ... False - so HERE&#39;S a problem.</span>

<span class="sd">  Solution: add these to relevant ModelAdmin classes:</span>

<span class="sd">    def has_module_permission(self, request):</span>
<span class="sd">        return request.user.is_staff</span>

<span class="sd">    def has_change_permission(self, request, obj=None):</span>
<span class="sd">        return request.user.is_staff</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>