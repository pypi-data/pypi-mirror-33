
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.crateweb.consent.lookup_rio &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.crateweb.consent.lookup_rio</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/crateweb/consent/lookup_rio.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.dbfunc</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">dictfetchall</span><span class="p">,</span>
    <span class="n">dictfetchone</span><span class="p">,</span>
    <span class="n">genrows</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">MultipleObjectsReturned</span><span class="p">,</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connections</span>

<span class="kn">from</span> <span class="nn">crate_anon.crateweb.consent.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ClinicianInfoHolder</span><span class="p">,</span>
    <span class="n">ConsentMode</span><span class="p">,</span>
    <span class="n">PatientLookup</span><span class="p">,</span>
    <span class="n">TeamRep</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.consent.utils</span> <span class="k">import</span> <span class="n">latest_date</span><span class="p">,</span> <span class="n">to_date</span>
<span class="kn">from</span> <span class="nn">crate_anon.preprocess.rio_constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CRATE_COL_RIO_NUMBER</span><span class="p">,</span>
    <span class="n">RCEP_COL_PATIENT_ID</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Look up patient IDs</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># CPFT RiO (raw -&gt; preprocessed by CRATE)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="lookup_cpft_rio_crate_preprocessed"><a class="viewcode-back" href="../../../../autodoc/crateweb/consent/lookup_rio.html#crate_anon.crateweb.consent.lookup_rio.lookup_cpft_rio_crate_preprocessed">[docs]</a><span class="k">def</span> <span class="nf">lookup_cpft_rio_crate_preprocessed</span><span class="p">(</span><span class="n">lookup</span><span class="p">:</span> <span class="n">PatientLookup</span><span class="p">,</span>
                                       <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                       <span class="n">secret_decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here, we use the version of RiO preprocessed by the CRATE preprocessor.</span>
<span class="sd">    This is almost identical to the RCEP version, saving us some thought and</span>
<span class="sd">    lots of repetition of complex JOIN code to deal with the raw RiO database.</span>

<span class="sd">    However, the CRATE preprocessor does this with views.</span>
<span class="sd">    We would need to index the underlying tables; however, the CRATE</span>
<span class="sd">    processor has also done this for us for the lookup tables, so we</span>
<span class="sd">    don&#39;t need so many.</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        USE my_database_name;</span>

<span class="sd">        CREATE INDEX _idx_cdd_nhs ON ClientIndex (NNN);  -- already in RiO source</span>

<span class="sd">        CREATE INDEX _idx_cnh_id ON ClientName (ClientID);  -- already in RiO source  # noqa</span>
<span class="sd">        CREATE INDEX _idx_cnh_eff ON ClientName (EffectiveDate);  -- ignored</span>
<span class="sd">        CREATE INDEX _idx_cnh_end ON ClientName (EndDate);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_cah_id ON ClientAddress (ClientID);  -- already in RiO source as part of composite index  # noqa</span>
<span class="sd">        CREATE INDEX _idx_cah_from ON ClientAddress (FromDate);  -- ignored</span>
<span class="sd">        CREATE INDEX _idx_cah_to ON ClientAddress (ToDate);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_cch_id ON ClientTelecom (ClientID);  -- already in RiO source as part of composite index  # noqa</span>

<span class="sd">        CREATE INDEX _idx_cgh_id ON ClientHealthCareProvider (ClientID);  -- already in RiO source  # noqa</span>
<span class="sd">        CREATE INDEX _idx_cgh_from ON ClientHealthCareProvider (FromDate);  -- ignored  # noqa</span>
<span class="sd">        CREATE INDEX _idx_cgh_to ON ClientHealthCareProvider (ToDate);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_cc_id ON CPACareCoordinator (ClientID);  -- preprocessor adds this  # noqa</span>
<span class="sd">        CREATE INDEX _idx_cc_start ON CPACareCoordinator (StartDate);  -- ignored</span>
<span class="sd">        CREATE INDEX _idx_cc_end ON CPACareCoordinator (EndDate);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_ref_id ON AmsReferral (ClientID);  -- already in RiO source as part of composite index  # noqa</span>
<span class="sd">        CREATE INDEX _idx_ref_recv ON AmsReferral (ReferralReceivedDate);  -- ignored  # noqa</span>
<span class="sd">        CREATE INDEX _idx_ref_removal ON AmsReferral (RemovalDateTime);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_rsh_id ON AmsReferralAllocation (ClientID);  -- already in RiO source as part of composite index  # noqa</span>
<span class="sd">        CREATE INDEX _idx_rsh_start ON AmsReferralAllocation (StartDate);  -- ignored</span>
<span class="sd">        CREATE INDEX _idx_rsh_end ON AmsReferralAllocation (EndDate);  -- ignored</span>

<span class="sd">        CREATE INDEX _idx_rth_id ON AmsReferralTeam (ClientID);  -- already in RiO source as part of composite index  # noqa</span>
<span class="sd">        CREATE INDEX _idx_rth_start ON AmsReferralTeam (StartDate);  -- ignored</span>
<span class="sd">        CREATE INDEX _idx_rth_end ON AmsReferralTeam (EndDate);  -- ignored</span>

<span class="sd">    ... or alternative RiO number indexes on CRATE_COL_RIO_NUMBER field.</span>

<span class="sd">    Then, the only field name differences from RCEP are:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">        Client_Name_History.End_Date  -- not End_Date_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lookup_cpft_rio_generic</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">decisions</span><span class="p">,</span> <span class="n">secret_decisions</span><span class="p">,</span>
                            <span class="n">as_crate_not_rcep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># CPFT RiO as preprocessed by Servelec RCEP tool</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="lookup_cpft_rio_rcep"><a class="viewcode-back" href="../../../../autodoc/crateweb/consent/lookup_rio.html#crate_anon.crateweb.consent.lookup_rio.lookup_cpft_rio_rcep">[docs]</a><span class="k">def</span> <span class="nf">lookup_cpft_rio_rcep</span><span class="p">(</span><span class="n">lookup</span><span class="p">:</span> <span class="n">PatientLookup</span><span class="p">,</span>
                         <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                         <span class="n">secret_decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **RiO notes, 2015-05-19**</span>

<span class="sd">    ... ADDENDUM 2017-02-27: this is the RiO database as modified by Servelec&#39;s</span>
<span class="sd">    RiO CRIS Extraction Program (RCEP). See also lookup_cpft_rio_raw().</span>

<span class="sd">    For speed, RiO-RCEP needs these indexes:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        USE my_database_name;</span>

<span class="sd">        CREATE INDEX _idx_cdd_nhs ON Client_Demographic_Details (NHS_Number);</span>

<span class="sd">        CREATE INDEX _idx_cnh_id ON Client_Name_History (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_cnh_eff ON Client_Name_History (Effective_Date);</span>
<span class="sd">        CREATE INDEX _idx_cnh_end ON Client_Name_History (End_Date_);</span>

<span class="sd">        CREATE INDEX _idx_cah_id ON Client_Address_History (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_cah_from ON Client_Address_History (Address_From_Date);</span>
<span class="sd">        CREATE INDEX _idx_cah_to ON Client_Address_History (Address_To_Date);</span>

<span class="sd">        CREATE INDEX _idx_cch_id ON Client_Communications_History (Client_ID);</span>

<span class="sd">        CREATE INDEX _idx_cgh_id ON Client_GP_History (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_cgh_from ON Client_GP_History (GP_From_Date);</span>
<span class="sd">        CREATE INDEX _idx_cgh_to ON Client_GP_History (GP_To_Date);</span>

<span class="sd">        CREATE INDEX _idx_cc_id ON CPA_CareCoordinator (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_cc_start ON CPA_CareCoordinator (Start_Date);</span>
<span class="sd">        CREATE INDEX _idx_cc_end ON CPA_CareCoordinator (End_Date);</span>

<span class="sd">        CREATE INDEX _idx_ref_id ON Main_Referral_Data (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_ref_recv ON Main_Referral_Data (Referral_Received_Date);</span>
<span class="sd">        CREATE INDEX _idx_ref_removal ON Main_Referral_Data (Removal_DateTime);</span>

<span class="sd">        CREATE INDEX _idx_rsh_id ON Referral_Staff_History (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_rsh_start ON Referral_Staff_History (Start_Date);</span>
<span class="sd">        CREATE INDEX _idx_rsh_end ON Referral_Staff_History (End_Date);</span>

<span class="sd">        CREATE INDEX _idx_rth_id ON Referral_Team_History (Client_ID);</span>
<span class="sd">        CREATE INDEX _idx_rth_start ON Referral_Team_History (Start_Date);</span>
<span class="sd">        CREATE INDEX _idx_rth_end ON Referral_Team_History (End_Date);</span>

<span class="sd">        -- CREATE INDEX _idx_rth_teamdesc ON Referral_Team_History (Team_Description);  # noqa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lookup_cpft_rio_generic</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">decisions</span><span class="p">,</span> <span class="n">secret_decisions</span><span class="p">,</span>
                            <span class="n">as_crate_not_rcep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># CPFT RiO: function that copes with either the RCEP or the CRATE version,</span>
<span class="c1"># which are extremely similar.</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="lookup_cpft_rio_generic"><a class="viewcode-back" href="../../../../autodoc/crateweb/consent/lookup_rio.html#crate_anon.crateweb.consent.lookup_rio.lookup_cpft_rio_generic">[docs]</a><span class="k">def</span> <span class="nf">lookup_cpft_rio_generic</span><span class="p">(</span><span class="n">lookup</span><span class="p">:</span> <span class="n">PatientLookup</span><span class="p">,</span>
                            <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                            <span class="n">secret_decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                            <span class="n">as_crate_not_rcep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">      Client_Demographic_Details</span>
<span class="sd">          Client_ID -- PK; RiO number; integer in VARCHAR(15) field</span>
<span class="sd">          Date_of_Birth -- DATETIME</span>
<span class="sd">          Date_of_Death -- DATETIME; NULL if not dead</span>
<span class="sd">          Death_Flag -- INT; 0 for alive, 1 for dead</span>
<span class="sd">          Deleted_Flag -- INT; 0 normally; 1 for deleted</span>
<span class="sd">          NHS_Number -- CHAR(10)</span>
<span class="sd">          Gender_Code -- &#39;F&#39;, &#39;M&#39;, &#39;U&#39;, &#39;X&#39;</span>
<span class="sd">          Gender_Description -- &#39;Male&#39;, &#39;Female&#39;, ...</span>

<span class="sd">    Then, linked to it:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">      Client_Name_History</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Effective_Date -- DATETIME</span>
<span class="sd">          End_Date_  -- DATETIME, typically NULL</span>
<span class="sd">                -- in the CRATE version, this is End_Date instead</span>
<span class="sd">          Name_Type_Code  -- &#39;1&#39; for &#39;usual name&#39;, &#39;2&#39; for &#39;Alias&#39;, &#39;3&#39;</span>
<span class="sd">              for &#39;Preferred name&#39;, &#39;4&#39; for &#39;Birth name&#39;, &#39;5&#39; for</span>
<span class="sd">              &#39;Maiden name&#39;, &#39;7&#39; for &#39;Other&#39;, &#39;CM&#39; for &#39;Client Merge&#39;;</span>
<span class="sd">              NVARCHAR(10)</span>
<span class="sd">          Name_Type_Description  -- e.g. &#39;Usual name&#39;, &#39;Alias&#39;</span>
<span class="sd">          Deleted_Flag -- INT</span>

<span class="sd">          title</span>
<span class="sd">          Given_Name_1  -- through to Given_Name_5</span>
<span class="sd">          Family_Name</span>
<span class="sd">          suffix</span>
<span class="sd">          ...</span>

<span class="sd">      Client_Address_History</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Address_Type_Code -- e.g. &#39;PRIMARY&#39; but also &#39;CA&#39;, &#39;FCH&#39;...</span>
<span class="sd">          Address_Type_Description</span>
<span class="sd">          Address_From_Date -- DATETIME</span>
<span class="sd">          Address_To_Date -- DATETIME; NULL for active ones</span>

<span class="sd">          Address_Line_1</span>
<span class="sd">          Address_Line_2</span>
<span class="sd">          Address_Line_3</span>
<span class="sd">          Address_Line_4</span>
<span class="sd">          Address_Line_5</span>
<span class="sd">          Post_Code</span>
<span class="sd">          ... -- no e-mail address field</span>

<span class="sd">      Client_GP_History</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          GP_From_Date -- DATETIME</span>
<span class="sd">          GP_To_Date -- DATETIME; NULL for active ones</span>

<span class="sd">          GP_Name -- e.g. &#39;Smith JT&#39;</span>
<span class="sd">          GP_Practice_Address_Line1</span>
<span class="sd">          GP_Practice_Address_Line2</span>
<span class="sd">          GP_Practice_Address_Line3</span>
<span class="sd">          GP_Practice_Address_Line4</span>
<span class="sd">          GP_Practice_Address_Line5</span>
<span class="sd">          GP_Practice_Post_code</span>
<span class="sd">          ...</span>

<span class="sd">    CPFT clinician details/?discharged info appear to be here:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">      CPA_CareCoordinator</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Start_Date -- DATETIME</span>
<span class="sd">          End_Date -- DATETIME</span>
<span class="sd">          End_Reason_Code</span>
<span class="sd">          End_Reason_Description</span>
<span class="sd">          End_Reason_National_Code</span>

<span class="sd">          Care_Coordinator_User_title</span>
<span class="sd">          Care_Coordinator_User_first_name</span>
<span class="sd">          Care_Coordinator_User_surname</span>
<span class="sd">          Care_Coordinator_User_email</span>
<span class="sd">          Care_Coordinator_User_Consultant_Flag -- INT; 0 or 1 (or NULL?)</span>

<span class="sd">      Main_Referral_Data</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Referral_Received_Date -- DATETIME</span>
<span class="sd">          Removal_DateTime -- DATETIME</span>
<span class="sd">          # Care_Spell_Start_Date</span>
<span class="sd">          # Care_Spell_End_Date -- never non-NULL in our data set</span>
<span class="sd">          # Discharge_HCP -- ??user closing the referral</span>

<span class="sd">          Referred_Consultant_User_title</span>
<span class="sd">          Referred_Consultant_User_first_name</span>
<span class="sd">          Referred_Consultant_User_surname</span>
<span class="sd">          Referred_Consultant_User_email</span>
<span class="sd">          Referred_Consultant_User_Consultant_Flag  -- 0, 1, NULL</span>

<span class="sd">      Referral_Staff_History</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Start_Date -- DATETIME</span>
<span class="sd">          End_Date -- DATETIME</span>
<span class="sd">          Current_At_Discharge -- INT -- ? -- 1 or NULL</span>

<span class="sd">          HCP_User_title</span>
<span class="sd">          HCP_User_first_name</span>
<span class="sd">          HCP_User_surname</span>
<span class="sd">          HCP_User_email</span>
<span class="sd">          HCP_User_Consultant_Flag  -- 0, 1, NULL</span>

<span class="sd">      Referral_Team_History</span>
<span class="sd">              -- similar, but for teams; no individual info</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Start_Date -- DATETIME</span>
<span class="sd">          End_Date -- DATETIME</span>
<span class="sd">          Current_At_Discharge -- INT -- ? -- 1 or NULL</span>

<span class="sd">          Team_Code -- NVARCHAR -- e.g. &#39;TCGMH712&#39;</span>
<span class="sd">          Team_Description -- NVARCHAR -- e.g. &#39;George Mackenzie&#39;</span>
<span class="sd">          Team_Classification_Group_Code -- NVARCHAR -- e.g. &#39;FS&#39;</span>
<span class="sd">          Team_Classification_Group_Description -- NVARCHAR -- e.g.</span>
<span class="sd">                                                          &#39;Forensic Service&#39;</span>

<span class="sd">    Not obviously relevant:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">      Client_CPA -- records CPA start/end, etc.</span>
<span class="sd">      Client_Professional_Contacts -- empty table!</span>

<span class="sd">    Added 2017-02-27:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">      Client_Communications_History -- email/phone</span>
<span class="sd">          Client_ID -- integer in VARCHAR(15)</span>
<span class="sd">          Method_Code -- NVARCHAR(10); &#39;1&#39; for &#39;Telephone number&#39;, &#39;3&#39;</span>
<span class="sd">              for &#39;Email address&#39;, &#39;4&#39; for &#39;Minicom/textphone number&#39;</span>
<span class="sd">          Method_Description</span>
<span class="sd">          Context_Code -- e.g. &#39;1&#39; for &#39;Communication address at home&#39;,</span>
<span class="sd">              other codes for &#39;Vacation home...&#39;, etc.</span>
<span class="sd">          Context_Description</span>
<span class="sd">          Contact_Details -- NVARCHAR(80)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">lookup</span><span class="o">.</span><span class="n">source_db</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">rio_number_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">CRATE_COL_RIO_NUMBER</span> <span class="k">if</span> <span class="n">as_crate_not_rcep</span>
                        <span class="k">else</span> <span class="n">RCEP_COL_PATIENT_ID</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 1. Get RiO PK</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                {rio_number_field}, -- RiO number (PK)</span>
<span class="sd">                -- NHS_Number,</span>
<span class="sd">                Date_of_Birth,</span>
<span class="sd">                Date_of_Death,</span>
<span class="sd">                Death_Flag,</span>
<span class="sd">                -- Deleted_Flag,</span>
<span class="sd">                Gender_Code</span>
<span class="sd">                -- Gender_Description,</span>
<span class="sd">            FROM Client_Demographic_Details</span>
<span class="sd">            WHERE</span>
<span class="sd">                NHS_Number = %s -- CHAR comparison</span>
<span class="sd">                AND (Deleted_Flag IS NULL OR Deleted_Flag = 0)</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">lookup</span><span class="o">.</span><span class="n">nhs_number</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="c1"># Can&#39;t use &quot;NOT Deleted_Flag&quot; with SQL Server; you get</span>
    <span class="c1"># &quot;An expression of non-boolean type specified in a context where a</span>
    <span class="c1"># condition is expected, near &#39;Deleted_Flag&#39;.&quot;</span>
    <span class="c1"># The field is of type INTEGER NULL, but SQL Server won&#39;t auto-cast it</span>
    <span class="c1"># to something boolean.</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;NHS number not found in Client_Demographic_Details table.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Two patients found with that NHS number; aborting.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rio_client_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">rio_number_field</span><span class="p">]</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_local_id_description</span> <span class="o">=</span> <span class="s2">&quot;CPFT RiO number&quot;</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_local_id_number</span> <span class="o">=</span> <span class="n">rio_client_id</span>
    <span class="n">secret_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RiO number: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_client_id</span><span class="p">))</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_dob</span> <span class="o">=</span> <span class="n">to_date</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Date_of_Birth&#39;</span><span class="p">])</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_dod</span> <span class="o">=</span> <span class="n">to_date</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Date_of_Death&#39;</span><span class="p">])</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_dead</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">lookup</span><span class="o">.</span><span class="n">pt_dod</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Death_Flag&#39;</span><span class="p">])</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_sex</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Gender_Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Gender_Code&#39;</span><span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 2. Name</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                title,</span>
<span class="sd">                Given_Name_1,</span>
<span class="sd">                Family_Name</span>
<span class="sd">            FROM Client_Name_History</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Effective_Date &lt;= GETDATE()</span>
<span class="sd">                AND ({end_date_field} IS NULL OR {end_date_field} &gt; GETDATE())</span>
<span class="sd">                AND (Deleted_Flag IS NULL OR Deleted_Flag = 0)</span>
<span class="sd">            ORDER BY Name_Type_Code</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">,</span>
            <span class="n">end_date_field</span><span class="o">=</span><span class="s1">&#39;End_Date&#39;</span> <span class="k">if</span> <span class="n">as_crate_not_rcep</span> <span class="k">else</span> <span class="s1">&#39;End_Date_&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">dictfetchone</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;No name/address information found in Client_Name_History.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_found</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_title</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_first_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Given_Name_1&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_last_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Family_Name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Deal with dodgy case</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_title</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">pt_title</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_first_name</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">pt_first_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">pt_last_name</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">pt_last_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 3. Address</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                Address_Line_1,</span>
<span class="sd">                Address_Line_2,</span>
<span class="sd">                Address_Line_3,</span>
<span class="sd">                Address_Line_4,</span>
<span class="sd">                Address_Line_5,</span>
<span class="sd">                Post_Code</span>
<span class="sd">            FROM Client_Address_History</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Address_From_Date &lt;= GETDATE()</span>
<span class="sd">                AND (Address_To_Date IS NULL</span>
<span class="sd">                     OR Address_To_Date &gt; GETDATE())</span>
<span class="sd">            ORDER BY CASE WHEN Address_Type_Code = &#39;PRIMARY&#39; THEN &#39;1&#39;</span>
<span class="sd">                          ELSE Address_Type_Code END ASC</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">dictfetchone</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No address found in Client_Address_History table.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Address_Line_1&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Address_Line_2&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_3</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Address_Line_3&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_4</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Address_Line_4&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_5</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Address_Line_5&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_address_6</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Post_Code&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 3b. Patient&#39;s e-mail address</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                Contact_Details  -- an e-mail address if Method_Code = 3</span>
<span class="sd">            FROM Client_Communications_History</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Method_Code = 3  -- e-mail address</span>
<span class="sd">                AND Valid_From &lt;= GETDATE()</span>
<span class="sd">                AND (Valid_To IS NULL</span>
<span class="sd">                     OR Valid_To &gt; GETDATE())</span>
<span class="sd">            ORDER BY Context_Code ASC</span>
<span class="sd">                -- 1 = Communication address at home</span>
<span class="sd">                -- 2 = Primary home (after business hours)</span>
<span class="sd">                -- 3 = Vacation home (when person on holiday)</span>
<span class="sd">                -- 4 = Office address</span>
<span class="sd">                -- 6 = Emergency contact</span>
<span class="sd">                -- 8 = Mobile device</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Contact_Details&#39;</span><span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 4. GP</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">as_crate_not_rcep</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                SELECT</span>
<span class="sd">                    GP_Title,</span>
<span class="sd">                    GP_Forename,</span>
<span class="sd">                    GP_Surname,</span>
<span class="sd">                    GP_Practice_Address_Line_1,</span>
<span class="sd">                    GP_Practice_Address_Line_2,</span>
<span class="sd">                    GP_Practice_Address_Line_3,</span>
<span class="sd">                    GP_Practice_Address_Line_4,</span>
<span class="sd">                    GP_Practice_Address_Line_5,</span>
<span class="sd">                    GP_Practice_Post_Code</span>
<span class="sd">                FROM Client_GP_History</span>
<span class="sd">                WHERE</span>
<span class="sd">                    {rio_number_field} = %s</span>
<span class="sd">                    AND GP_From_Date &lt;= GETDATE()</span>
<span class="sd">                    AND (GP_To_Date IS NULL OR GP_To_Date &gt; GETDATE())</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
            <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">dictfetchone</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No GP found in Client_GP_History table.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_title</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Title&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Dr&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_first_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Forename&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_last_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Surname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line_1&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line_2&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_3</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line_3&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_4</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line_4&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_5</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line_5&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_6</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Post_Code&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                SELECT</span>
<span class="sd">                    GP_Name,</span>
<span class="sd">                    GP_Practice_Address_Line1,</span>
<span class="sd">                    GP_Practice_Address_Line2,</span>
<span class="sd">                    GP_Practice_Address_Line3,</span>
<span class="sd">                    GP_Practice_Address_Line4,</span>
<span class="sd">                    GP_Practice_Address_Line5,</span>
<span class="sd">                    GP_Practice_Post_code</span>
<span class="sd">                FROM Client_GP_History</span>
<span class="sd">                WHERE</span>
<span class="sd">                    {rio_number_field} = %s</span>
<span class="sd">                    AND GP_From_Date &lt;= GETDATE()</span>
<span class="sd">                    AND (GP_To_Date IS NULL OR GP_To_Date &gt; GETDATE())</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
            <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">dictfetchone</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No GP found in Client_GP_History table.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">set_gp_name_components</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                          <span class="n">decisions</span><span class="p">,</span> <span class="n">secret_decisions</span><span class="p">)</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line1&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line2&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_3</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line3&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_4</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line4&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_5</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Address_Line5&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">gp_address_6</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP_Practice_Post_code&#39;</span><span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># RiO/RCEP: 5. Clinician, active v. discharged</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># This bit is complicated! We do it last, so we can return upon success.</span>
    <span class="n">clinicians</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[ClinicianInfoHolder]</span>
    <span class="c1">#</span>
    <span class="c1"># (a) Care coordinator?</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">as_crate_not_rcep</span><span class="p">:</span>
        <span class="n">care_co_title_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_Title&#39;</span>
        <span class="n">care_co_forename_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_First_Name&#39;</span>
        <span class="n">care_co_surname_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_Surname&#39;</span>
        <span class="n">care_co_email_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_Email&#39;</span>
        <span class="n">care_co_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_Consultant_Flag&#39;</span>
        <span class="n">care_co_table</span> <span class="o">=</span> <span class="s1">&#39;CPA_Care_Coordinator&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">care_co_title_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_User_title&#39;</span>
        <span class="n">care_co_forename_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_User_first_name&#39;</span>
        <span class="n">care_co_surname_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_User_surname&#39;</span>
        <span class="n">care_co_email_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_User_email&#39;</span>
        <span class="n">care_co_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;Care_Coordinator_User_Consultant_Flag&#39;</span>
        <span class="n">care_co_table</span> <span class="o">=</span> <span class="s1">&#39;CPA_CareCoordinator&#39;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                {care_co_title_field},</span>
<span class="sd">                {care_co_forename_field},</span>
<span class="sd">                {care_co_surname_field},</span>
<span class="sd">                {care_co_email_field},</span>
<span class="sd">                {care_co_consultant_flag_field},</span>
<span class="sd">                Start_Date,</span>
<span class="sd">                End_Date</span>
<span class="sd">            FROM {care_co_table}</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Start_Date &lt;= GETDATE()</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">care_co_title_field</span><span class="o">=</span><span class="n">care_co_title_field</span><span class="p">,</span>
            <span class="n">care_co_forename_field</span><span class="o">=</span><span class="n">care_co_forename_field</span><span class="p">,</span>
            <span class="n">care_co_surname_field</span><span class="o">=</span><span class="n">care_co_surname_field</span><span class="p">,</span>
            <span class="n">care_co_email_field</span><span class="o">=</span><span class="n">care_co_email_field</span><span class="p">,</span>
            <span class="n">care_co_consultant_flag_field</span><span class="o">=</span><span class="n">care_co_consultant_flag_field</span><span class="p">,</span>
            <span class="n">care_co_table</span><span class="o">=</span><span class="n">care_co_table</span><span class="p">,</span>
            <span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
        <span class="n">clinicians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClinicianInfoHolder</span><span class="p">(</span>
            <span class="n">clinician_type</span><span class="o">=</span><span class="n">ClinicianInfoHolder</span><span class="o">.</span><span class="n">CARE_COORDINATOR</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">care_co_title_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">care_co_forename_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">surname</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">care_co_surname_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">care_co_email_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">signatory_title</span><span class="o">=</span><span class="s2">&quot;Care coordinator&quot;</span><span class="p">,</span>
            <span class="n">is_consultant</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">care_co_consultant_flag_field</span><span class="p">]),</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Start_Date&#39;</span><span class="p">],</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;End_Date&#39;</span><span class="p">],</span>
        <span class="p">))</span>
    <span class="c1">#</span>
    <span class="c1"># (b) Active named consultant referral?</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">as_crate_not_rcep</span><span class="p">:</span>
        <span class="n">cons_title_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_Title&#39;</span>
        <span class="n">cons_forename_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_First_Name&#39;</span>
        <span class="n">cons_surname_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_Surname&#39;</span>
        <span class="n">cons_email_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_Email&#39;</span>
        <span class="n">cons_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_Consultant_Flag&#39;</span>
        <span class="n">referral_table</span> <span class="o">=</span> <span class="s1">&#39;Referral&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cons_title_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_User_title&#39;</span>
        <span class="n">cons_forename_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_User_first_name&#39;</span>
        <span class="n">cons_surname_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_User_surname&#39;</span>
        <span class="n">cons_email_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_User_email&#39;</span>
        <span class="n">cons_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;Referred_Consultant_User_Consultant_Flag&#39;</span>
        <span class="n">referral_table</span> <span class="o">=</span> <span class="s1">&#39;Main_Referral_Data&#39;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                {cons_title_field},</span>
<span class="sd">                {cons_forename_field},</span>
<span class="sd">                {cons_surname_field},</span>
<span class="sd">                {cons_email_field},</span>
<span class="sd">                {cons_consultant_flag_field},</span>
<span class="sd">                Referral_Received_Date,</span>
<span class="sd">                Removal_DateTime</span>
<span class="sd">            FROM {referral_table}</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Referral_Received_Date &lt;= GETDATE()</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">cons_title_field</span><span class="o">=</span><span class="n">cons_title_field</span><span class="p">,</span>
            <span class="n">cons_forename_field</span><span class="o">=</span><span class="n">cons_forename_field</span><span class="p">,</span>
            <span class="n">cons_surname_field</span><span class="o">=</span><span class="n">cons_surname_field</span><span class="p">,</span>
            <span class="n">cons_email_field</span><span class="o">=</span><span class="n">cons_email_field</span><span class="p">,</span>
            <span class="n">cons_consultant_flag_field</span><span class="o">=</span><span class="n">cons_consultant_flag_field</span><span class="p">,</span>
            <span class="n">referral_table</span><span class="o">=</span><span class="n">referral_table</span><span class="p">,</span>
            <span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
        <span class="n">clinicians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClinicianInfoHolder</span><span class="p">(</span>
            <span class="n">clinician_type</span><span class="o">=</span><span class="n">ClinicianInfoHolder</span><span class="o">.</span><span class="n">CONSULTANT</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">cons_title_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">cons_forename_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">surname</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">cons_surname_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">cons_email_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">signatory_title</span><span class="o">=</span><span class="s2">&quot;Consultant psychiatrist&quot;</span><span class="p">,</span>
            <span class="n">is_consultant</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">cons_consultant_flag_field</span><span class="p">]),</span>
            <span class="c1"># ... would be odd if this were not true!</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Referral_Received_Date&#39;</span><span class="p">],</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Removal_DateTime&#39;</span><span class="p">],</span>
        <span class="p">))</span>
    <span class="c1">#</span>
    <span class="c1"># (c) Active other named staff referral?</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">as_crate_not_rcep</span><span class="p">:</span>
        <span class="n">hcp_title_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_Title&#39;</span>
        <span class="n">hcp_forename_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_First_Name&#39;</span>
        <span class="n">hcp_surname_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_Surname&#39;</span>
        <span class="n">hcp_email_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_Email&#39;</span>
        <span class="n">hcp_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_Consultant_Flag&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hcp_title_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_User_title&#39;</span>
        <span class="n">hcp_forename_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_User_first_name&#39;</span>
        <span class="n">hcp_surname_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_User_surname&#39;</span>
        <span class="n">hcp_email_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_User_email&#39;</span>
        <span class="n">hcp_consultant_flag_field</span> <span class="o">=</span> <span class="s1">&#39;HCP_User_Consultant_Flag&#39;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                {hcp_title_field},</span>
<span class="sd">                {hcp_forename_field},</span>
<span class="sd">                {hcp_surname_field},</span>
<span class="sd">                {hcp_email_field},</span>
<span class="sd">                {hcp_consultant_flag_field},</span>
<span class="sd">                Start_Date,</span>
<span class="sd">                End_Date</span>
<span class="sd">            FROM Referral_Staff_History</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Start_Date &lt;= GETDATE()</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">hcp_title_field</span><span class="o">=</span><span class="n">hcp_title_field</span><span class="p">,</span>
            <span class="n">hcp_forename_field</span><span class="o">=</span><span class="n">hcp_forename_field</span><span class="p">,</span>
            <span class="n">hcp_surname_field</span><span class="o">=</span><span class="n">hcp_surname_field</span><span class="p">,</span>
            <span class="n">hcp_email_field</span><span class="o">=</span><span class="n">hcp_email_field</span><span class="p">,</span>
            <span class="n">hcp_consultant_flag_field</span><span class="o">=</span><span class="n">hcp_consultant_flag_field</span><span class="p">,</span>
            <span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
        <span class="n">clinicians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClinicianInfoHolder</span><span class="p">(</span>
            <span class="n">clinician_type</span><span class="o">=</span><span class="n">ClinicianInfoHolder</span><span class="o">.</span><span class="n">HCP</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">hcp_title_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">hcp_forename_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">surname</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">hcp_surname_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">hcp_email_field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">signatory_title</span><span class="o">=</span><span class="s2">&quot;Clinician&quot;</span><span class="p">,</span>
            <span class="n">is_consultant</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">hcp_consultant_flag_field</span><span class="p">]),</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Start_Date&#39;</span><span class="p">],</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;End_Date&#39;</span><span class="p">],</span>
        <span class="p">))</span>
    <span class="c1">#</span>
    <span class="c1"># (d) Active team referral?</span>
    <span class="c1">#</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT</span>
<span class="sd">                Team_Description,</span>
<span class="sd">                Start_Date,</span>
<span class="sd">                End_Date</span>
<span class="sd">            FROM Referral_Team_History</span>
<span class="sd">            WHERE</span>
<span class="sd">                {rio_number_field} = %s</span>
<span class="sd">                AND Start_Date &lt;= GETDATE()</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rio_number_field</span><span class="o">=</span><span class="n">rio_number_field</span><span class="p">),</span>
        <span class="p">[</span><span class="n">rio_client_id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
        <span class="n">team_info</span> <span class="o">=</span> <span class="n">ClinicianInfoHolder</span><span class="p">(</span>
            <span class="n">clinician_type</span><span class="o">=</span><span class="n">ClinicianInfoHolder</span><span class="o">.</span><span class="n">TEAM</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">surname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">signatory_title</span><span class="o">=</span><span class="s2">&quot;Clinical team member&quot;</span><span class="p">,</span>
            <span class="n">is_consultant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Start_Date&#39;</span><span class="p">],</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;End_Date&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># We know a team - do we have a team representative?</span>
        <span class="n">team_description</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Team_Description&#39;</span><span class="p">]</span>
        <span class="n">team_summary</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{status}</span><span class="s2"> team </span><span class="si">{desc}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;active&quot;</span> <span class="k">if</span> <span class="n">team_info</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;previous&quot;</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">team_description</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">teamrep</span> <span class="o">=</span> <span class="n">TeamRep</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">team</span><span class="o">=</span><span class="n">team_description</span><span class="p">)</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Clinical team representative found.&quot;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">teamrep</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">title</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">teamrep</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">surname</span> <span class="o">=</span> <span class="n">teamrep</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">teamrep</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">signatory_title</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">signatory_title</span>
            <span class="n">team_info</span><span class="o">.</span><span class="n">is_consultant</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">is_consultant</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No team representative found for &quot;</span>
                             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">team_summary</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">MultipleObjectsReturned</span><span class="p">:</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Confused: &gt;1 team representative found for &quot;</span>
                             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">team_summary</span><span class="p">))</span>
        <span class="n">clinicians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">team_info</span><span class="p">)</span>
        <span class="c1"># We append it even if we can&#39;t find a representative, because it still</span>
        <span class="c1"># carries information about whether the patient is discharged or not.</span>

    <span class="c1"># Re CLINICIAN ADDRESSES:</span>
    <span class="c1"># Candidate tables in RiO:</span>
    <span class="c1"># - OrgContactAddress +/- OrgContactAddressHistory</span>
    <span class="c1"># - OrgOrganisation</span>
    <span class="c1"># - GenPerson &lt;-- THIS. From GenHCP: &quot;This table contains about all HCPs</span>
    <span class="c1">#   registered in RiO. HCP’s personal details (name, address etc.) are</span>
    <span class="c1">#   stored in GenPerson.</span>
    <span class="c1"># - ??GenLocation; ??GenNHSLocation</span>
    <span class="c1">#</span>
    <span class="c1"># So, GenPerson is correct. However, in CPFT, when we</span>
    <span class="c1">#       SELECT * FROM GenPerson WHERE AddressLine2 IS NOT NULL</span>
    <span class="c1"># we get lots of things saying &quot;Agency Staff&quot;, &quot;leaves Trust 17/02/15&quot;,</span>
    <span class="c1"># &quot;changed name from Smith&quot;, &quot;Medical student&quot;, and so on.</span>
    <span class="c1">#</span>
    <span class="c1"># Therefore, our source is simply duff; people are using the fields for</span>
    <span class="c1"># a different purpose.</span>
    <span class="c1"># Therefore, the set_from_clinician_info_holder() function will default</span>
    <span class="c1"># to the RDBM&#39;s address.</span>

    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
    <span class="c1"># OK.</span>
    <span class="c1"># Now we know all relevant recent clinicians, including (potentially) ones</span>
    <span class="c1"># from which the patient has been discharged, and ones that are active.</span>
    <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

    <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> total past/present clinician(s)/team(s) found: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">clinicians</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">clinicians</span><span class="p">)))</span>
    <span class="n">current_clinicians</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clinicians</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">current</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">current_clinicians</span><span class="p">:</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_discharged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_discharge_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Patient not discharged.&quot;</span><span class="p">)</span>
        <span class="n">contactable_curr_clin</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current_clinicians</span>
                                 <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">contactable</span><span class="p">()]</span>
        <span class="c1"># Sorting by two keys: http://stackoverflow.com/questions/11206884</span>
        <span class="c1"># LOW priority: most recent clinician. (Goes first in sort.)</span>
        <span class="c1"># HIGH priority: preferred type of clinician. (Goes last in sort.)</span>
        <span class="c1"># Sort order is: most preferred first.</span>
        <span class="n">contactable_curr_clin</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">contactable_curr_clin</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;clinician_preference_order&#39;</span><span class="p">))</span>  <span class="c1"># noqa</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> contactable active clinician(s) found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">contactable_curr_clin</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">contactable_curr_clin</span><span class="p">:</span>
            <span class="n">chosen_clinician</span> <span class="o">=</span> <span class="n">contactable_curr_clin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lookup</span><span class="o">.</span><span class="n">set_from_clinician_info_holder</span><span class="p">(</span><span class="n">chosen_clinician</span><span class="p">)</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Found active clinician of type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">chosen_clinician</span><span class="o">.</span><span class="n">clinician_type</span><span class="p">))</span>
            <span class="k">return</span>  <span class="c1"># All done!</span>
        <span class="c1"># If we get here, the patient is not discharged, but we haven&#39;t found</span>
        <span class="c1"># a contactable active clinician.</span>
        <span class="c1"># We&#39;ll fall through and check older clinicians for contactability.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">end_date</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clinicians</span><span class="p">]</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_discharged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">pt_discharge_date</span> <span class="o">=</span> <span class="n">latest_date</span><span class="p">(</span><span class="o">*</span><span class="n">end_dates</span><span class="p">)</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Patient discharged.&quot;</span><span class="p">)</span>

    <span class="c1"># We get here either if the patient is discharged, or they&#39;re current but</span>
    <span class="c1"># we can&#39;t contact a current clinician.</span>
    <span class="n">contactable_old_clin</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clinicians</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">contactable</span><span class="p">()]</span>
    <span class="c1"># LOW priority: preferred type of clinician. (Goes first in sort.)</span>
    <span class="c1"># HIGH priority: most recent end date. (Goes last in sort.)</span>
    <span class="c1"># Sort order is: most preferred first.</span>
    <span class="n">contactable_old_clin</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;clinician_preference_order&#39;</span><span class="p">))</span>
    <span class="n">contactable_old_clin</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;end_date&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> contactable previous clinician(s) found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">contactable_old_clin</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">contactable_old_clin</span><span class="p">:</span>
        <span class="n">chosen_clinician</span> <span class="o">=</span> <span class="n">contactable_old_clin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">set_from_clinician_info_holder</span><span class="p">(</span><span class="n">chosen_clinician</span><span class="p">)</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Found previous clinician of type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">chosen_clinician</span><span class="o">.</span><span class="n">clinician_type</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lookup</span><span class="o">.</span><span class="n">clinician_found</span><span class="p">:</span>
        <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Failed to establish contactable clinician.&quot;</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Look up choices about research consent</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Constant strings used in database:</span>
<span class="n">ADULT_WITH_CAPACITY_TEXT</span> <span class="o">=</span> <span class="s2">&quot;16 or over, has capacity&quot;</span>
<span class="n">ADULT_WITH_CAPACITY_CODE</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
<span class="n">ADULT_LACKS_CAPACITY_TEXT</span> <span class="o">=</span> <span class="s2">&quot;16 or over, lacks capacity&quot;</span>
<span class="n">ADULT_LACKS_CAPACITY_CODE</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
<span class="n">CHILD_PARENT_TEXT</span> <span class="o">=</span> <span class="s2">&quot;Under 16, parent/guardian consent&quot;</span>
<span class="n">CHILD_PARENT_CODE</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>
<span class="n">CHILD_GILLICK_TEXT</span> <span class="o">=</span> <span class="s2">&quot;Under 16, “Gillick competent”&quot;</span>
<span class="n">CHILD_GILLICK_CODE</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>  <span class="c1"># by inference; none live yet in raw20171128 DB</span>
<span class="n">DECISION_METHOD_CODE_TO_TEXT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ADULT_WITH_CAPACITY_CODE</span><span class="p">:</span> <span class="n">ADULT_WITH_CAPACITY_TEXT</span><span class="p">,</span>
    <span class="n">ADULT_LACKS_CAPACITY_CODE</span><span class="p">:</span> <span class="n">ADULT_LACKS_CAPACITY_TEXT</span><span class="p">,</span>
    <span class="n">CHILD_PARENT_CODE</span><span class="p">:</span> <span class="n">CHILD_PARENT_TEXT</span><span class="p">,</span>
    <span class="n">CHILD_GILLICK_CODE</span><span class="p">:</span> <span class="n">CHILD_GILLICK_TEXT</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NOT_APPLICABLE_UPPER</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>


<div class="viewcode-block" id="get_latest_consent_mode_from_rio_generic"><a class="viewcode-back" href="../../../../autodoc/crateweb/consent/lookup_rio.html#crate_anon.crateweb.consent.lookup_rio.get_latest_consent_mode_from_rio_generic">[docs]</a><span class="k">def</span> <span class="nf">get_latest_consent_mode_from_rio_generic</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">raw_rio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cpft_datamart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsentMode</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shared function as very similar for the various copies of RiO data.</span>

<span class="sd">    In raw RiO at CPFT, the traffic-light table is UserAssessConsentrd.</span>
<span class="sd">    This is processed regularly into the CPFT Data Warehouse, so that</span>
<span class="sd">    contains very fresh data and is a good choice.</span>

<span class="sd">    For CPFT&#39;s custom consent mode, built into RiO v6, the table copy in</span>
<span class="sd">    the Data Warehouse is:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT</span>
<span class="sd">            [ClientID]  -- VARCHAR(15) NOT NULL; RiO number as text</span>
<span class="sd">            ,[AssessmentDate]  -- DATETIME</span>
<span class="sd">            ,[ReferralNumber]  -- NVARCHAR(20); a small integer as text</span>
<span class="sd">            ,[ResearchContact]  -- NVARCHAR(20); &#39;RED&#39;, &#39;YELLOW&#39;, &#39;GREEN&#39;</span>
<span class="sd">            ,[OptOut]</span>
<span class="sd">                -- BIT; 1 for opt out; NULL (or potentially 0?) for not</span>
<span class="sd">                -- opted out</span>
<span class="sd">            ,[OptOutFromMedicalResearch_AfterDetailsRemoved]</span>
<span class="sd">                -- VARCHAR(1); &#39;Y&#39; for opt out; 9 for not opted out</span>
<span class="sd">                -- identical information to OptOut; OptOut is the simpler</span>
<span class="sd">            ,[PersonActingonBehalf_of_Patient]</span>
<span class="sd">                -- NTEXT, e.g. &#39;Mr Smith&#39; or NULL</span>
<span class="sd">            ,[PersonActingonBehalf_of_Patient_Relation]</span>
<span class="sd">                -- NTEXT, e.g. &#39;Husband&#39; or NULL or &#39;N/A&#39; or &#39;n/a&#39;</span>
<span class="sd">            ,[Personactingonbehalf_address]</span>
<span class="sd">                -- NTEXT, e.g. an address or NULL or &#39;N/A&#39; or &#39;n/a&#39;</span>
<span class="sd">            ,[WhoMakesDecisionFor_Patient]</span>
<span class="sd">                -- NVARCHAR(40), e.g. one of:</span>
<span class="sd">                --  &#39;16 or over, has capacity&#39;</span>
<span class="sd">                --  &#39;16 or over, lacks capacity&#39;</span>
<span class="sd">                --  &#39;Under 16, “Gillick competent”&#39;</span>
<span class="sd">                    -- note left/right double quotes</span>
<span class="sd">                --  &#39;Under 16, parent/guardian consent&#39;</span>
<span class="sd">        FROM [CPFT_DATAMART].[dbo].[ConsentToResearch]</span>
<span class="sd">            -- NB this is on a different CPFT server; see databases.txt</span>

<span class="sd">    Note also: the CPFT_DATAMART database does not provide patient-</span>
<span class="sd">    identifiable information, except PatientOverview_RiO:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT</span>
<span class="sd">            [NHSNumber]     -- VARCHAR(15); NHS number as text</span>
<span class="sd">            ,[ClientID]     -- VARCHAR(15) NOT NULL; RiO number as text</span>
<span class="sd">            ,[PatientName]  -- VARCHAR(202); e.g. &#39;Smith, John&#39;</span>
<span class="sd">            ,[Surname]      -- VARCHAR(100); e.g. &#39;Smith&#39;</span>
<span class="sd">            ,[DOB]          -- DATETIME; time part is zero</span>
<span class="sd">            ,[TeamStartDate]    -- DATETIME</span>
<span class="sd">            ,[TeamName]         -- NVARCHAR(50)</span>
<span class="sd">            ,[ReferralNumber]   -- INT NOT NULL; a small integer</span>
<span class="sd">            ,[LastAttendedApptDate_WithTeam]    -- DATE</span>
<span class="sd">            ,[FutureAppts_WithTeam]     -- DATE; just one despite the name</span>
<span class="sd">            ,[HCPs]</span>
<span class="sd">                -- NVARCHAR(MAX); semicolon-delimited list; e.g.</span>
<span class="sd">                -- &#39;; Alice Smith&#39;</span>
<span class="sd">                -- &#39;; Alice Smith; Bob Jones&#39;</span>
<span class="sd">                -- &#39;; Unknown Consultant&#39;</span>
<span class="sd">        FROM [CPFT_DATAMART].[dbo].[PatientOverviewRiO]</span>

<span class="sd">    In raw RiO at CPFT, the traffic-light table is UserAssessConsentrd.</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT</span>
<span class="sd">            [ClientID]  -- VARCHAR(15); RiO number as text</span>
<span class="sd">            ,[AssessmentDate]  -- DATETIME</span>
<span class="sd">            ,[system_ValidationData]  -- NTEXT; XML style</span>
<span class="sd">            ,[ResearchContact]  -- NVARCHAR(20); &#39;RED&#39;, &#39;YELLOW&#39;, &#39;GREEN&#39;, NULL</span>
<span class="sd">            ,[useemail]  -- BIT (1, 0, NULL)</span>
<span class="sd">            ,[optout]  -- BIT</span>
<span class="sd">            ,[capname]  -- NTEXT</span>
<span class="sd">            ,[capaddress]  -- NTEXT</span>
<span class="sd">            ,[caprelation]  -- NTEXT</span>
<span class="sd">            ,[capacity]  -- VARCHAR(20); e.g. &#39;a&#39;, &#39;b&#39;</span>
<span class="sd">            ,[type12_NoteID]  -- INT NOT NULL; small integer</span>
<span class="sd">            ,[type12_OriginalNoteID]  -- INT; usually NULL</span>
<span class="sd">            ,[type12_DeletedDate]  -- DATETIME; NULL if not deleted</span>
<span class="sd">            ,[type12_UpdatedBy]  -- NVARCHAR(20); username</span>
<span class="sd">            ,[type12_UpdatedDate]  -- DATETIME</span>
<span class="sd">            ,[formref]  -- NVARCHAR(20); typically a small integer as text</span>

<span class="sd">            -- If it&#39;s been preprocessed, also these:</span>
<span class="sd">            ,[crate_pk]         -- in CRATE preprocessed version only; BIGINT</span>
<span class="sd">            ,[crate_rio_number] -- in CRATE preprocessed version only; BIGINT</span>
<span class="sd">        FROM [dbo].[UserAssessconsentrd]</span>

<span class="sd">    The NHS number table is:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT</span>
<span class="sd">            [ClientID]  -- VARCHAR(15); RiO number as text</span>
<span class="sd">            ,[NNN]  -- CHAR(10); NHS number as text</span>
<span class="sd">            -- and lots more</span>
<span class="sd">        FROM [dbo].ClientIndex]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">([</span><span class="n">raw_rio</span><span class="p">,</span> <span class="n">cpft_datamart</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Specify exactly one database type to look up from&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">raw_rio</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT TOP 1  -- guaranteed to be running SQL Server</span>
<span class="s2">                ci.NNN AS nhs_number_text,</span>
<span class="s2">                ci.ClientID AS rio_number_text,</span>
<span class="s2">                cr.AssessmentDate AS decision_date,</span>
<span class="s2">                cr.ResearchContact AS traffic_light, </span>
<span class="s2">                    -- &#39;RED&#39;, &#39;YELLOW&#39;, &#39;GREEN&#39;, NULL</span>
<span class="s2">                cr.useemail AS use_email,</span>
<span class="s2">                cr.optout AS opt_out,  -- 1, 0 (possibly), NULL</span>
<span class="s2">                cr.capacity AS decision_method_code,</span>
<span class="s2">                cr.capname AS representative_name,</span>
<span class="s2">                cr.caprelation AS representative_relation</span>
<span class="s2">            FROM</span>
<span class="s2">                UserAssessconsentrd AS cr</span>
<span class="s2">            INNER JOIN</span>
<span class="s2">                ClientIndex AS ci</span>
<span class="s2">                ON cr.ClientID = ci.ClientID </span>
<span class="s2">            WHERE</span>
<span class="s2">                ci.NNN = </span><span class="si">%s</span><span class="s2">  -- string comparison</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                cr.AssessmentDate DESC</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">cpft_datamart</span><span class="p">:</span>
        <span class="c1"># Old, discarded 2018-06-28:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT TOP 1  -- guaranteed to be running SQL Server</span>
<span class="s2">                po.NHSNumber AS nhs_number_text,</span>
<span class="s2">                po.ClientID AS rio_number_text,</span>
<span class="s2">                cr.AssessmentDate AS decision_date,</span>
<span class="s2">                cr.ResearchContact AS traffic_light,</span>
<span class="s2">                    -- &#39;RED&#39;, &#39;YELLOW&#39;, &#39;GREEN&#39;, NULL</span>
<span class="s2">                0 AS use_email,  -- not in CPFT data warehouse copy</span>
<span class="s2">                cr.OptOut AS opt_out,  -- 1, 0 (possibly), NULL</span>
<span class="s2">                cr.WhoMakesDecisionFor_Patient AS decision_method,</span>
<span class="s2">                cr.PersonActingonBehalf_of_Patient AS representative_name,</span>
<span class="s2">                cr.PersonActingonBehalf_of_Patient_Relation AS representative_relation</span>
<span class="s2">            FROM</span>
<span class="s2">                ConsentToResearch AS cr</span>
<span class="s2">            INNER JOIN</span>
<span class="s2">                PatientOverviewRiO AS po</span>
<span class="s2">                ON cr.ClientID = po.ClientID</span>
<span class="s2">            WHERE</span>
<span class="s2">                po.NHSNumber = </span><span class="si">%s</span><span class="s2">  -- string comparison</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                cr.AssessmentDate DESC</span>
<span class="s2">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
        <span class="c1"># BEWARE &quot;%s&quot; IN SQL COMMENTS! The database backend will crash because</span>
        <span class="c1"># the number of substituted parameters will be wrong.</span>
        <span class="c1"># New as of 2018-06-28:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT TOP 1  -- guaranteed to be running SQL Server</span>
<span class="s2">                cr.NHSNumber AS nhs_number_text,</span>
<span class="s2">                cr.ClientID AS rio_number_text,</span>
<span class="s2">                cr.AssessmentDate AS decision_date,</span>
<span class="s2">                cr.ResearchContact AS traffic_light,</span>
<span class="s2">                    -- &#39;RED&#39;, &#39;YELLOW&#39;, &#39;GREEN&#39;, NULL</span>
<span class="s2">                0 AS use_email,  -- not in CPFT data warehouse copy</span>
<span class="s2">                cr.OptOut AS opt_out,  -- 1, 0 (possibly), NULL</span>
<span class="s2">                cr.WhoMakesDecisionFor_Patient AS decision_method,</span>
<span class="s2">                cr.PersonActingonBehalf_of_Patient AS representative_name,</span>
<span class="s2">                cr.PersonActingonBehalf_of_Patient_Relation AS representative_relation</span>
<span class="s2">            FROM</span>
<span class="s2">                ConsentToResearch AS cr</span>
<span class="s2">            WHERE</span>
<span class="s2">                cr.NHSNumber = </span><span class="si">%s</span><span class="s2">  -- string comparison</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                cr.AssessmentDate DESC</span>
<span class="s2">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Internal bug&quot;</span>  <span class="c1"># makes type checker happy</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">source_db</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nhs_number</span><span class="p">)])</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">dictfetchone</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">decision_date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;decision_date&quot;</span><span class="p">]</span>
    <span class="n">exclude_entirely</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;opt_out&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">use_email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;use_email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">representative_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;representative_name&quot;</span><span class="p">]</span>

    <span class="n">traffic_light</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;traffic_light&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">traffic_light</span><span class="p">:</span>
        <span class="n">traffic_light</span> <span class="o">=</span> <span class="n">traffic_light</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">traffic_light</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ConsentMode</span><span class="o">.</span><span class="n">VALID_CONSENT_MODES</span><span class="p">:</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid traffic light </span><span class="si">{!r}</span><span class="s2">; ignoring&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">traffic_light</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">raw_rio</span><span class="p">:</span>
        <span class="c1"># Raw RiO contains codes.</span>
        <span class="n">dmc</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;decision_method_code&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dmc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DECISION_METHOD_CODE_TO_TEXT</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Decision method code </span><span class="si">{!r}</span><span class="s2"> unknown; ignoring&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dmc</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">DECISION_METHOD_CODE_TO_TEXT</span><span class="p">[</span><span class="n">dmc</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The CPFT Data Warehouse version contains text.</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;decision_method&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DECISION_METHOD_CODE_TO_TEXT</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Decision method </span><span class="si">{!r}</span><span class="s2"> unknown; ignoring&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dm</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">decision_by_other</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">representative_name</span> <span class="ow">and</span>
        <span class="n">representative_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">NOT_APPLICABLE_UPPER</span>
    <span class="p">)</span>
    <span class="c1"># Compare what follows with decision_valid()</span>
    <span class="n">decision_signed_by_patient</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">decision_otherwise_directly_authorized_by_patient</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dm</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ADULT_WITH_CAPACITY_TEXT</span><span class="p">,</span> <span class="n">CHILD_GILLICK_TEXT</span><span class="p">,</span> <span class="n">CHILD_PARENT_TEXT</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">decision_under16_signed_by_parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span> <span class="o">==</span> <span class="n">CHILD_PARENT_TEXT</span><span class="p">)</span>
    <span class="n">decision_under16_signed_by_clinician</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span> <span class="o">==</span> <span class="n">CHILD_GILLICK_TEXT</span><span class="p">)</span>
    <span class="c1"># ... the clinician has had to verify Gillick competence</span>
    <span class="n">decision_lack_capacity_signed_by_representative</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># not strictly &quot;signed&quot;, but authorized directly by</span>
        <span class="n">dm</span> <span class="o">==</span> <span class="n">ADULT_LACKS_CAPACITY_TEXT</span> <span class="ow">and</span> <span class="n">decision_by_other</span>
    <span class="p">)</span>
    <span class="n">decision_lack_capacity_signed_by_clinician</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dm</span> <span class="o">==</span> <span class="n">ADULT_LACKS_CAPACITY_TEXT</span>
    <span class="p">)</span>  <span class="c1"># ... similarly verified by clinician</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="n">ConsentMode</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="o">=</span><span class="n">nhs_number</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">decision_date</span><span class="p">,</span>
        <span class="c1"># ... important that this date matches the source, not &quot;now&quot;. For</span>
        <span class="c1">#   example, if the clinical record copy comes from time T1, and</span>
        <span class="c1">#   we check it at T3, but then data from T2 comes in later, we</span>
        <span class="c1">#   want to recognize that T2 data is newer than what we have (so</span>
        <span class="c1">#   the CRATE copy should be timestamped T2, not T3).</span>
        <span class="n">exclude_entirely</span><span class="o">=</span><span class="n">exclude_entirely</span><span class="p">,</span>
        <span class="n">consent_mode</span><span class="o">=</span><span class="n">traffic_light</span><span class="p">,</span>
        <span class="n">prefers_email</span><span class="o">=</span><span class="n">use_email</span><span class="p">,</span>
        <span class="n">decision_signed_by_patient</span><span class="o">=</span><span class="n">decision_signed_by_patient</span><span class="p">,</span>
        <span class="n">decision_otherwise_directly_authorized_by_patient</span><span class="o">=</span><span class="n">decision_otherwise_directly_authorized_by_patient</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">decision_under16_signed_by_parent</span><span class="o">=</span><span class="n">decision_under16_signed_by_parent</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">decision_under16_signed_by_clinician</span><span class="o">=</span><span class="n">decision_under16_signed_by_clinician</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">decision_lack_capacity_signed_by_representative</span><span class="o">=</span><span class="n">decision_lack_capacity_signed_by_representative</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="n">decision_lack_capacity_signed_by_clinician</span><span class="o">=</span><span class="n">decision_lack_capacity_signed_by_clinician</span><span class="p">,</span>  <span class="c1"># noqa</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cm</span></div>


<span class="k">def</span> <span class="nf">get_latest_consent_mode_from_rio_cpft_datamart</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsentMode</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">get_latest_consent_mode_from_rio_generic</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="o">=</span><span class="n">nhs_number</span><span class="p">,</span>
        <span class="n">source_db</span><span class="o">=</span><span class="n">source_db</span><span class="p">,</span>
        <span class="n">decisions</span><span class="o">=</span><span class="n">decisions</span><span class="p">,</span>
        <span class="n">cpft_datamart</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_latest_consent_mode_from_rio_raw</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">decisions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsentMode</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">get_latest_consent_mode_from_rio_generic</span><span class="p">(</span>
        <span class="n">nhs_number</span><span class="o">=</span><span class="n">nhs_number</span><span class="p">,</span>
        <span class="n">source_db</span><span class="o">=</span><span class="n">source_db</span><span class="p">,</span>
        <span class="n">decisions</span><span class="o">=</span><span class="n">decisions</span><span class="p">,</span>
        <span class="n">raw_rio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<div class="viewcode-block" id="gen_opt_out_pids_mpids_rio_generic"><a class="viewcode-back" href="../../../../autodoc/crateweb/consent/lookup_rio.html#crate_anon.crateweb.consent.lookup_rio.gen_opt_out_pids_mpids_rio_generic">[docs]</a><span class="k">def</span> <span class="nf">gen_opt_out_pids_mpids_rio_generic</span><span class="p">(</span>
        <span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">raw_rio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cpft_datamart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                                  <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates (pid, mpid) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">([</span><span class="n">raw_rio</span><span class="p">,</span> <span class="n">cpft_datamart</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Specify exactly one database type to look up from&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">raw_rio</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                ci.ClientID AS rio_number_text,</span>
<span class="s2">                ci.NNN AS nhs_number_text</span>
<span class="s2">            FROM</span>
<span class="s2">                UserAssessconsentrd AS cr</span>
<span class="s2">            INNER JOIN</span>
<span class="s2">                ClientIndex AS ci</span>
<span class="s2">                ON cr.ClientID = ci.ClientID </span>
<span class="s2">            WHERE</span>
<span class="s2">                cr.optout = 1</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                cr.ClientID</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">cpft_datamart</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                po.ClientID AS rio_number_text,</span>
<span class="s2">                po.NHSNumber AS nhs_number_text</span>
<span class="s2">            FROM</span>
<span class="s2">                ConsentToResearch AS cr</span>
<span class="s2">            INNER JOIN</span>
<span class="s2">                PatientOverviewRiO AS po</span>
<span class="s2">                ON cr.ClientID = po.ClientID </span>
<span class="s2">            WHERE</span>
<span class="s2">                cr.OptOut = 1</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                cr.ClientID</span>
<span class="s2">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Internal bug&quot;</span>  <span class="c1"># makes type checker happy</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">source_db</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">genrows</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># RiO number, as text</span>
        <span class="n">mpid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># NHS number, as text</span>
        <span class="k">yield</span> <span class="n">pid</span><span class="p">,</span> <span class="n">mpid</span></div>


<span class="k">def</span> <span class="nf">gen_opt_out_pids_mpids_rio_cpft_datamart</span><span class="p">(</span><span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">gen_opt_out_pids_mpids_rio_generic</span><span class="p">(</span>
        <span class="n">source_db</span><span class="o">=</span><span class="n">source_db</span><span class="p">,</span>
        <span class="n">cpft_datamart</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_opt_out_pids_mpids_rio_raw</span><span class="p">(</span><span class="n">source_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">gen_opt_out_pids_mpids_rio_generic</span><span class="p">(</span>
        <span class="n">source_db</span><span class="o">=</span><span class="n">source_db</span><span class="p">,</span>
        <span class="n">raw_rio</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>