
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.1. Research queries &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10. Ancillary tools" href="../misc/ancillary_tools.html" />
    <link rel="prev" title="9. Using the CRATE web interface" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../misc/ancillary_tools.html" title="10. Ancillary tools"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="9. Using the CRATE web interface"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">9. Using the CRATE web interface</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="research-queries">
<h1>9.1. Research queries<a class="headerlink" href="#research-queries" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Research queries use the database connection specified as
<code class="docutils literal notranslate"><span class="pre">DATABASES['research']</span></code> in the Django settings. If users are to see &gt;1
database, this connection must have appropriate privileges, <strong>and read-only
access,</strong> or research users might alter or destroy data.</p>
</div>
<p>Users can use raw SQL, or some automatic methods of building queries.</p>
<div class="section" id="raw-sql-mode">
<h2>9.1.1. Raw SQL mode<a class="headerlink" href="#raw-sql-mode" title="Permalink to this headline">¶</a></h2>
<p>Here, users can edit and save/load SQL queries, run them, and view/save the
tabular output.</p>
<p>They can apply coloured highlighters to specific text occurring anywhere (e.g.
to make it easy to spot the word ‘depression’ in long paragraphs of text).</p>
</div>
<div class="section" id="query-builder">
<h2>9.1.2. Query builder<a class="headerlink" href="#query-builder" title="Permalink to this headline">¶</a></h2>
<p>The administrator tells the web site about one or several databases that are
accessible via the database connection, including how tables should be linked
on patient (via research IDs), within and across databases. The query builder
assists the user to build simple SELECT / FROM / JOIN / WHERE queries in SQL,
which can be run directly or edited further.</p>
</div>
<div class="section" id="patient-finder">
<h2>9.1.3. Patient finder<a class="headerlink" href="#patient-finder" title="Permalink to this headline">¶</a></h2>
<p>Following the CRIS web front end, it can sometimes be helpful to view specific
records <em>for patients</em> meeting specific criteria. The CRIS system uses XML data
for its web front end, and that XML is organized on a per-patient basis, so its
logical organization is: (a) specify criteria that each <em>patient</em> must meet;
(b) specify fields shown for <em>those patients</em>; and (c) present them in a
non-standard tabular form, essentially laying out multiple tables side by side
<a class="footnote-reference" href="#crisquerylayout" id="id1">[1]</a>.</p>
<p>From CRATE’s perspective, operating with relational databases directly, there
are two ways of approaching  this problem – particularly part (c). The first is
a UNION query <a class="footnote-reference" href="#unionexample" id="id2">[2]</a>; this allows plain SQL, but doesn’t sit well
with attempts to preserve multi-column table information (because all SELECT
statements contributing to a UNION must have the same number of columns). The
second is to fetch results from multiple tables separately and combine/present
them in Python, using ‘patient’ as the explicit basis.</p>
<p>The first option is always available for manual use, because CRATE supports
arbitrary SQL queries.</p>
<p>The second option is supported in a more friendly fashion. The logical steps
are:</p>
<ul class="simple">
<li>A <em>patient ID query</em> is built. Patient IDs are found, using the RID/TRID,
according to selection criteria specified by the user. For example, one can
specify <code class="docutils literal notranslate"><span class="pre">diagnosis</span> <span class="pre">LIKE</span> <span class="pre">'F20%'</span></code> to find records of patients with an ICD-10
code starting with F20 (schizophrenia). The patient-finding is done by
checking for at least one such record. If multiple criteria are specified,
they are joined as desired (e.g. with AND or OR) <a class="footnote-reference" href="#patientidquery" id="id3">[3]</a>.</li>
<li>Output fields are specified (e.g. diagnosis from the diagnosis table;
progress notes from the progress notes table).</li>
<li>CRATE runs one query <em>per table</em>; essentially, <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">specified_fields</span> <span class="pre">FROM</span>
<span class="pre">one_of_the_tables</span> <span class="pre">WHERE</span> <span class="pre">rid</span> <span class="pre">IN</span> <span class="pre">(patient_id_query)</span></code>.</li>
<li>CRATE displays several tables jointly: from left to right, <cite>patient_id |
table1 | table2</cite>, split into meta-rows by patient ID. For saving, it creates
a XLSX spreadsheet.</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="crisquerylayout" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>For example, if you ask it to present patient research IDs, diagnoses, and
notes, then if patient 1 has three diagnoses and 10 notes, you might get
the patient number in column 1; the first 10 rows are for that patient; the
‘diagnosis’ column has three entries; the ‘notes’ column has 10 entries.
This is quite different from a simple SQL JOIN, which would attempt to
create rows for every combination (here, 3 diagnoses × 10 notes = 30 rows
for that patient).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="unionexample" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><p class="first">For example:</p>
<div class="last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="n">rid</span><span class="p">,</span>
    <span class="s1">&#39;diagnosis&#39;</span> <span class="k">AS</span> <span class="k">column_name</span><span class="p">,</span>
    <span class="n">diagnosis</span> <span class="k">AS</span> <span class="n">value</span>
<span class="k">FROM</span> <span class="n">diagnosis_table</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">rid</span> <span class="k">FROM</span> <span class="n">some_table</span> <span class="k">WHERE</span> <span class="n">some_criterion</span><span class="p">)</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>
    <span class="n">rid</span><span class="p">,</span>
    <span class="s1">&#39;note&#39;</span> <span class="k">AS</span> <span class="k">column_name</span><span class="p">,</span>
    <span class="n">note</span> <span class="k">AS</span> <span class="n">value</span>
<span class="k">FROM</span> <span class="n">progress_note_table</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">rid</span> <span class="k">FROM</span> <span class="n">some_table</span> <span class="k">WHERE</span> <span class="n">some_criterion</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="patientidquery" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><p class="first">For example:</p>
<div class="last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">mrid</span>
<span class="k">FROM</span> <span class="n">master_id_table</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">diagnosis_table</span>
    <span class="k">ON</span> <span class="n">diagnosis_table</span><span class="p">.</span><span class="n">trid</span>  <span class="o">=</span> <span class="n">master_id_table</span><span class="p">.</span><span class="n">trid</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">progress_note_table</span>
    <span class="k">ON</span> <span class="n">progress_note_table</span><span class="p">.</span><span class="n">trid</span> <span class="o">=</span> <span class="n">master_id_table</span><span class="p">.</span><span class="n">trid</span>
<span class="k">WHERE</span>
    <span class="n">diagnosis_table</span><span class="p">.</span><span class="n">diagnosis</span> <span class="k">LIKE</span> <span class="s1">&#39;F20%&#39;</span>
    <span class="k">AND</span> <span class="n">progress_note_table</span><span class="p">.</span><span class="n">note</span> <span class="k">LIKE</span> <span class="s1">&#39;%depression%&#39;</span>
<span class="p">;</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">9. Using the CRATE web interface</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">9.1. Research queries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">9. Using the CRATE web interface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../misc/ancillary_tools.html"
                        title="next chapter">10. Ancillary tools</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/website_using/research_queries.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../misc/ancillary_tools.html" title="10. Ancillary tools"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="9. Using the CRATE web interface"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >9. Using the CRATE web interface</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>