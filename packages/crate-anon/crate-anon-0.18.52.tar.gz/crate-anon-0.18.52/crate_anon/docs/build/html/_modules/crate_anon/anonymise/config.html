
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.anonymise.config &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.anonymise.config</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/anonymise/config.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">Config class for CRATE anonymiser.</span>

<span class="sd">Thoughts on configuration method</span>

<span class="sd">-   First version used a Config() class, which initializes with blank values.</span>
<span class="sd">    The anonymise_cli.py file creates a config singleton and passes it around.</span>
<span class="sd">    Then when its set() method is called, it reads a config file and</span>
<span class="sd">    instantiates its settings.</span>
<span class="sd">    An option exists to print a draft config without ever reading one from</span>
<span class="sd">    disk.</span>

<span class="sd">    Advantage: easy to start the program without a valid config file (e.g. to</span>
<span class="sd">        print one).</span>
<span class="sd">    Disadvantage: modules can&#39;t be sure that a config is properly instantiated</span>
<span class="sd">        before they are loaded, so you can&#39;t easily define a class according to</span>
<span class="sd">        config settings (you&#39;d have to have a class factory, which gets ugly).</span>

<span class="sd">-   The Django method is to have a configuration file (e.g. settings.py, which</span>
<span class="sd">    can import from other things) that is read by Django and then becomes</span>
<span class="sd">    importable by anything at startup as &quot;django.conf.settings&quot;. (I&#39;ve added</span>
<span class="sd">    local settings via an environment variable.) The way Django knows where</span>
<span class="sd">    to look is via this in manage.py:</span>

<span class="sd">        os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;,</span>
<span class="sd">                              &quot;crate_anon.crateweb.config.settings&quot;)</span>

<span class="sd">    Advantage: setting the config file via an environment variable (read when</span>
<span class="sd">        the config file loads) allows guaranteed config existence as other</span>
<span class="sd">        modules start.</span>
<span class="sd">    Further advantage: config filenames not on command line, therefore not</span>
<span class="sd">        visible to ps.</span>
<span class="sd">    Disadvantage: how do you override with a command-line (argparse) setting?</span>
<span class="sd">        ... though: who cares?</span>
<span class="sd">    To print a config using that file: raise an exception on nonexistent</span>
<span class="sd">        config, and catch it with a special entry point script.</span>

<span class="sd">-   See also</span>
<span class="sd">    http://stackoverflow.com/questions/7443366/argument-passing-strategy-environment-variables-vs-command-line  # noqa</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.hash</span> <span class="k">import</span> <span class="n">GenericHasher</span><span class="p">,</span> <span class="n">make_hasher</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">remove_all_logger_handlers</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.rnc_db</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ensure_valid_field_name</span><span class="p">,</span>
    <span class="n">ensure_valid_table_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.schema</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">hack_in_mssql_xml_type</span><span class="p">,</span>
    <span class="n">is_sqlatype_integer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sizeformatter</span> <span class="k">import</span> <span class="n">sizeof_fmt</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.insert_on_duplicate</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">monkeypatch_TableClause</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">regex</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">BigInteger</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mssql.base</span> <span class="k">import</span> <span class="n">dialect</span> <span class="k">as</span> <span class="n">mssql_dialect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql.base</span> <span class="k">import</span> <span class="n">dialect</span> <span class="k">as</span> <span class="n">mysql_dialect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.base</span> <span class="k">import</span> <span class="n">Engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.sqltypes</span> <span class="k">import</span> <span class="n">TypeEngine</span>

<span class="kn">from</span> <span class="nn">crate_anon.anonymise.constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CONFIG_ENV_VAR</span><span class="p">,</span>
    <span class="n">DEFAULT_CHUNKSIZE</span><span class="p">,</span>
    <span class="n">DEFAULT_REPORT_EVERY</span><span class="p">,</span>
    <span class="n">DEFAULT_MAX_ROWS_BEFORE_COMMIT</span><span class="p">,</span>
    <span class="n">DEFAULT_MAX_BYTES_BEFORE_COMMIT</span><span class="p">,</span>
    <span class="n">SEP</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.dd</span> <span class="k">import</span> <span class="n">DataDictionary</span>
<span class="kn">from</span> <span class="nn">crate_anon.anonymise.scrub</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">NonspecificScrubber</span><span class="p">,</span>
    <span class="n">WordList</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.extendedconfigparser</span> <span class="k">import</span> <span class="n">ExtendedConfigParser</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.sql</span> <span class="k">import</span> <span class="n">TransactionSizeLimiter</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">crate_anon.anonymise.dbholder</span> <span class="k">import</span> <span class="n">DatabaseHolder</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># The Config class is loaded very early, via the nasty singleton.</span>
<span class="c1"># This is therefore the appropriate moment to make any changes to SQLAlchemy.</span>
<span class="n">monkeypatch_TableClause</span><span class="p">()</span>
<span class="n">hack_in_mssql_xml_type</span><span class="p">()</span>  <span class="c1"># support XML type under SQL Server</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Config/databases</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="DatabaseSafeConfig"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.DatabaseSafeConfig">[docs]</a><span class="k">class</span> <span class="nc">DatabaseSafeConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class representing non-sensitive configuration information about a</span>
<span class="sd">    source database.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">ExtendedConfigParser</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read from a configparser section.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config missing section: &quot;</span> <span class="o">+</span> <span class="n">section</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_str</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_multiline</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_words</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_str_list</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">as_words</span><span class="o">=</span><span class="n">as_words</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_bool</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_int</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_int_default_if_failure</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_multiline_csv_pairs</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">as_words</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For option </span><span class="si">{}</span><span class="s2">: specify items as a list &quot;</span>
                                     <span class="s2">&quot;of comma-separated pairs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                <span class="n">d</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_omit_by_default</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_omit_by_default&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_omit_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_omit_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_include_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_include_fields&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_allow_no_patient_info</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_allow_no_patient_info&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;ddgen_per_table_pid_field&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_add_per_table_pids_to_scrubber</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_add_per_table_pids_to_scrubber&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;ddgen_master_pid_fieldname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_blacklist</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_table_blacklist&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_whitelist</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_table_whitelist&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_require_field_absolute</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_table_require_field_absolute&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_require_field_conditional</span> <span class="o">=</span> <span class="n">opt_multiline_csv_pairs</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_table_require_field_conditional&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_field_blacklist</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_field_blacklist&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_field_whitelist</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_field_whitelist&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_pk_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_pk_fields&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_constant_content</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_constant_content&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_constant_content_tables</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_constant_content_tables&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_nonconstant_content_tables</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_nonconstant_content_tables&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_addition_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span><span class="s1">&#39;ddgen_addition_only&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_addition_only_tables</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;ddgen_addition_only_tables&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_deletion_possible_tables</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_deletion_possible_tables&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_pid_defining_fieldnames</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_pid_defining_fieldnames&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubsrc_patient_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubsrc_patient_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubsrc_thirdparty_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubsrc_thirdparty_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubsrc_thirdparty_xref_pid_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubsrc_thirdparty_xref_pid_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_required_scrubsrc_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_required_scrubsrc_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubmethod_code_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubmethod_code_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubmethod_date_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubmethod_date_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubmethod_number_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubmethod_number_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_scrubmethod_phrase_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_scrubmethod_phrase_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_safe_fields_exempt_from_scrubbing</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_safe_fields_exempt_from_scrubbing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_min_length_for_scrubbing</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_min_length_for_scrubbing&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_truncate_date_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_truncate_date_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_filename_to_text_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_filename_to_text_fields&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin2text_dict</span> <span class="o">=</span> <span class="n">opt_multiline_csv_pairs</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_binary_to_text_field_pairs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_skip_row_if_extract_text_fails_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_skip_row_if_extract_text_fails_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_rename_tables_remove_suffixes</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_rename_tables_remove_suffixes&#39;</span><span class="p">,</span> <span class="n">as_words</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_index_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;ddgen_index_fields&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_allow_fulltext_indexing</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_allow_fulltext_indexing&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_force_lower_case</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span><span class="s1">&#39;ddgen_force_lower_case&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_convert_odd_chars_to_underscore</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_convert_odd_chars_to_underscore&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_row_limit</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;debug_row_limit&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_limited_tables</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;debug_limited_tables&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_patient_opt_out_fields</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_patient_opt_out_fields&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_extra_hash_fields</span> <span class="o">=</span> <span class="n">opt_multiline_csv_pairs</span><span class="p">(</span>
            <span class="s1">&#39;ddgen_extra_hash_fields&#39;</span><span class="p">)</span>
        <span class="c1"># ... key: fieldspec</span>
        <span class="c1"># ... value: hash_config_section_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pidtype</span> <span class="o">=</span> <span class="n">BigInteger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpidtype</span> <span class="o">=</span> <span class="n">BigInteger</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_table_blacklisted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">white</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_whitelist</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">white</span><span class="p">),</span> <span class="n">regex</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">black</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_blacklist</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">black</span><span class="p">),</span> <span class="n">regex</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">is_field_blacklisted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">white</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_field_whitelist</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">white</span><span class="p">),</span> <span class="n">regex</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">black</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_field_blacklist</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">black</span><span class="p">),</span> <span class="n">regex</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">does_table_fail_minimum_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">abs_req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_require_field_absolute</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">abs_req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table fails minimum field requirements: no column &quot;</span>
                          <span class="s2">&quot;named </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">abs_req</span><span class="p">)))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">if_field</span><span class="p">,</span> <span class="n">then_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddgen_table_require_field_conditional</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># noqa</span>
            <span class="k">if</span> <span class="n">if_field</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="ow">and</span> <span class="n">then_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table fails minimum field requirements: field </span><span class="si">{}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;present but field </span><span class="si">{}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;absent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">if_field</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">then_field</span><span class="p">)))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># ExtraHashconfig</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_extra_hasher"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.get_extra_hasher">[docs]</a><span class="k">def</span> <span class="nf">get_extra_hasher</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">ExtendedConfigParser</span><span class="p">,</span>
                     <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericHasher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read from a configparser section.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config missing section: &quot;</span> <span class="o">+</span> <span class="n">section</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">opt_str</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">hash_method</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s2">&quot;hash_method&quot;</span><span class="p">)</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_hasher</span><span class="p">(</span><span class="n">hash_method</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Config</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class representing the main configuration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_databases</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read config from file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get filename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">CONFIG_ENV_VAR</span><span class="p">]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;You must set the </span><span class="si">{}</span><span class="s2"> environment variable to point to a CRATE &quot;</span>
                <span class="s2">&quot;anonymisation config file, or specify it on the command &quot;</span>
                <span class="s2">&quot;line. Run crate_print_demo_anon_config &quot;</span>
                <span class="s2">&quot;to see a specimen config.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONFIG_ENV_VAR</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Read config from file.</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ExtendedConfigParser</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading config file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
        <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span>

        <span class="k">def</span> <span class="nf">opt_str</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_multiline</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_str_list</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_multiline_int</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">minimum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">maximum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_int_list</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="n">minimum</span><span class="p">,</span>
                                       <span class="n">maximum</span><span class="o">=</span><span class="n">maximum</span><span class="p">,</span> <span class="n">suppress_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_bool</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_int</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_int_default_if_failure</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">opt_pyvalue_list</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_pyvalue_list</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_database</span><span class="p">(</span><span class="n">section_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">srccfg_</span><span class="p">:</span> <span class="n">DatabaseSafeConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">with_session</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">with_conn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">reflect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseHolder&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_database</span><span class="p">(</span><span class="n">section_</span><span class="p">,</span>
                                       <span class="n">dbname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">srccfg</span><span class="o">=</span><span class="n">srccfg_</span><span class="p">,</span>
                                       <span class="n">with_session</span><span class="o">=</span><span class="n">with_session</span><span class="p">,</span>
                                       <span class="n">with_conn</span><span class="o">=</span><span class="n">with_conn</span><span class="p">,</span>
                                       <span class="n">reflect</span><span class="o">=</span><span class="n">reflect</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_sqlatype</span><span class="p">(</span><span class="n">sqlatype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">TypeEngine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeEngine</span><span class="p">:</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Since we might have to return String(length=...), we have to return</span>
<span class="sd">            an instance, not a class.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sqlatype</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">sqlatype</span> <span class="o">==</span> <span class="s2">&quot;BigInteger&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BigInteger</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;String\((\d+)\)&quot;</span><span class="p">)</span>  <span class="c1"># e.g. String(50)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sqlatype</span><span class="p">)</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad SQLAlchemy type specification for &quot;</span>
                                 <span class="s2">&quot;PID/MPID columns: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sqlatype</span><span class="p">)))</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Data dictionary</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dictionary_filename</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;data_dictionary_filename&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Critical field types</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pidtype</span> <span class="o">=</span> <span class="n">get_sqlatype</span><span class="p">(</span><span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;sqlatype_pid&#39;</span><span class="p">),</span> <span class="n">BigInteger</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidtype_is_integer</span> <span class="o">=</span> <span class="n">is_sqlatype_integer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpidtype</span> <span class="o">=</span> <span class="n">get_sqlatype</span><span class="p">(</span><span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;sqlatype_mpid&#39;</span><span class="p">),</span> <span class="n">BigInteger</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpidtype_is_integer</span> <span class="o">=</span> <span class="n">is_sqlatype_integer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpidtype</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Encryption phrases/passwords</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hash_method</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;hash_method&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_table_patient_id_encryption_phrase</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;per_table_patient_id_encryption_phrase&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_patient_id_encryption_phrase</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;master_patient_id_encryption_phrase&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_detection_encryption_phrase</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;change_detection_encryption_phrase&#39;</span><span class="p">)</span>
        <span class="n">_extra_hash_config_section_names</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s2">&quot;extra_hash_config_sections&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extra_hashers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, GenericHasher]</span>
        <span class="k">for</span> <span class="n">hasher_name</span> <span class="ow">in</span> <span class="n">_extra_hash_config_section_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_hashers</span><span class="p">[</span><span class="n">hasher_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_extra_hasher</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span>
                                                               <span class="n">hasher_name</span><span class="p">)</span>
        <span class="c1"># Load encryption keys and create hashers</span>
        <span class="n">dummyhash</span> <span class="o">=</span> <span class="n">make_hasher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_method</span><span class="p">,</span> <span class="s2">&quot;dummysalt&quot;</span><span class="p">)</span>
        <span class="n">encrypted_length</span> <span class="o">=</span> <span class="n">dummyhash</span><span class="o">.</span><span class="n">output_length</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SqlTypeEncryptedPid</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">encrypted_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqltype_encrypted_pid_as_sql</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SqlTypeEncryptedPid</span><span class="p">)</span>
        <span class="c1"># ... VARCHAR(32) for MD5; VARCHAR(64) for SHA-256; VARCHAR(128) for</span>
        <span class="c1"># SHA-512.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_table_patient_id_encryption_phrase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing per_table_patient_id_encryption_phrase&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_pid_hasher</span> <span class="o">=</span> <span class="n">make_hasher</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_table_patient_id_encryption_phrase</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_patient_id_encryption_phrase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing master_patient_id_encryption_phrase&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_pid_hasher</span> <span class="o">=</span> <span class="n">make_hasher</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_patient_id_encryption_phrase</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_detection_encryption_phrase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing change_detection_encryption_phrase&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_detection_hasher</span> <span class="o">=</span> <span class="n">make_hasher</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_detection_encryption_phrase</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Text extraction</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_case_sensitive</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;extract_text_extensions_case_sensitive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;extract_text_extensions_permitted&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_prohibited</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span>
            <span class="s1">&#39;extract_text_extensions_prohibited&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_plain</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span><span class="s1">&#39;extract_text_plain&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_width</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;extract_text_width&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Anonymisation</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">replace_patient_info_with</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;replace_patient_info_with&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_third_party_info_with</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;replace_third_party_info_with&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_nonspecific_info_with</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;replace_nonspecific_info_with&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thirdparty_xref_max_depth</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;thirdparty_xref_max_depth&#39;</span><span class="p">,</span>
                                                 <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_max_regex_errors</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;string_max_regex_errors&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_string_length_for_errors</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span>
            <span class="s1">&#39;min_string_length_for_errors&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_string_length_to_scrub_with</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span>
            <span class="s1">&#39;min_string_length_to_scrub_with&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_all_uk_postcodes</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span><span class="s1">&#39;scrub_all_uk_postcodes&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_codes_at_word_boundaries_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;anonymise_codes_at_word_boundaries_only&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_dates_at_word_boundaries_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;anonymise_dates_at_word_boundaries_only&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_numbers_at_word_boundaries_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;anonymise_numbers_at_word_boundaries_only&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_numbers_at_numeric_boundaries_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;anonymise_numbers_at_numeric_boundaries_only&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_strings_at_word_boundaries_only</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;anonymise_strings_at_word_boundaries_only&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_string_suffixes</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;scrub_string_suffixes&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitelist_filenames</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;whitelist_filenames&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_filenames</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;blacklist_filenames&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrub_all_numbers_of_n_digits</span> <span class="o">=</span> <span class="n">opt_multiline_int</span><span class="p">(</span>
            <span class="s1">&#39;scrub_all_numbers_of_n_digits&#39;</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_case_sensitive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span><span class="p">]</span>

        <span class="c1"># Whitelist, blacklist, nonspecific scrubber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="n">WordList</span><span class="p">(</span>
            <span class="n">filenames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">whitelist_filenames</span><span class="p">,</span>
            <span class="n">hasher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">change_detection_hasher</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span> <span class="o">=</span> <span class="n">WordList</span><span class="p">(</span>
            <span class="n">filenames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blacklist_filenames</span><span class="p">,</span>
            <span class="n">replacement_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replace_nonspecific_info_with</span><span class="p">,</span>
            <span class="n">hasher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">change_detection_hasher</span><span class="p">,</span>
            <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_strings_at_word_boundaries_only</span><span class="p">),</span>
            <span class="n">max_errors</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonspecific_scrubber</span> <span class="o">=</span> <span class="n">NonspecificScrubber</span><span class="p">(</span>
            <span class="n">replacement_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replace_nonspecific_info_with</span><span class="p">,</span>
            <span class="n">hasher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">change_detection_hasher</span><span class="p">,</span>
            <span class="n">anonymise_codes_at_word_boundaries_only</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_codes_at_word_boundaries_only</span><span class="p">),</span>
            <span class="n">anonymise_numbers_at_word_boundaries_only</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anonymise_numbers_at_word_boundaries_only</span><span class="p">),</span>
            <span class="n">blacklist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">,</span>
            <span class="n">scrub_all_numbers_of_n_digits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_all_numbers_of_n_digits</span><span class="p">,</span>
            <span class="n">scrub_all_uk_postcodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scrub_all_uk_postcodes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Output fields and formatting</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">research_id_fieldname</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;research_id_fieldname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trid_fieldname</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;trid_fieldname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_research_id_fieldname</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span>
            <span class="s1">&#39;master_research_id_fieldname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_hash_fieldname</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;source_hash_fieldname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_to_text_format</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;date_to_text_format&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime_to_text_format</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;datetime_to_text_format&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_source_info_to_comment</span> <span class="o">=</span> <span class="n">opt_bool</span><span class="p">(</span>
            <span class="s1">&#39;append_source_info_to_comment&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Destination database configuration</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_rows_before_commit</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;max_rows_before_commit&#39;</span><span class="p">,</span>
                                              <span class="n">DEFAULT_MAX_ROWS_BEFORE_COMMIT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_bytes_before_commit</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;max_bytes_before_commit&#39;</span><span class="p">,</span>
                                               <span class="n">DEFAULT_MAX_BYTES_BEFORE_COMMIT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_tablename</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;temporary_tablename&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Databases</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="n">destination_database_cfg_section</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;destination_database&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destination_database_url</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_str</span><span class="p">(</span>
            <span class="n">destination_database_cfg_section</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">admin_database_cfg_section</span> <span class="o">=</span> <span class="n">opt_str</span><span class="p">(</span><span class="s1">&#39;admin_database&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">destination_database_cfg_section</span> <span class="o">==</span> <span class="n">admin_database_cfg_section</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Destination and admin databases mustn&#39;t be the same&quot;</span><span class="p">)</span>
        <span class="n">source_database_cfg_sections</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;source_databases&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_db_names</span> <span class="o">=</span> <span class="n">source_database_cfg_sections</span>
        <span class="k">if</span> <span class="n">destination_database_cfg_section</span> <span class="ow">in</span> <span class="n">source_database_cfg_sections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Destination database mustn&#39;t be listed as a &quot;</span>
                             <span class="s2">&quot;source database&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">admin_database_cfg_section</span> <span class="ow">in</span> <span class="n">source_database_cfg_sections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Admin database mustn&#39;t be listed as a &quot;</span>
                             <span class="s2">&quot;source database&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">destdb</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">(</span><span class="n">destination_database_cfg_section</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="n">destination_database_cfg_section</span><span class="p">,</span>
                                   <span class="n">with_session</span><span class="o">=</span><span class="n">open_databases</span><span class="p">,</span>
                                   <span class="n">with_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">reflect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">destdb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Destination database misconfigured&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">open_databases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># in context of web framework, some sort of default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dest_dialect</span> <span class="o">=</span> <span class="n">mysql_dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destdb_transaction_limiter</span> <span class="o">=</span> <span class="n">TransactionSizeLimiter</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">max_bytes_before_commit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_bytes_before_commit</span><span class="p">,</span>
            <span class="n">max_rows_before_commit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_rows_before_commit</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">admindb</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">(</span><span class="n">admin_database_cfg_section</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">admin_database_cfg_section</span><span class="p">,</span>
                                    <span class="n">with_session</span><span class="o">=</span><span class="n">open_databases</span><span class="p">,</span>
                                    <span class="n">with_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">reflect</span><span class="o">=</span><span class="n">open_databases</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admindb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Admin database misconfigured&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_dialects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sourcedb_name</span> <span class="ow">in</span> <span class="n">source_database_cfg_sections</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding source database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sourcedb_name</span><span class="p">))</span>
            <span class="n">srccfg</span> <span class="o">=</span> <span class="n">DatabaseSafeConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">sourcedb_name</span><span class="p">)</span>
            <span class="n">srcdb</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">(</span><span class="n">sourcedb_name</span><span class="p">,</span>
                                 <span class="n">srccfg_</span><span class="o">=</span><span class="n">srccfg</span><span class="p">,</span>
                                 <span class="n">name</span><span class="o">=</span><span class="n">sourcedb_name</span><span class="p">,</span>
                                 <span class="n">with_session</span><span class="o">=</span><span class="n">open_databases</span><span class="p">,</span>
                                 <span class="n">with_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">reflect</span><span class="o">=</span><span class="n">open_databases</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">srcdb</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source database </span><span class="si">{}</span><span class="s2"> misconfigured&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sourcedb_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">sourcedb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcdb</span>
            <span class="k">if</span> <span class="n">open_databases</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src_dialects</span><span class="p">[</span><span class="n">sourcedb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcdb</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># in context of web framework</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src_dialects</span><span class="p">[</span><span class="n">sourcedb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mssql_dialect</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Processing options</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_max_n_patients</span> <span class="o">=</span> <span class="n">opt_int</span><span class="p">(</span><span class="s1">&#39;debug_max_n_patients&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_pid_list</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;debug_pid_list&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Opting out entirely</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optout_pid_filenames</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;optout_pid_filenames&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optout_mpid_filenames</span> <span class="o">=</span> <span class="n">opt_multiline</span><span class="p">(</span><span class="s1">&#39;optout_mpid_filenames&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optout_col_values</span> <span class="o">=</span> <span class="n">opt_pyvalue_list</span><span class="p">(</span><span class="s1">&#39;optout_col_values&#39;</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Rest of initialization</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">DataDictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rows_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows_inserted_per_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warned_re_limits</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report_every_n_rows</span> <span class="o">=</span> <span class="n">DEFAULT_REPORT_EVERY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">DEFAULT_CHUNKSIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_scrubbers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_scrubbers</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dest_bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_destdb_engine_outside_transaction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Engine</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination_database_url</span>
        <span class="k">return</span> <span class="n">create_engine</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">echo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">,</span>
            <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;autocommit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>  <span class="c1"># for pyodbc</span>
        <span class="c1"># https://github.com/mkleehammer/pyodbc/wiki/Database-Transaction-Management  # noqa</span>

    <span class="k">def</span> <span class="nf">overall_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> read, </span><span class="si">{}</span><span class="s2"> written&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sizeof_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_bytes_read</span><span class="p">),</span>
            <span class="n">sizeof_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dest_bytes_written</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">load_dd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_against_source_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">SEP</span> <span class="o">+</span> <span class="s2">&quot;Loading data dictionary: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dictionary_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">read_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dictionary_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">check_valid</span><span class="p">(</span>
            <span class="n">prohibited_fieldnames</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">trid_fieldname</span><span class="p">],</span>
            <span class="n">check_against_source_db</span><span class="o">=</span><span class="n">check_against_source_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_row_counts</span><span class="p">()</span>

<div class="viewcode-block" id="Config.init_row_counts"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config.init_row_counts">[docs]</a>    <span class="k">def</span> <span class="nf">init_row_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize row counts for all source tables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows_inserted_per_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">db_table_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_src_db_tablepairs</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows_inserted_per_table</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warned_re_limits</span><span class="p">[</span><span class="n">db_table_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Config.check_valid"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config.check_valid">[docs]</a>    <span class="k">def</span> <span class="nf">check_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raise exception if config is invalid.&quot;&quot;&quot;</span>

        <span class="c1"># Destination databases</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">destdb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No destination database specified.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">admindb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No admin database specified.&quot;</span><span class="p">)</span>

        <span class="c1"># Test table names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No temporary_tablename specified.&quot;</span><span class="p">)</span>
        <span class="n">ensure_valid_table_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_tablename</span><span class="p">)</span>

        <span class="c1"># Test field names</span>
        <span class="k">def</span> <span class="nf">validate_fieldattr</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Blank fieldname: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="n">specialfieldlist</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;research_id_fieldname&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trid_fieldname&quot;</span><span class="p">,</span>
            <span class="s2">&quot;master_research_id_fieldname&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source_hash_fieldname&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">fieldset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">specialfieldlist</span><span class="p">:</span>
            <span class="n">validate_fieldattr</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
            <span class="n">fieldset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldset</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specialfieldlist</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Config: these must all be DIFFERENT fieldnames: &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">specialfieldlist</span><span class="p">))</span>

        <span class="c1"># Test strings</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_patient_info_with</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Blank replace_patient_info_with&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_third_party_info_with</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Blank replace_third_party_info_with&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_nonspecific_info_with</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Blank replace_nonspecific_info_with&quot;</span><span class="p">)</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">replace_patient_info_with</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">replace_third_party_info_with</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">replace_nonspecific_info_with</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replacements</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Inadvisable: replace_patient_info_with, &quot;</span>
                <span class="s2">&quot;replace_third_party_info_with, and &quot;</span>
                <span class="s2">&quot;replace_nonspecific_info_with should all be distinct&quot;</span><span class="p">)</span>

        <span class="c1"># Regex</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_max_regex_errors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;string_max_regex_errors &lt; 0, nonsensical&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_string_length_for_errors</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min_string_length_for_errors &lt; 1, nonsensical&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_string_length_to_scrub_with</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;min_string_length_to_scrub_with &lt; 1, nonsensical&quot;</span><span class="p">)</span>

        <span class="c1"># Source databases</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No source databases specified.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">srccfg</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_allow_no_patient_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Missing ddgen_per_table_pid_field in config for &quot;</span>
                        <span class="s2">&quot;database </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>
                <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_per_table_pid_field</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_hash_fieldname</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Config: ddgen_per_table_pid_field can&#39;t &quot;</span>
                                     <span class="s2">&quot;be the same as source_hash_fieldname&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">:</span>
                <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">ddgen_master_pid_fieldname</span><span class="p">)</span>

        <span class="c1"># OK!</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Config validated.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.encrypt_primary_pid"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config.encrypt_primary_pid">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt_primary_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Encrypt a primary PID, producing a RID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this is very unlikely!</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trying to hash NULL PID!&quot;</span><span class="p">)</span>
            <span class="c1"># ... see encrypt_master_pid() below</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_pid_hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.encrypt_master_pid"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config.encrypt_master_pid">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt_master_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Encrypt a master PID, producing a master RID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mpid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># potentially: risk of revealing the hash</span>
            <span class="c1"># and DEFINITELY: two patients, both with no NHS number, must not</span>
            <span class="c1"># be equated on the hash (e.g. hash(None) -&gt; hash(&quot;None&quot;) -&gt; ...)!</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_pid_hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">mpid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.hash_object"><a class="viewcode-back" href="../../../autodoc/anonymise/config.html#crate_anon.anonymise.config.Config.hash_object">[docs]</a>    <span class="k">def</span> <span class="nf">hash_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hashes a list with Python&#39;s built-in hash function.</span>

<span class="sd">        We could use Python&#39;s build-in hash() function, which produces a 64-bit</span>
<span class="sd">        unsigned integer (calculated from: sys.maxint).</span>
<span class="sd">        However, there is an outside chance that someone uses a single-field</span>
<span class="sd">        table and therefore that this is vulnerable to content discovery via a</span>
<span class="sd">        dictionary attack. Thus, we should use a better version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_detection_hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">get_extra_hasher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hasher_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericHasher</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hasher_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_hashers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Extra hasher </span><span class="si">{}</span><span class="s2"> requested but doesn&#39;t exist; check you have &quot;</span>
                <span class="s2">&quot;listed it in &#39;extra_hash_config_sections&#39; in the config &quot;</span>
                <span class="s2">&quot;file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hasher_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_hashers</span><span class="p">[</span><span class="n">hasher_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_source_db_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_db_names</span>

    <span class="k">def</span> <span class="nf">set_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">echo</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admindb</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destdb</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="c1"># Now, SQLAlchemy will mess things up by adding an additional handler.</span>
        <span class="c1"># So, bye-bye:</span>
        <span class="k">for</span> <span class="n">logname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sqlalchemy.engine.base.Engine&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sqlalchemy.engine.base.OptionEngine&#39;</span><span class="p">):</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logname</span><span class="p">)</span>
            <span class="c1"># log.critical(logger.__dict__)</span>
            <span class="n">remove_all_logger_handlers</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_src_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_db</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_dialects</span><span class="p">[</span><span class="n">src_db</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_dest_dialect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_dialect</span>

    <span class="k">def</span> <span class="nf">commit_dest_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destdb_transaction_limiter</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">notify_src_bytes_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_bytes_read</span> <span class="o">+=</span> <span class="n">n_bytes</span>

    <span class="k">def</span> <span class="nf">notify_dest_db_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destdb_transaction_limiter</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">n_rows</span><span class="o">=</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="n">n_bytes</span><span class="p">)</span>
        <span class="c1"># ... may trigger a commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dest_bytes_written</span> <span class="o">+=</span> <span class="n">n_bytes</span>

    <span class="k">def</span> <span class="nf">extract_text_extension_permissible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_case_sensitive</span><span class="p">:</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">extension</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_permitted</span>
        <span class="k">return</span> <span class="n">extension</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_extensions_prohibited</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>