
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Task Object &#8212; Grab 0.6 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Task Queue" href="task_queue.html" />
    <link rel="prev" title="What is Grab::Spider?" href="intro.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="task_queue.html" title="Task Queue"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="What is Grab::Spider?"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Grab 0.6 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="task-object">
<span id="spider-task"></span><h1>Task Object<a class="headerlink" href="#task-object" title="Permalink to this headline">¶</a></h1>
<p>Any Grab::Spider crawler is a set of handlers that process network responses.
Each handler can spawn new network requests or just process/save data.
The spider add each new request to task queue and process this task when there
is free network stream. Each task is assigned a name that defines its type.
Each type of task are handles by specific handler. To find the handler the
Spider takes name of the task and then looks for <cite>task_&lt;name&gt;</cite> method.</p>
<p>For example, to handle result of task named “contact_page” we need to define
“task_contact_page” method:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="s1">&#39;contact_page&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://domain.com/contact.html&#39;</span><span class="p">))</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">task_contact_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="section" id="constructor-of-task-class">
<h2>Constructor of Task Class<a class="headerlink" href="#constructor-of-task-class" title="Permalink to this headline">¶</a></h2>
<p>Constructor of Task Class accepts multiple arguments. At least you have to
specify URL of requested document OR the configured Grab object. Next, you
see examples of different task creation. All three examples do the same:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Using `url` argument</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">url</span> <span class="s1">&#39;http://wikipedia.org/&#39;</span><span class="p">)</span>

<span class="c1"># Using Grab intance</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Grab</span><span class="p">()</span>
<span class="n">g</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://wikipedia.org/&#39;</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">grab</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>

<span class="c1"># Using configured state of Grab instance</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Grab</span><span class="p">()</span>
<span class="n">g</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://wikipedia.org/&#39;</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dump_config</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">grab_config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>Also you can specify these arguments:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">priority:</th><td class="field-body">приоритет задания, целое положительное число, чем меньше число, тем выше приоритет.</td>
</tr>
<tr class="field-even field"><th class="field-name">disable_cache:</th><td class="field-body">не использовать кэш паука для этого запроса, сетевой ответ в кэш сохранён не будет</td>
</tr>
<tr class="field-odd field"><th class="field-name">refresh_cache:</th><td class="field-body">не использовать кэш паука, в случае удачного ответа обновить запись в кэше</td>
</tr>
<tr class="field-even field"><th class="field-name">valid_status:</th><td class="field-body">обрабатывать обычным способом указанные статусы. По умолчанию обрабатываются все статусы 2xx, а также статус 404.</td>
</tr>
<tr class="field-odd field"><th class="field-name">use_proxylist:</th><td class="field-body">использовать заданный глобально для паука список прокси. По умолчанию  опция включена.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="task-object-as-data-storage">
<h2>Task Object as Data Storage<a class="headerlink" href="#task-object-as-data-storage" title="Permalink to this headline">¶</a></h2>
<p>If you pass the argument that is unknown then it will be saved in the Task
object. That allows you to pass data between network request/response.</p>
<p>There is <cite>get</cite> method that return value of task attribute or <cite>None</cite> if that
attribute have not been defined.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;bing&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://bing.com/&#39;</span><span class="p">,</span> <span class="n">disable_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># == &quot;bar&quot;</span>
<span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="c1"># == &quot;bar&quot;</span>
<span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asdf&#39;</span><span class="p">)</span> <span class="c1"># == None</span>
<span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asdf&#39;</span><span class="p">,</span> <span class="s1">&#39;qwerty&#39;</span><span class="p">)</span> <span class="c1"># == &quot;qwerty&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="cloning-task-object">
<h2>Cloning Task Object<a class="headerlink" href="#cloning-task-object" title="Permalink to this headline">¶</a></h2>
<p>Sometimes it is useful to create copy of Task object. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># task.clone()</span>
<span class="c1"># TODO: example</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-initial-tasks">
<h2>Setting Up Initial Tasks<a class="headerlink" href="#setting-up-initial-tasks" title="Permalink to this headline">¶</a></h2>
<p>When you call <cite>run</cite> method of your spider it starts working from initial tasks.
There are few ways to setup initial tasks.</p>
<div class="section" id="initial-urls">
<span id="spider-task-initial-urls"></span><h3>initial_urls<a class="headerlink" href="#initial-urls" title="Permalink to this headline">¶</a></h3>
<p>You can specify list of URLs in <cite>self.initial_urls</cite>. For each URl in this list
the spider will create Task object with name “initial”:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExampleSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">initial_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://google.com/&#39;</span><span class="p">,</span> <span class="s1">&#39;http://yahoo.com/&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="task-generator">
<span id="spider-task-generator"></span><h3>task_generator<a class="headerlink" href="#task-generator" title="Permalink to this headline">¶</a></h3>
<p>More flexible way to define initial tasks is to use <cite>task_generator</cite> method.
Its interface is simple, you just have to yield new Task objects.</p>
<p>There is common use case when you need to process big number of URLs from the
file. With <cite>task_generator</cite> you can iterate over lines of the file and yield
new tasks. That will save memory used by the script because you will not read
whole file into the memory. Spider consumes only portion of tasks from
<cite>task_generator</cite>. When there are free networks resources the spiders consumes
next portion of task. And so on.</p>
<p>Example:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExampleSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">task_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;var/urls.txt&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="explicit-ways-to-add-new-task">
<h2>Explicit Ways to Add New Task<a class="headerlink" href="#explicit-ways-to-add-new-task" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adding-tasks-with-add-task-method">
<h3>Adding Tasks With add_task method<a class="headerlink" href="#adding-tasks-with-add-task-method" title="Permalink to this headline">¶</a></h3>
<p>You can use <cite>add_task</cite> method anywhere, even before the spider have started working:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">bot</span> <span class="o">=</span> <span class="n">ExampleSpider</span><span class="p">()</span>
<span class="n">bot</span><span class="o">.</span><span class="n">setup_queue</span><span class="p">()</span>
<span class="n">bot</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://google.com&#39;</span><span class="p">)</span>
<span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="yield-new-tasks">
<h3>Yield New Tasks<a class="headerlink" href="#yield-new-tasks" title="Permalink to this headline">¶</a></h3>
<p>You can use yield statement to add new tasks in two places. First, in
<a class="reference internal" href="#spider-task-generator"><span class="std std-ref">task_generator</span></a>. Second, in any handler. Using yield is
completely equal to using <cite>add_task</cite> method. The yielding is just a bit
more beautiful:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExampleSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">initial_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://google.com&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">task_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="c1"># Google page was fetched</span>
        <span class="c1"># Now let&#39;s download yahoo page</span>
        <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;yahoo&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;yahoo.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">task_yahoo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="default-grab-instance">
<span id="spider-default-grab-instance"></span><h2>Default Grab Instance<a class="headerlink" href="#default-grab-instance" title="Permalink to this headline">¶</a></h2>
<p>You can control the default config of Grab instances used in spider tasks.
Define the <cite>create_grab_instance</cite> method in your spider class:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_grab_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TestSpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create_grab_instance</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span>
</pre></div>
</div>
<p>Be aware, that this method allows you to control only those Grab instances
that were created automatically. If you create task with explicit grab instance
it will not be affected by <cite>create_grab_instance_method</cite>:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_grab_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Grab</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">task_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Grab</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://example.com&#39;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="n">grab</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
        <span class="c1"># The grab instance in the yielded task</span>
        <span class="c1"># will not be affected by `create_grab_instance` method.</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-any-grab-instance">
<span id="spider-updating-any-grab-instance"></span><h2>Updating Any Grab Instance<a class="headerlink" href="#updating-any-grab-instance" title="Permalink to this headline">¶</a></h2>
<p>With method <cite>update_grab_instance</cite> you can update any Grab instance, even those
instances that you have passed explicitly to the Task object. Be aware, that
any option configured in this method overwrites the previously configured
option.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_grab_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">):</span>
        <span class="n">grab</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">task_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Grab</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://example.com&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="n">grab</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
        <span class="c1"># The effective timeout setting will be equal to 20!</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Task Object</a><ul>
<li><a class="reference internal" href="#constructor-of-task-class">Constructor of Task Class</a></li>
<li><a class="reference internal" href="#task-object-as-data-storage">Task Object as Data Storage</a></li>
<li><a class="reference internal" href="#cloning-task-object">Cloning Task Object</a></li>
<li><a class="reference internal" href="#setting-up-initial-tasks">Setting Up Initial Tasks</a><ul>
<li><a class="reference internal" href="#initial-urls">initial_urls</a></li>
<li><a class="reference internal" href="#task-generator">task_generator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#explicit-ways-to-add-new-task">Explicit Ways to Add New Task</a><ul>
<li><a class="reference internal" href="#adding-tasks-with-add-task-method">Adding Tasks With add_task method</a></li>
<li><a class="reference internal" href="#yield-new-tasks">Yield New Tasks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#default-grab-instance">Default Grab Instance</a></li>
<li><a class="reference internal" href="#updating-any-grab-instance">Updating Any Grab Instance</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">What is Grab::Spider?</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="task_queue.html"
                        title="next chapter">Task Queue</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/spider/task.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="task_queue.html" title="Task Queue"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="What is Grab::Spider?"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Grab 0.6 documentation</a> &#187;</li> 
      </ul>
    </div>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Gregory Petukhov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
    <p style="margin-top: 0; text-align: center; font-size: 0.8em;">Developed by <a href="http://grablab.io">GrabLab</a> - web scraping and data mining services.</p>
    <p style="margin-top: 0; text-align: center; font-size: 0.8em;">He also does web scraping: <a href="https://www.imscraping.ninja">www.imscraping.ninja</a>.</p>

    <!-- Yandex.Metrika counter --> <script type="text/javascript" > (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter13841917 = new Ya.Metrika({ id:13841917, clickmap:true, trackLinks:true, accurateTrackBounce:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div><img src="https://mc.yandex.ru/watch/13841917" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->


  </body>
</html>