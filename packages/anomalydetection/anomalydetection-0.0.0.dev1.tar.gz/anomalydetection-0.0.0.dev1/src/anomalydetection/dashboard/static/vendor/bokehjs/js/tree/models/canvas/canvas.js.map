{"version":3,"sources":["models/canvas/canvas.ts"],"names":[],"mappings":"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","file":"canvas.js","sourcesContent":["import {LayoutCanvas} from \"core/layout/layout_canvas\"\nimport {DOMView} from \"core/dom_view\"\nimport {EQ, Constraint} from \"core/layout/solver\"\nimport {logger} from \"core/logging\"\nimport * as p from \"core/properties\"\nimport {div, canvas} from \"core/dom\"\nimport {OutputBackend} from \"core/enums\"\nimport {Context2d, fixup_ctx, get_scale_ratio} from \"core/util/canvas\"\n\nconst canvas2svg = require(\"canvas2svg\") // XXX: no typings\n\n// fixes up a problem with some versions of IE11\n// ref: http://stackoverflow.com/questions/22062313/imagedata-set-in-internetexplorer\nif ((window as any).CanvasPixelArray != null) {\n  (window as any).CanvasPixelArray.prototype.set = function(this: any, arr: any[]): void {\n    for (let i = 0; i < this.length; i++) {\n      this[i] = arr[i]\n    }\n  }\n}\n\nexport class CanvasView extends DOMView {\n  model: Canvas\n\n  private _ctx: any\n  ctx: Context2d\n\n  canvas_el: HTMLCanvasElement\n\n  overlays_el: HTMLElement\n  events_el: HTMLElement\n  map_el: HTMLElement | null\n\n  protected _width_constraint: Constraint | undefined\n  protected _height_constraint: Constraint | undefined\n\n  initialize(options: any): void {\n    super.initialize(options)\n\n    this.map_el = this.model.map ? this.el.appendChild(div({class: \"bk-canvas-map\"})) : null\n\n    switch (this.model.output_backend) {\n      case \"canvas\":\n      case \"webgl\":\n        this.canvas_el = this.el.appendChild(canvas({class: \"bk-canvas\"}))\n        this._ctx = this.canvas_el.getContext('2d')\n        break\n      case \"svg\":\n        this._ctx = new canvas2svg()\n        this.canvas_el = this.el.appendChild(this._ctx.getSvg())\n        break\n    }\n\n    this.overlays_el = this.el.appendChild(div({class: \"bk-canvas-overlays\"}))\n    this.events_el   = this.el.appendChild(div({class: \"bk-canvas-events\"}))\n\n    this.ctx = this.get_ctx()\n    // work around canvas incompatibilities\n    fixup_ctx(this.ctx)\n\n    logger.debug(\"CanvasView initialized\")\n  }\n\n  css_classes(): string[] {\n    return super.css_classes().concat(\"bk-canvas-wrapper\")\n  }\n\n  // Method exists so that context can be stubbed in unit tests\n  get_ctx(): Context2d {\n    return this._ctx\n  }\n\n  get_canvas_element(): HTMLCanvasElement {\n    return this.canvas_el\n  }\n\n  prepare_canvas(): void {\n    // Ensure canvas has the correct size, taking HIDPI into account\n    const width = this.model._width.value\n    const height = this.model._height.value\n\n    this.el.style.width = `${width}px`\n    this.el.style.height = `${height}px`\n\n    const pixel_ratio = get_scale_ratio(this.ctx, this.model.use_hidpi, this.model.output_backend)\n    this.model.pixel_ratio = pixel_ratio\n\n    this.canvas_el.style.width = `${width}px`\n    this.canvas_el.style.height = `${height}px`\n\n    // XXX: io.export and canvas2svg don't like this\n    // this.canvas_el.width = width*pixel_ratio\n    // this.canvas_el.height = height*pixel_ratio\n    this.canvas_el.setAttribute(\"width\", `${width*pixel_ratio}`)\n    this.canvas_el.setAttribute(\"height\", `${height*pixel_ratio}`)\n\n    logger.debug(`Rendering CanvasView with width: ${width}, height: ${height}, pixel ratio: ${pixel_ratio}`)\n  }\n\n  set_dims([width, height]: [number, number]): void {\n    // XXX: for whatever reason we need to protect against those nonsense values,\n    //      that appear in the middle of updating layout. Otherwise we would get\n    //      all possible errors from the layout solver.\n    if (width == 0 || height == 0)\n      return\n\n    if (width != this.model._width.value) {\n      if (this._width_constraint != null && this.solver.has_constraint(this._width_constraint))\n        this.solver.remove_constraint(this._width_constraint)\n\n      this._width_constraint = EQ(this.model._width, -width)\n      this.solver.add_constraint(this._width_constraint)\n    }\n\n    if (height != this.model._height.value) {\n      if (this._height_constraint != null && this.solver.has_constraint(this._height_constraint))\n        this.solver.remove_constraint(this._height_constraint)\n\n      this._height_constraint = EQ(this.model._height, -height)\n      this.solver.add_constraint(this._height_constraint)\n    }\n\n    this.solver.update_variables()\n  }\n}\n\nexport namespace Canvas {\n  export interface Attrs extends LayoutCanvas.Attrs {\n    map: boolean\n    use_hidpi: boolean\n    pixel_ratio: number\n    output_backend: OutputBackend\n  }\n\n  export interface Props extends LayoutCanvas.Props {}\n}\n\nexport interface Canvas extends Canvas.Attrs {}\n\nexport class Canvas extends LayoutCanvas {\n\n  properties: Canvas.Props\n\n  constructor(attrs?: Partial<Canvas.Attrs>) {\n    super(attrs)\n  }\n\n  static initClass(): void {\n    this.prototype.type = \"Canvas\"\n    this.prototype.default_view = CanvasView\n\n    this.internal({\n      map:            [ p.Boolean,       false    ],\n      use_hidpi:      [ p.Boolean,       true     ],\n      pixel_ratio:    [ p.Number,        1        ],\n      output_backend: [ p.OutputBackend, \"canvas\" ],\n    })\n  }\n\n  get panel(): LayoutCanvas {\n    return this\n  }\n}\nCanvas.initClass()\n"]}