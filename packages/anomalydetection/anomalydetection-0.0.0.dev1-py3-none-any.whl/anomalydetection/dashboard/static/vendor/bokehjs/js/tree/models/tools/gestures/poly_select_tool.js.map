{"version":3,"sources":["models/tools/gestures/poly_select_tool.ts"],"names":[],"mappings":"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","file":"poly_select_tool.js","sourcesContent":["import {SelectTool, SelectToolView} from \"./select_tool\"\nimport {PolyAnnotation} from \"../../annotations/poly_annotation\"\nimport {PolyGeometry} from \"core/geometry\"\nimport {TapEvent, KeyEvent} from \"core/ui_events\"\nimport {Keys} from \"core/dom\"\nimport * as p from \"core/properties\"\nimport {copy} from \"core/util/array\"\nimport {extend} from \"core/util/object\"\n\nexport class PolySelectToolView extends SelectToolView {\n  model: PolySelectTool\n\n  protected data: {sx: number[], sy: number[]}\n\n  initialize(options: any): void {\n    super.initialize(options)\n    this.data = {sx: [], sy: []}\n  }\n\n  connect_signals(): void {\n    super.connect_signals()\n    this.connect(this.model.properties.active.change, () => this._active_change())\n  }\n\n  _active_change(): void {\n    if (!this.model.active)\n      this._clear_data()\n  }\n\n  _keyup(ev: KeyEvent): void {\n    if (ev.keyCode == Keys.Enter)\n      this._clear_data()\n  }\n\n  _doubletap(ev: TapEvent): void {\n    const append = ev.shiftKey\n    this._do_select(this.data.sx, this.data.sy, true, append)\n    this.plot_view.push_state('poly_select', {selection: this.plot_view.get_selection()})\n\n    this._clear_data()\n  }\n\n  _clear_data(): void {\n    this.data = {sx: [], sy: []}\n    this.model.overlay.update({xs: [], ys: []})\n  }\n\n  _tap(ev: TapEvent): void {\n    const {sx, sy} = ev\n\n    const frame = this.plot_model.frame\n    if (!frame.bbox.contains(sx, sy))\n      return\n\n    this.data.sx.push(sx)\n    this.data.sy.push(sy)\n\n    this.model.overlay.update({xs: copy(this.data.sx), ys: copy(this.data.sy)})\n  }\n\n  _do_select(sx: number[], sy: number[], final: boolean, append: boolean): void {\n    const geometry: PolyGeometry = {\n      type: 'poly',\n      sx: sx,\n      sy: sy,\n    }\n    this._select(geometry, final, append)\n  }\n\n  _emit_callback(geometry: PolyGeometry): void {\n    const r = this.computed_renderers[0]\n    const frame = this.plot_model.frame\n\n    const xscale = frame.xscales[r.x_range_name]\n    const yscale = frame.yscales[r.y_range_name]\n\n    const x = xscale.v_invert(geometry.sx)\n    const y = yscale.v_invert(geometry.sy)\n\n    const g = extend({x, y}, geometry)\n    this.model.callback.execute(this.model, {geometry: g})\n  }\n}\n\nconst DEFAULT_POLY_OVERLAY = () => {\n  return new PolyAnnotation({\n    level: \"overlay\",\n    xs_units: \"screen\",\n    ys_units: \"screen\",\n    fill_color: {value: \"lightgrey\"},\n    fill_alpha: {value: 0.5},\n    line_color: {value: \"black\"},\n    line_alpha: {value: 1.0},\n    line_width: {value: 2},\n    line_dash: {value: [4, 4]},\n  })\n}\n\nexport namespace PolySelectTool {\n  export interface Attrs extends SelectTool.Attrs {\n    callback: any // XXX\n    overlay: PolyAnnotation\n  }\n\n  export interface Props extends SelectTool.Props {}\n}\n\nexport interface PolySelectTool extends PolySelectTool.Attrs {}\n\nexport class PolySelectTool extends SelectTool {\n\n  properties: PolySelectTool.Props\n\n  constructor(attrs?: Partial<PolySelectTool.Attrs>) {\n    super(attrs)\n  }\n\n  static initClass(): void {\n    this.prototype.type = \"PolySelectTool\"\n    this.prototype.default_view = PolySelectToolView\n\n    this.define({\n      callback:   [ p.Instance                       ],\n      overlay:    [ p.Instance, DEFAULT_POLY_OVERLAY ],\n    })\n  }\n\n  tool_name = \"Poly Select\"\n  icon = \"bk-tool-icon-polygon-select\"\n  event_type = \"tap\" as \"tap\"\n  default_order = 11\n}\n\nPolySelectTool.initClass()\n"]}